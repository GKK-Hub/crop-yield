<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exploratory Data Analysis on Rice Yield Dataset</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="eda_notebook_files/libs/clipboard/clipboard.min.js"></script>
<script src="eda_notebook_files/libs/quarto-html/quarto.js"></script>
<script src="eda_notebook_files/libs/quarto-html/popper.min.js"></script>
<script src="eda_notebook_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="eda_notebook_files/libs/quarto-html/anchor.min.js"></script>
<link href="eda_notebook_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="eda_notebook_files/libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="eda_notebook_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="eda_notebook_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="eda_notebook_files/libs/bootstrap/bootstrap-ddb3fb479c87e28f33ddcd4932113dd5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<meta name="shiny-dependency-placeholder" content="">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&amp;display=swap" rel="stylesheet">
<style>
  code, pre {
    font-family: 'JetBrains Mono', monospace !important;
  }
</style>
<meta charset="UTF-8">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#chapter-1-data-import" id="toc-chapter-1-data-import" class="nav-link active" data-scroll-target="#chapter-1-data-import">Chapter 1: Data Import</a></li>
  <li><a href="#chapter-2-feature-engineering" id="toc-chapter-2-feature-engineering" class="nav-link" data-scroll-target="#chapter-2-feature-engineering">Chapter 2: Feature Engineering</a></li>
  <li><a href="#chapter-3-distribution-of-variables" id="toc-chapter-3-distribution-of-variables" class="nav-link" data-scroll-target="#chapter-3-distribution-of-variables">Chapter 3: Distribution of Variables</a></li>
  <li><a href="#chapter-4-correlation-analysis" id="toc-chapter-4-correlation-analysis" class="nav-link" data-scroll-target="#chapter-4-correlation-analysis">Chapter 4: Correlation Analysis</a></li>
  <li><a href="#chapter-5-split-data---train-and-test" id="toc-chapter-5-split-data---train-and-test" class="nav-link" data-scroll-target="#chapter-5-split-data---train-and-test">Chapter 5: Split Data - Train and Test</a>
  <ul class="collapse">
  <li><a href="#train-and-test-set" id="toc-train-and-test-set" class="nav-link" data-scroll-target="#train-and-test-set">Train and Test Set</a></li>
  <li><a href="#time-series-split" id="toc-time-series-split" class="nav-link" data-scroll-target="#time-series-split">Time-series Split</a></li>
  <li><a href="#checking-time-series-splits" id="toc-checking-time-series-splits" class="nav-link" data-scroll-target="#checking-time-series-splits">Checking Time-series Splits</a></li>
  </ul></li>
  <li><a href="#chapter-6-data-preprocessing" id="toc-chapter-6-data-preprocessing" class="nav-link" data-scroll-target="#chapter-6-data-preprocessing">Chapter 6: Data Preprocessing</a>
  <ul class="collapse">
  <li><a href="#preprocessor-pipeline" id="toc-preprocessor-pipeline" class="nav-link" data-scroll-target="#preprocessor-pipeline">Preprocessor Pipeline</a></li>
  </ul></li>
  <li><a href="#chapter-7-validation-curves" id="toc-chapter-7-validation-curves" class="nav-link" data-scroll-target="#chapter-7-validation-curves">Chapter 7: Validation Curves</a>
  <ul class="collapse">
  <li><a href="#baseline-model" id="toc-baseline-model" class="nav-link" data-scroll-target="#baseline-model">Baseline Model</a></li>
  </ul></li>
  <li><a href="#chapter-8-hyperparameter-optimization" id="toc-chapter-8-hyperparameter-optimization" class="nav-link" data-scroll-target="#chapter-8-hyperparameter-optimization">Chapter 8: Hyperparameter Optimization</a></li>
  <li><a href="#chapter-8a-hyperparameter-optimization-with-optuna" id="toc-chapter-8a-hyperparameter-optimization-with-optuna" class="nav-link" data-scroll-target="#chapter-8a-hyperparameter-optimization-with-optuna">Chapter 8a: Hyperparameter Optimization with Optuna</a></li>
  <li><a href="#chapter-8b-hyperoptimization-of-all-models-using-optuna" id="toc-chapter-8b-hyperoptimization-of-all-models-using-optuna" class="nav-link" data-scroll-target="#chapter-8b-hyperoptimization-of-all-models-using-optuna">Chapter 8b: Hyperoptimization of all models using Optuna</a>
  <ul class="collapse">
  <li><a href="#logging-dataset" id="toc-logging-dataset" class="nav-link" data-scroll-target="#logging-dataset">Logging Dataset</a></li>
  </ul></li>
  <li><a href="#chapter-8c-all-models" id="toc-chapter-8c-all-models" class="nav-link" data-scroll-target="#chapter-8c-all-models">Chapter 8c: All models</a></li>
  </ul>
</nav>
</div>
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Exploratory Data Analysis on Rice Yield Dataset</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<p>In this project, we are going to explore the cleaned dataset by visualizing attributes, imputing missing values, checking data types and so on.</p>
<hr>
<section id="chapter-1-data-import" class="level1">
<h1>Chapter 1: Data Import</h1>
<div id="b284c770" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"GIT_PYTHON_REFRESH"</span>] <span class="op">=</span> <span class="st">"quiet"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e320e895" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>random.seed(SEED)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>np.random.seed(SEED)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="317bf51f" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add src/ to Python path</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="bu">str</span>(Path.cwd().parent <span class="op">/</span> <span class="st">"src"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="66d9832c" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'..</span><span class="ch">\\</span><span class="st">data</span><span class="ch">\\</span><span class="st">combined_file</span><span class="ch">\\</span><span class="st">combined.csv'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># df.head()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="811ee772" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>Index(['year', 'dist_name', 'actual_evapotranspiration', 'rice_area_1000_ha',
       'rice_production_1000_tons', 'rice_yield_kg_per_ha',
       'rice_irrigated_area_1000_ha', 'maximum_temperature',
       'minimum_temperature', 'precipitation',
       'nitrogen_kharif_consumption_tons', 'nitrogen_rabi_consumption_tons',
       'phosphate_kharif_consumption_tons', 'phosphate_rabi_consumption_tons',
       'potash_kharif_consumption_tons', 'potash_rabi_consumption_tons',
       'total_kharif_consumption_tons', 'total_rabi_consumption_tons',
       'water_deficit'],
      dtype='object')</code></pre>
</div>
</div>
<div id="d47b9d0b" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(df.columns, columns<span class="op">=</span>[<span class="st">'Parameters / Columns'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Parameters / Columns</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>year</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>dist_name</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>actual_evapotranspiration</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>rice_area_1000_ha</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>rice_production_1000_tons</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>rice_yield_kg_per_ha</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>rice_irrigated_area_1000_ha</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>maximum_temperature</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>minimum_temperature</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>precipitation</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>nitrogen_kharif_consumption_tons</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>nitrogen_rabi_consumption_tons</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>phosphate_kharif_consumption_tons</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>phosphate_rabi_consumption_tons</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>potash_kharif_consumption_tons</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>potash_rabi_consumption_tons</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>total_kharif_consumption_tons</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>total_rabi_consumption_tons</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>water_deficit</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The target variable is <code>rice_yield_kg_per_ha</code>. Every other column is a feature that we’ll be using to predict the target.</p>
<div id="4ce6a8ee" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df.info()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are no <code>null</code> values in the dataset. The method <code>.info()</code> only counts <code>numpy.nan</code> as <code>null</code> values but not <code>-1</code>.</p>
<div id="67bb406c" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(df[<span class="st">'dist_name'</span>].unique(), columns<span class="op">=</span>[<span class="st">'Districts'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Districts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Coimbatore</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Cuddalore</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Dharmapuri</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Dindigul</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Erode</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Kancheepuram</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Kanyakumari</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Madurai</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Pudukkottai</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Ramananthapuram</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Salem</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Sivagangai</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Thanjavur</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>The Nilgiris</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Thirunelveli</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Thoothukudi</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>Tiruchirappalli</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>Tiruvannamalai</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Vellore</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>Virudhunagar</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>Nagapattinam</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>Villupuram</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>Karur</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>Perambular</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>Theni</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>Thiruvallur</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>Thiruvarur</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>Namakkal</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>Chennai</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>Krishnagiri</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>Ariyalur</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">31</td>
<td>Tiruppur</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="1ca866f9" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Renaming the column names for better readability</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>df.rename(columns<span class="op">=</span>{</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_area_1000_ha'</span>: <span class="st">'rice_area'</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_production_1000_tons'</span>: <span class="st">'rice_production'</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_yield_kg_per_ha'</span>: <span class="st">'rice_yield'</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_evapotranspiration_mm'</span>: <span class="st">'avg_act_evapotranspiration'</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_pot_evapotranspiration_mm'</span>: <span class="st">'avg_pot_evapotranspiration'</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_irrigated_area_1000_ha'</span>: <span class="st">'rice_irrigated_area'</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_precipitation_mm'</span>: <span class="st">'avg_precipitation'</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_water_deficit_mm'</span>: <span class="st">'avg_water_deficit'</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'nitrogen_kharif_consumption_tons'</span>: <span class="st">'nitrogen_kharif'</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'nitrogen_rabi_consumption_tons'</span>: <span class="st">'nitrogen_rabi'</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phosphate_kharif_consumption_tons'</span>: <span class="st">'phosphate_kharif'</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phosphate_rabi_consumption_tons'</span>: <span class="st">'phosphate_rabi'</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'potash_kharif_consumption_tons'</span>: <span class="st">'potash_kharif'</span>,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'potash_rabi_consumption_tons'</span>: <span class="st">'potash_rabi'</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'total_kharif_consumption_tons'</span>: <span class="st">'total_kharif'</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'total_rabi_consumption_tons'</span>: <span class="st">'total_rabi'</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                   },</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>          inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can observe that the column names have been changed and it is easy to read.</p>
<div id="9813539d" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df.drop(columns<span class="op">=</span>[<span class="st">'nitrogen_kharif'</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'nitrogen_rabi'</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'phosphate_kharif'</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'phosphate_rabi'</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'potash_kharif'</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'potash_rabi'</span>],</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="274866ae" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># df.columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a02d7ac1" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="125c55c2" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>n_years <span class="op">=</span> df[<span class="st">'year'</span>].nunique()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>min_year<span class="op">=</span> df[<span class="st">'year'</span>].<span class="bu">min</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>max_year <span class="op">=</span> df[<span class="st">'year'</span>].<span class="bu">max</span>()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The rice yield dataset has </span><span class="sc">{</span>n_years<span class="sc">}</span><span class="ss"> years' data with minimum year: </span><span class="sc">{</span>min_year<span class="sc">}</span><span class="ss"> and maximum year: </span><span class="sc">{</span>max_year<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The rice yield dataset has 26 years' data with minimum year: 1990 and maximum year: 2015</code></pre>
</div>
</div>
<div id="edaa624c" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>n_districts <span class="op">=</span> df[<span class="st">'dist_name'</span>].nunique()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'There are </span><span class="sc">{</span>n_districts<span class="sc">}</span><span class="ss"> unique districts in the dataset'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>There are 32 unique districts in the dataset</code></pre>
</div>
</div>
<div id="70b20f6e" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>district_data_count <span class="op">=</span> pd.DataFrame(df[<span class="st">'dist_name'</span>].value_counts())</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>district_data_count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">dist_name</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Coimbatore</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Cuddalore</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Dharmapuri</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Dindigul</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Erode</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Kancheepuram</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Kanyakumari</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Madurai</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Pudukkottai</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Ramananthapuram</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Salem</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Sivagangai</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Thanjavur</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">The Nilgiris</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Thirunelveli</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Thoothukudi</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Tiruchirappalli</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Tiruvannamalai</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Vellore</td>
<td>26</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Virudhunagar</td>
<td>26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Nagapattinam</td>
<td>24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Villupuram</td>
<td>22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Karur</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Perambular</td>
<td>20</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Theni</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Thiruvallur</td>
<td>20</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Thiruvarur</td>
<td>20</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Namakkal</td>
<td>19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Krishnagiri</td>
<td>13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Chennai</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Ariyalur</td>
<td>8</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Tiruppur</td>
<td>5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>More than half of the districts have data for all the 26 years. So, we are removing some districts that do not have enough data.</p>
<div id="ea692d57" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>low_data_districts <span class="op">=</span> district_data_count[district_data_count[<span class="st">'count'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>].index</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>low_data_districts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Index(['Karur', 'Perambular', 'Theni', 'Thiruvallur', 'Thiruvarur', 'Namakkal',
       'Krishnagiri', 'Chennai', 'Ariyalur', 'Tiruppur'],
      dtype='object', name='dist_name')</code></pre>
</div>
</div>
<div id="2ae6e46a" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>district_mask <span class="op">=</span> <span class="op">~</span>df[<span class="st">'dist_name'</span>].isin(low_data_districts)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>district_mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0       True
1       True
2       True
3       True
4       True
       ...  
716    False
717     True
718     True
719     True
720     True
Name: dist_name, Length: 721, dtype: bool</code></pre>
</div>
</div>
<div id="402fbf42" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="op">=</span> df[district_mask]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'dist_name'</span>].unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array(['Coimbatore', 'Cuddalore', 'Dharmapuri', 'Dindigul', 'Erode',
       'Kancheepuram', 'Kanyakumari', 'Madurai', 'Pudukkottai',
       'Ramananthapuram', 'Salem', 'Sivagangai', 'Thanjavur',
       'The Nilgiris', 'Thirunelveli', 'Thoothukudi', 'Tiruchirappalli',
       'Tiruvannamalai', 'Vellore', 'Virudhunagar', 'Nagapattinam',
       'Villupuram'], dtype=object)</code></pre>
</div>
</div>
<div id="40c91708" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>filtered_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 566 entries, 0 to 720
Data columns (total 13 columns):
 #   Column                     Non-Null Count  Dtype  
---  ------                     --------------  -----  
 0   year                       566 non-null    int64  
 1   dist_name                  566 non-null    object 
 2   actual_evapotranspiration  566 non-null    float64
 3   rice_area                  566 non-null    float64
 4   rice_production            566 non-null    float64
 5   rice_yield                 566 non-null    float64
 6   rice_irrigated_area        566 non-null    float64
 7   maximum_temperature        566 non-null    float64
 8   minimum_temperature        566 non-null    float64
 9   precipitation              566 non-null    float64
 10  total_kharif               566 non-null    float64
 11  total_rabi                 566 non-null    float64
 12  water_deficit              566 non-null    float64
dtypes: float64(11), int64(1), object(1)
memory usage: 61.9+ KB</code></pre>
</div>
</div>
<div id="f6c5fb62" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'year'</span>].nunique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>26</code></pre>
</div>
</div>
<hr>
</section>
<section id="chapter-2-feature-engineering" class="level1">
<h1>Chapter 2: Feature Engineering</h1>
<div id="d4d37091" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># The `year_rescale` feature contains values between 1 and 26 which corresponds to 1990 and 2015.</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'year_rescale'</span>] <span class="op">=</span> <span class="bu">abs</span>((filtered_df[<span class="st">'year'</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> filtered_df[<span class="st">'year'</span>])</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'year_rescale'</span>].<span class="bu">min</span>(), filtered_df[<span class="st">'year_rescale'</span>].<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>(np.int64(1), np.int64(26))</code></pre>
</div>
</div>
<hr>
</section>
<section id="chapter-3-distribution-of-variables" class="level1">
<h1>Chapter 3: Distribution of Variables</h1>
<div id="f8e5f0fa" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny.express <span class="im">import</span> <span class="bu">input</span>, render, ui</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> htmltools <span class="im">import</span> TagList, tags</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0b236c89" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dist_variables <span class="op">=</span> [<span class="st">'dist_name'</span>,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'actual_evapotranspiration'</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_area'</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_production'</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_yield'</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_irrigated_area'</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">'maximum_temperature'</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">'minimum_temperature'</span>, </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'precipitation'</span>,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">'water_deficit'</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_kharif'</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_rabi'</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>dist_remarks <span class="op">=</span> {</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dist_name"</span>: <span class="st">"Most of the districts have 26 years' data, except a few."</span>,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_evapotranspiration"</span>: <span class="st">"Almost normally distributed with no outliers or skewness."</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_area"</span>: <span class="st">"The data is approximately normal with right skew."</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_production"</span>: <span class="st">"The data is approximately normal with slight right skew."</span>,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_yield"</span>: <span class="st">'The `rice_yield` variable is approximately normal with left skew.'</span>,</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_irrigated_area"</span>: <span class="st">"The data is approximately normal with right skew."</span>,</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maximum_temperature"</span>: <span class="st">"Distribution is bi-modal"</span>,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minimum_temperature"</span>: <span class="st">"Distribution is bi-modal."</span>,</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precipitation"</span>: <span class="st">"The data is approximately normal with slight right skew."</span>,      </span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"water_deficit"</span>: <span class="st">"Almost normally distributed with no outliers or skewness."</span>,</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_kharif"</span>: <span class="st">"Almost normally distributed"</span>,</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_rabi"</span>: <span class="st">"Almost normally distributed"</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f4733a14" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># UI elements</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>ui.input_select(<span class="st">"dist_var"</span>, <span class="st">"Choose Variable"</span>, choices<span class="op">=</span>dist_variables)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot output</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dist_plot():</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.dist_var()</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'dist_name'</span>:</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>      fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>      plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Axes 1: original distribution</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>      sns.distplot(filtered_df[col], ax<span class="op">=</span>ax[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>      ax[<span class="dv">0</span>].set_xlabel(col, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>      ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Axes 2: box plot of the original distribution</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>      sns.boxplot(filtered_df[col], ax<span class="op">=</span>ax[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>      ax[<span class="dv">1</span>].set_ylabel(col, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>      plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>      fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>      filtered_df[col].value_counts().plot(kind<span class="op">=</span><span class="st">'bar'</span>)<span class="op">;</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>      ax.set_ylim(<span class="dv">0</span>, <span class="dv">27</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>      ax.set_yticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">27</span>, <span class="dv">5</span>))</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>      ax.set_xlabel(<span class="st">''</span>) <span class="co"># Hide the x-axis label </span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>      ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>      ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>      ax.xaxis.grid(<span class="va">False</span>)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Remarks output</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dist_remarks_ui():</span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.dist_var()</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TagList(tags.p(<span class="st">"Remarks for "</span>, tags.code(col), <span class="st">": "</span>, tags.strong(dist_remarks.get(col))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display no-overflow-x" data-execution_count="24">
<div class="form-group shiny-input-container">
  <label class="control-label" id="dist_var-label" for="dist_var">Choose Variable</label>
  <div>
    <select class="shiny-input-select form-select" id="dist_var">      <option value="dist_name" selected="">dist_name</option>
      <option value="actual_evapotranspiration">actual_evapotranspiration</option>
      <option value="rice_area">rice_area</option>
      <option value="rice_production">rice_production</option>
      <option value="rice_yield">rice_yield</option>
      <option value="rice_irrigated_area">rice_irrigated_area</option>
      <option value="maximum_temperature">maximum_temperature</option>
      <option value="minimum_temperature">minimum_temperature</option>
      <option value="precipitation">precipitation</option>
      <option value="water_deficit">water_deficit</option>
      <option value="total_kharif">total_kharif</option>
      <option value="total_rabi">total_rabi</option></select>
  </div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="dist_plot" class="shiny-image-output html-fill-item shiny-plot-output" style="width:900px;height:400px;"></div><script type="application/json" data-html-dependency="">{"name": "htmltools-fill", "version": "0.5.8.9000", "source": {"package": "shiny", "subdir": "www/shared/htmltools/fill"}, "script": [], "stylesheet": [{"href": "fill.css", "rel": "stylesheet"}], "meta": [], "all_files": false, "head": null}</script>
</div>
<div class="cell-output cell-output-display no-overflow-x">
<div class="shiny-html-output" id="dist_remarks_ui"></div>
</div>
</div>
<hr>
</section>
<section id="chapter-4-correlation-analysis" class="level1">
<h1>Chapter 4: Correlation Analysis</h1>
<div id="af74a132" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>corr_variables <span class="op">=</span> [<span class="st">'actual_evapotranspiration'</span>,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_area'</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_production'</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_irrigated_area'</span>,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>             <span class="st">'maximum_temperature'</span>,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>             <span class="st">'minimum_temperature'</span>, </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">'precipitation'</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>             <span class="st">'water_deficit'</span>,</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_kharif'</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_rabi'</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>corr_remarks <span class="op">=</span> {</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_evapotranspiration"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_area"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_production"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_irrigated_area"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maximum_temperature"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minimum_temperature"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precipitation"</span>: <span class="st">"No Correlation."</span>,      </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"water_deficit"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_kharif"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_rabi"</span>: <span class="st">"No Correlation"</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9bdc45d8" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># UI elements</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>ui.input_select(<span class="st">"corr_var"</span>, <span class="st">"Choose Variable"</span>, choices<span class="op">=</span>corr_variables)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corr_plot():</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.corr_var()</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> filtered_df[<span class="st">'rice_yield'</span>].corr(filtered_df[col])</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(f'Correlation: {corr:.2f}')</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Scatter plot with regression line</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    sns.regplot(x<span class="op">=</span>col, y<span class="op">=</span><span class="st">'rice_yield'</span>, data<span class="op">=</span>filtered_df, ax<span class="op">=</span>ax)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Scatter Plot (Correlation: </span><span class="sc">{</span>corr<span class="sc">:.2f}</span><span class="ss">)'</span>, fontdict<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">12</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>, <span class="st">'family'</span>: <span class="st">'Arial'</span>})</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(ax.get_xlabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(ax.get_ylabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corr_remarks_ui():</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.corr_var()</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TagList(tags.p(<span class="st">"Remarks for "</span>, tags.code(col), <span class="st">": "</span>, tags.strong(corr_remarks.get(col))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display no-overflow-x" data-execution_count="26">
<div class="form-group shiny-input-container">
  <label class="control-label" id="corr_var-label" for="corr_var">Choose Variable</label>
  <div>
    <select class="shiny-input-select form-select" id="corr_var">      <option value="actual_evapotranspiration" selected="">actual_evapotranspiration</option>
      <option value="rice_area">rice_area</option>
      <option value="rice_production">rice_production</option>
      <option value="rice_irrigated_area">rice_irrigated_area</option>
      <option value="maximum_temperature">maximum_temperature</option>
      <option value="minimum_temperature">minimum_temperature</option>
      <option value="precipitation">precipitation</option>
      <option value="water_deficit">water_deficit</option>
      <option value="total_kharif">total_kharif</option>
      <option value="total_rabi">total_rabi</option></select>
  </div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="corr_plot" class="shiny-image-output html-fill-item shiny-plot-output" style="width:900px;height:400px;"></div><script type="application/json" data-html-dependency="">{"name": "htmltools-fill", "version": "0.5.8.9000", "source": {"package": "shiny", "subdir": "www/shared/htmltools/fill"}, "script": [], "stylesheet": [{"href": "fill.css", "rel": "stylesheet"}], "meta": [], "all_files": false, "head": null}</script>
</div>
<div class="cell-output cell-output-display no-overflow-x">
<div class="shiny-html-output" id="corr_remarks_ui"></div>
</div>
</div>
<div id="ce2a50bb" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>corr_df <span class="op">=</span> filtered_df.drop(columns<span class="op">=</span>[<span class="st">'dist_name'</span>, <span class="st">'year'</span>, <span class="st">'year_rescale'</span>]).corr()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b60faab5" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.colors <span class="im">as</span> mcolors</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">700</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cor_plot():</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sky_blue_cmap = sns.light_palette('deepskyblue', as_cmap=True, reverse=True)</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> mcolors.LinearSegmentedColormap.from_list(<span class="st">'custom_deepskyblue'</span>, [<span class="st">'deepskyblue'</span>, <span class="st">'white'</span>, <span class="st">'deepskyblue'</span>], N<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> mcolors.CenteredNorm()</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the heatmap</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(corr_df,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>                annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>                cmap<span class="op">=</span>cmap,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>                vmin<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>                vmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">=</span><span class="st">'.1f'</span>,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>                mask<span class="op">=</span>np.triu(np.ones_like(corr_df, dtype<span class="op">=</span><span class="bu">bool</span>)),</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>                norm<span class="op">=</span>norm</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Heatmap of Correlation Coefficient Matrix'</span>, fontdict<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">12</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>, <span class="st">'family'</span>: <span class="st">'Arial'</span>})<span class="op">;</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.grid(<span class="va">False</span>)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.grid(<span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="cor_plot" class="shiny-image-output html-fill-item shiny-plot-output" style="width:900px;height:700px;"></div><script type="application/json" data-html-dependency="">{"name": "htmltools-fill", "version": "0.5.8.9000", "source": {"package": "shiny", "subdir": "www/shared/htmltools/fill"}, "script": [], "stylesheet": [{"href": "fill.css", "rel": "stylesheet"}], "meta": [], "all_files": false, "head": null}</script>
</div>
</div>
</section>
<section id="chapter-5-split-data---train-and-test" class="level1">
<h1>Chapter 5: Split Data - Train and Test</h1>
<div id="9f9635a4" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="op">=</span> filtered_df.drop(columns<span class="op">=</span>[<span class="st">'year_rescale'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="502f6057" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> filtered_df.sort_values([<span class="st">'year'</span>, <span class="st">'dist_name'</span>])</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Split</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> df[df[<span class="st">'year'</span>] <span class="op">&lt;=</span> <span class="dv">2010</span>].copy()</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> df[df[<span class="st">'year'</span>] <span class="op">&gt;</span> <span class="dv">2010</span>].copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">dist_name</th>
<th data-quarto-table-cell-role="th">actual_evapotranspiration</th>
<th data-quarto-table-cell-role="th">rice_area</th>
<th data-quarto-table-cell-role="th">rice_production</th>
<th data-quarto-table-cell-role="th">rice_yield</th>
<th data-quarto-table-cell-role="th">rice_irrigated_area</th>
<th data-quarto-table-cell-role="th">maximum_temperature</th>
<th data-quarto-table-cell-role="th">minimum_temperature</th>
<th data-quarto-table-cell-role="th">precipitation</th>
<th data-quarto-table-cell-role="th">total_kharif</th>
<th data-quarto-table-cell-role="th">total_rabi</th>
<th data-quarto-table-cell-role="th">water_deficit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1990</td>
<td>Coimbatore</td>
<td>67.75</td>
<td>18.16</td>
<td>62.75</td>
<td>3455.00</td>
<td>18.16</td>
<td>30.11</td>
<td>20.84</td>
<td>82.44</td>
<td>31828.00</td>
<td>35310.00</td>
<td>67.48</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1990</td>
<td>Cuddalore</td>
<td>88.41</td>
<td>179.94</td>
<td>611.61</td>
<td>3399.00</td>
<td>177.17</td>
<td>33.09</td>
<td>24.18</td>
<td>96.53</td>
<td>38261.00</td>
<td>50444.00</td>
<td>70.68</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1990</td>
<td>Dharmapuri</td>
<td>61.98</td>
<td>29.93</td>
<td>96.18</td>
<td>3213.00</td>
<td>29.84</td>
<td>32.10</td>
<td>21.22</td>
<td>63.40</td>
<td>6668.00</td>
<td>7921.00</td>
<td>85.49</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1990</td>
<td>Dindigul</td>
<td>62.80</td>
<td>21.95</td>
<td>80.56</td>
<td>3670.00</td>
<td>21.95</td>
<td>31.14</td>
<td>21.54</td>
<td>73.56</td>
<td>7457.00</td>
<td>9282.00</td>
<td>88.09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1990</td>
<td>Erode</td>
<td>47.85</td>
<td>64.26</td>
<td>277.26</td>
<td>4315.00</td>
<td>64.26</td>
<td>31.64</td>
<td>21.31</td>
<td>50.69</td>
<td>19292.00</td>
<td>27091.00</td>
<td>98.29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">715</td>
<td>2015</td>
<td>Tiruchirappalli</td>
<td>86.83</td>
<td>58.57</td>
<td>244.21</td>
<td>4170.00</td>
<td>58.21</td>
<td>34.11</td>
<td>24.42</td>
<td>94.82</td>
<td>24340.00</td>
<td>41598.00</td>
<td>68.07</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">717</td>
<td>2015</td>
<td>Tiruvannamalai</td>
<td>88.50</td>
<td>138.88</td>
<td>550.74</td>
<td>3966.00</td>
<td>138.72</td>
<td>33.49</td>
<td>23.64</td>
<td>92.60</td>
<td>15744.00</td>
<td>49142.00</td>
<td>56.30</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">718</td>
<td>2015</td>
<td>Vellore</td>
<td>77.57</td>
<td>51.77</td>
<td>202.22</td>
<td>3906.00</td>
<td>51.77</td>
<td>32.88</td>
<td>22.77</td>
<td>82.61</td>
<td>17293.00</td>
<td>43877.00</td>
<td>63.75</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">719</td>
<td>2015</td>
<td>Villupuram</td>
<td>91.90</td>
<td>182.30</td>
<td>773.31</td>
<td>4242.00</td>
<td>181.37</td>
<td>33.70</td>
<td>24.26</td>
<td>99.12</td>
<td>32056.00</td>
<td>71736.00</td>
<td>58.99</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">720</td>
<td>2015</td>
<td>Virudhunagar</td>
<td>87.69</td>
<td>28.61</td>
<td>100.61</td>
<td>3517.00</td>
<td>28.22</td>
<td>34.37</td>
<td>25.51</td>
<td>99.96</td>
<td>4618.00</td>
<td>10910.00</td>
<td>69.40</td>
</tr>
</tbody>
</table>

<p>566 rows × 13 columns</p>
</div>
</div>
</div>
<div id="b105695e" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>train_df.head(<span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">dist_name</th>
<th data-quarto-table-cell-role="th">actual_evapotranspiration</th>
<th data-quarto-table-cell-role="th">rice_area</th>
<th data-quarto-table-cell-role="th">rice_production</th>
<th data-quarto-table-cell-role="th">rice_yield</th>
<th data-quarto-table-cell-role="th">rice_irrigated_area</th>
<th data-quarto-table-cell-role="th">maximum_temperature</th>
<th data-quarto-table-cell-role="th">minimum_temperature</th>
<th data-quarto-table-cell-role="th">precipitation</th>
<th data-quarto-table-cell-role="th">total_kharif</th>
<th data-quarto-table-cell-role="th">total_rabi</th>
<th data-quarto-table-cell-role="th">water_deficit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1990</td>
<td>Coimbatore</td>
<td>67.75</td>
<td>18.16</td>
<td>62.75</td>
<td>3455.00</td>
<td>18.16</td>
<td>30.11</td>
<td>20.84</td>
<td>82.44</td>
<td>31828.00</td>
<td>35310.00</td>
<td>67.48</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1990</td>
<td>Cuddalore</td>
<td>88.41</td>
<td>179.94</td>
<td>611.61</td>
<td>3399.00</td>
<td>177.17</td>
<td>33.09</td>
<td>24.18</td>
<td>96.53</td>
<td>38261.00</td>
<td>50444.00</td>
<td>70.68</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1990</td>
<td>Dharmapuri</td>
<td>61.98</td>
<td>29.93</td>
<td>96.18</td>
<td>3213.00</td>
<td>29.84</td>
<td>32.10</td>
<td>21.22</td>
<td>63.40</td>
<td>6668.00</td>
<td>7921.00</td>
<td>85.49</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1990</td>
<td>Dindigul</td>
<td>62.80</td>
<td>21.95</td>
<td>80.56</td>
<td>3670.00</td>
<td>21.95</td>
<td>31.14</td>
<td>21.54</td>
<td>73.56</td>
<td>7457.00</td>
<td>9282.00</td>
<td>88.09</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1990</td>
<td>Erode</td>
<td>47.85</td>
<td>64.26</td>
<td>277.26</td>
<td>4315.00</td>
<td>64.26</td>
<td>31.64</td>
<td>21.31</td>
<td>50.69</td>
<td>19292.00</td>
<td>27091.00</td>
<td>98.29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>1990</td>
<td>Kancheepuram</td>
<td>90.60</td>
<td>231.96</td>
<td>743.65</td>
<td>3206.00</td>
<td>209.69</td>
<td>33.21</td>
<td>23.87</td>
<td>96.47</td>
<td>23123.00</td>
<td>43988.00</td>
<td>66.67</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>1990</td>
<td>Kanyakumari</td>
<td>83.56</td>
<td>41.23</td>
<td>127.82</td>
<td>3100.00</td>
<td>41.23</td>
<td>30.07</td>
<td>23.20</td>
<td>109.54</td>
<td>6379.00</td>
<td>8080.00</td>
<td>51.45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1990</td>
<td>Madurai</td>
<td>66.38</td>
<td>119.15</td>
<td>409.55</td>
<td>3437.00</td>
<td>119.15</td>
<td>33.48</td>
<td>24.00</td>
<td>78.07</td>
<td>30619.00</td>
<td>43084.00</td>
<td>95.56</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1990</td>
<td>Pudukkottai</td>
<td>72.09</td>
<td>68.44</td>
<td>172.55</td>
<td>2521.00</td>
<td>64.31</td>
<td>33.27</td>
<td>24.54</td>
<td>82.71</td>
<td>5000.00</td>
<td>13785.00</td>
<td>91.29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>1990</td>
<td>Ramananthapuram</td>
<td>59.57</td>
<td>151.27</td>
<td>263.44</td>
<td>1742.00</td>
<td>64.08</td>
<td>33.36</td>
<td>25.64</td>
<td>72.39</td>
<td>1643.00</td>
<td>7235.00</td>
<td>109.78</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>1990</td>
<td>Salem</td>
<td>63.67</td>
<td>30.38</td>
<td>101.04</td>
<td>3326.00</td>
<td>30.08</td>
<td>32.55</td>
<td>21.84</td>
<td>67.66</td>
<td>22369.00</td>
<td>21460.00</td>
<td>88.84</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>1990</td>
<td>Sivagangai</td>
<td>70.69</td>
<td>89.34</td>
<td>203.12</td>
<td>2274.00</td>
<td>70.72</td>
<td>33.46</td>
<td>24.82</td>
<td>82.96</td>
<td>2339.00</td>
<td>6993.00</td>
<td>93.43</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>1990</td>
<td>Thanjavur</td>
<td>78.58</td>
<td>459.42</td>
<td>1403.46</td>
<td>3055.00</td>
<td>444.70</td>
<td>32.84</td>
<td>24.36</td>
<td>90.17</td>
<td>53428.00</td>
<td>72854.00</td>
<td>79.86</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>1990</td>
<td>The Nilgiris</td>
<td>69.05</td>
<td>2.78</td>
<td>6.89</td>
<td>2478.00</td>
<td>0.16</td>
<td>24.05</td>
<td>14.74</td>
<td>103.64</td>
<td>5822.00</td>
<td>4496.00</td>
<td>44.25</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>1990</td>
<td>Thirunelveli</td>
<td>67.39</td>
<td>101.40</td>
<td>398.26</td>
<td>3928.00</td>
<td>101.40</td>
<td>32.35</td>
<td>24.38</td>
<td>87.34</td>
<td>17844.00</td>
<td>23418.00</td>
<td>86.36</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>1990</td>
<td>Thoothukudi</td>
<td>48.12</td>
<td>28.79</td>
<td>136.00</td>
<td>4724.00</td>
<td>28.79</td>
<td>33.95</td>
<td>25.58</td>
<td>60.10</td>
<td>5391.00</td>
<td>8356.00</td>
<td>120.16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>1990</td>
<td>Tiruchirappalli</td>
<td>61.63</td>
<td>92.68</td>
<td>299.42</td>
<td>3231.00</td>
<td>78.72</td>
<td>33.63</td>
<td>23.69</td>
<td>70.52</td>
<td>30997.00</td>
<td>48525.00</td>
<td>100.93</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>1990</td>
<td>Tiruvannamalai</td>
<td>78.96</td>
<td>53.32</td>
<td>164.54</td>
<td>3086.00</td>
<td>53.32</td>
<td>32.91</td>
<td>22.83</td>
<td>81.15</td>
<td>7723.00</td>
<td>15284.00</td>
<td>73.58</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>1990</td>
<td>Vellore</td>
<td>69.99</td>
<td>34.57</td>
<td>100.85</td>
<td>2917.00</td>
<td>144.57</td>
<td>32.31</td>
<td>21.92</td>
<td>70.94</td>
<td>16956.00</td>
<td>27208.00</td>
<td>77.91</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>1990</td>
<td>Virudhunagar</td>
<td>61.77</td>
<td>36.78</td>
<td>123.49</td>
<td>3358.00</td>
<td>33.76</td>
<td>33.95</td>
<td>25.06</td>
<td>74.63</td>
<td>7463.00</td>
<td>15531.00</td>
<td>104.28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>1991</td>
<td>Coimbatore</td>
<td>77.13</td>
<td>21.29</td>
<td>73.83</td>
<td>3468.00</td>
<td>21.29</td>
<td>30.11</td>
<td>20.83</td>
<td>103.49</td>
<td>29056.00</td>
<td>28827.00</td>
<td>56.74</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>1991</td>
<td>Cuddalore</td>
<td>83.84</td>
<td>233.31</td>
<td>827.59</td>
<td>3547.00</td>
<td>229.49</td>
<td>33.10</td>
<td>24.19</td>
<td>96.56</td>
<td>32555.00</td>
<td>49602.00</td>
<td>73.26</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>1991</td>
<td>Dharmapuri</td>
<td>71.76</td>
<td>76.60</td>
<td>244.43</td>
<td>3191.00</td>
<td>76.45</td>
<td>32.12</td>
<td>21.23</td>
<td>86.95</td>
<td>7044.00</td>
<td>10113.00</td>
<td>76.89</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>1991</td>
<td>Dindigul</td>
<td>64.33</td>
<td>19.72</td>
<td>72.30</td>
<td>3666.00</td>
<td>19.67</td>
<td>31.15</td>
<td>21.55</td>
<td>67.07</td>
<td>6828.00</td>
<td>11603.00</td>
<td>83.59</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>1991</td>
<td>Erode</td>
<td>59.68</td>
<td>75.56</td>
<td>285.82</td>
<td>3783.00</td>
<td>75.47</td>
<td>31.65</td>
<td>21.31</td>
<td>66.86</td>
<td>20893.00</td>
<td>23793.00</td>
<td>86.68</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>1991</td>
<td>Kancheepuram</td>
<td>84.91</td>
<td>264.41</td>
<td>894.59</td>
<td>3383.00</td>
<td>242.20</td>
<td>33.23</td>
<td>23.88</td>
<td>101.79</td>
<td>24619.00</td>
<td>35790.00</td>
<td>71.28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>1991</td>
<td>Kanyakumari</td>
<td>86.28</td>
<td>40.57</td>
<td>143.22</td>
<td>3530.00</td>
<td>40.57</td>
<td>30.06</td>
<td>23.18</td>
<td>114.60</td>
<td>6872.00</td>
<td>9338.00</td>
<td>46.24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">27</td>
<td>1991</td>
<td>Madurai</td>
<td>67.91</td>
<td>102.54</td>
<td>363.75</td>
<td>3547.00</td>
<td>102.54</td>
<td>33.50</td>
<td>24.01</td>
<td>66.79</td>
<td>31572.00</td>
<td>34850.00</td>
<td>90.14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>1991</td>
<td>Pudukkottai</td>
<td>71.02</td>
<td>76.11</td>
<td>215.02</td>
<td>2825.00</td>
<td>72.95</td>
<td>33.28</td>
<td>24.54</td>
<td>72.01</td>
<td>5170.00</td>
<td>19695.00</td>
<td>88.81</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">29</td>
<td>1991</td>
<td>Ramananthapuram</td>
<td>61.12</td>
<td>137.38</td>
<td>69.47</td>
<td>506.00</td>
<td>56.53</td>
<td>33.38</td>
<td>25.65</td>
<td>57.74</td>
<td>1948.00</td>
<td>9741.00</td>
<td>103.17</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="d3a81ef0" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>train_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 456 entries, 0 to 566
Data columns (total 13 columns):
 #   Column                     Non-Null Count  Dtype  
---  ------                     --------------  -----  
 0   year                       456 non-null    int64  
 1   dist_name                  456 non-null    object 
 2   actual_evapotranspiration  456 non-null    float64
 3   rice_area                  456 non-null    float64
 4   rice_production            456 non-null    float64
 5   rice_yield                 456 non-null    float64
 6   rice_irrigated_area        456 non-null    float64
 7   maximum_temperature        456 non-null    float64
 8   minimum_temperature        456 non-null    float64
 9   precipitation              456 non-null    float64
 10  total_kharif               456 non-null    float64
 11  total_rabi                 456 non-null    float64
 12  water_deficit              456 non-null    float64
dtypes: float64(11), int64(1), object(1)
memory usage: 49.9+ KB</code></pre>
</div>
</div>
<div id="b8c2a430" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>test_df.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Index: 110 entries, 568 to 720
Data columns (total 13 columns):
 #   Column                     Non-Null Count  Dtype  
---  ------                     --------------  -----  
 0   year                       110 non-null    int64  
 1   dist_name                  110 non-null    object 
 2   actual_evapotranspiration  110 non-null    float64
 3   rice_area                  110 non-null    float64
 4   rice_production            110 non-null    float64
 5   rice_yield                 110 non-null    float64
 6   rice_irrigated_area        110 non-null    float64
 7   maximum_temperature        110 non-null    float64
 8   minimum_temperature        110 non-null    float64
 9   precipitation              110 non-null    float64
 10  total_kharif               110 non-null    float64
 11  total_rabi                 110 non-null    float64
 12  water_deficit              110 non-null    float64
dtypes: float64(11), int64(1), object(1)
memory usage: 12.0+ KB</code></pre>
</div>
</div>
<div id="3139e375" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'split'</span>] <span class="op">=</span> df[<span class="st">'year'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">"Train"</span> <span class="cf">if</span> x <span class="op">&lt;=</span> <span class="dv">2010</span> <span class="cf">else</span> <span class="st">"Test"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>df.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">dist_name</th>
<th data-quarto-table-cell-role="th">actual_evapotranspiration</th>
<th data-quarto-table-cell-role="th">rice_area</th>
<th data-quarto-table-cell-role="th">rice_production</th>
<th data-quarto-table-cell-role="th">rice_yield</th>
<th data-quarto-table-cell-role="th">rice_irrigated_area</th>
<th data-quarto-table-cell-role="th">maximum_temperature</th>
<th data-quarto-table-cell-role="th">minimum_temperature</th>
<th data-quarto-table-cell-role="th">precipitation</th>
<th data-quarto-table-cell-role="th">total_kharif</th>
<th data-quarto-table-cell-role="th">total_rabi</th>
<th data-quarto-table-cell-role="th">water_deficit</th>
<th data-quarto-table-cell-role="th">split</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">715</td>
<td>2015</td>
<td>Tiruchirappalli</td>
<td>86.83</td>
<td>58.57</td>
<td>244.21</td>
<td>4170.00</td>
<td>58.21</td>
<td>34.11</td>
<td>24.42</td>
<td>94.82</td>
<td>24340.00</td>
<td>41598.00</td>
<td>68.07</td>
<td>Test</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">717</td>
<td>2015</td>
<td>Tiruvannamalai</td>
<td>88.50</td>
<td>138.88</td>
<td>550.74</td>
<td>3966.00</td>
<td>138.72</td>
<td>33.49</td>
<td>23.64</td>
<td>92.60</td>
<td>15744.00</td>
<td>49142.00</td>
<td>56.30</td>
<td>Test</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">718</td>
<td>2015</td>
<td>Vellore</td>
<td>77.57</td>
<td>51.77</td>
<td>202.22</td>
<td>3906.00</td>
<td>51.77</td>
<td>32.88</td>
<td>22.77</td>
<td>82.61</td>
<td>17293.00</td>
<td>43877.00</td>
<td>63.75</td>
<td>Test</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">719</td>
<td>2015</td>
<td>Villupuram</td>
<td>91.90</td>
<td>182.30</td>
<td>773.31</td>
<td>4242.00</td>
<td>181.37</td>
<td>33.70</td>
<td>24.26</td>
<td>99.12</td>
<td>32056.00</td>
<td>71736.00</td>
<td>58.99</td>
<td>Test</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">720</td>
<td>2015</td>
<td>Virudhunagar</td>
<td>87.69</td>
<td>28.61</td>
<td>100.61</td>
<td>3517.00</td>
<td>28.22</td>
<td>34.37</td>
<td>25.51</td>
<td>99.96</td>
<td>4618.00</td>
<td>10910.00</td>
<td>69.40</td>
<td>Test</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="3d5a4ece" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>plot_columns <span class="op">=</span> [</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maximum_temperature"</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minimum_temperature"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precipitation"</span>,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_evapotranspiration"</span>,</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_yield"</span>,</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_production"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"water_deficit"</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5f227f81" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>ui.input_select(<span class="st">'feature'</span>, <span class="st">'Choose a feature'</span>, choices<span class="op">=</span>plot_columns)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_test_plot():</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  sns.scatterplot(data<span class="op">=</span>df,</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>                  x<span class="op">=</span><span class="st">'year'</span>,</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>                  y<span class="op">=</span><span class="bu">input</span>.feature(),</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>                  hue<span class="op">=</span><span class="st">'split'</span>,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>                  ax<span class="op">=</span>ax)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  plt.title(<span class="st">'Train test split'</span>, fontdict<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">13</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>, <span class="st">'family'</span>: <span class="st">'Arial'</span>})</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  plt.xlabel(<span class="st">'Year'</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  plt.legend(</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>        bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>),  <span class="co"># x=1.05 (right outside), y=1 (top aligned)</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        loc<span class="op">=</span><span class="st">"upper left"</span>,</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        ncol<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>  ax.set_xlabel(ax.get_xlabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  ax.set_ylabel(ax.get_ylabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display no-overflow-x" data-execution_count="36">
<div class="form-group shiny-input-container">
  <label class="control-label" id="feature-label" for="feature">Choose a feature</label>
  <div>
    <select class="shiny-input-select form-select" id="feature">      <option value="maximum_temperature" selected="">maximum_temperature</option>
      <option value="minimum_temperature">minimum_temperature</option>
      <option value="precipitation">precipitation</option>
      <option value="actual_evapotranspiration">actual_evapotranspiration</option>
      <option value="rice_yield">rice_yield</option>
      <option value="rice_production">rice_production</option>
      <option value="water_deficit">water_deficit</option></select>
  </div>
</div>
</div>
<div class="cell-output cell-output-display">
<div id="train_test_plot" class="shiny-image-output html-fill-item shiny-plot-output" style="width:900px;height:400px;"></div><script type="application/json" data-html-dependency="">{"name": "htmltools-fill", "version": "0.5.8.9000", "source": {"package": "shiny", "subdir": "www/shared/htmltools/fill"}, "script": [], "stylesheet": [{"href": "fill.css", "rel": "stylesheet"}], "meta": [], "all_files": false, "head": null}</script>
</div>
</div>
<section id="train-and-test-set" class="level2">
<h2 class="anchored" data-anchor-id="train-and-test-set">Train and Test Set</h2>
<div id="7ab4d357" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_df.drop(columns<span class="op">=</span>[<span class="st">'rice_yield'</span>])</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_df[<span class="st">'rice_yield'</span>]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_df.drop(columns<span class="op">=</span>[<span class="st">'rice_yield'</span>])</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_df[<span class="st">'rice_yield'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="time-series-split" class="level2">
<h2 class="anchored" data-anchor-id="time-series-split">Time-series Split</h2>
<div id="dd4e8ef9" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> set_config</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>set_config(display<span class="op">=</span><span class="st">'text'</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> X_train.shape[<span class="dv">0</span>]</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>MIN_TEST_SIZE <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>n_splits <span class="op">=</span> N <span class="op">//</span> MIN_TEST_SIZE <span class="op">-</span> <span class="dv">1</span> <span class="co"># To ensure we get the atleast the same size for every split</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span>n_splits)</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>tscv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<pre><code>TimeSeriesSplit(gap=0, max_train_size=None, n_splits=14, test_size=None)</code></pre>
</div>
</div>
</section>
<section id="checking-time-series-splits" class="level2">
<h2 class="anchored" data-anchor-id="checking-time-series-splits">Checking Time-series Splits</h2>
<div id="453648ed" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># for i, (train_idx, test_idx) in enumerate(tscv.split(X_train)):</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Split {i+1}: Train size = {len(train_idx)}, Test size = {len(test_idx)}")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="chapter-6-data-preprocessing" class="level1">
<h1>Chapter 6: Data Preprocessing</h1>
<p>In this chapter, we’ll use a preprocessing pipeline to transfom numeric and categoric data in our dataset. Post this, we will be building our candidate models and do hyperparameter optimization to pick the best one.</p>
<div id="f30df128" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Column Selector</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> make_column_selector <span class="im">as</span> selector</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>numeric_columns_selector <span class="op">=</span> selector(dtype_exclude<span class="op">=</span><span class="bu">object</span>)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>categoric_columns_selector <span class="op">=</span> selector(dtype_include<span class="op">=</span><span class="bu">object</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="50129357" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>numeric_columns <span class="op">=</span> numeric_columns_selector(X_train)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>categoric_columns <span class="op">=</span> categoric_columns_selector(X_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="preprocessor-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="preprocessor-pipeline">Preprocessor Pipeline</h2>
<div id="bef51d82" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, MinMaxScaler</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>categoric_transformer <span class="op">=</span> OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>numeric_transformer <span class="op">=</span> MinMaxScaler()</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(transformers<span class="op">=</span>[(<span class="st">'categoric'</span>, categoric_transformer, categoric_columns),</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>                                               (<span class="st">'numeric'</span>, numeric_transformer, numeric_columns)],</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>                                remainder<span class="op">=</span><span class="st">'passthrough'</span>,</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>                                verbose_feature_names_out<span class="op">=</span><span class="va">False</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>                                )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="chapter-7-validation-curves" class="level1">
<h1>Chapter 7: Validation Curves</h1>
<section id="baseline-model" class="level2">
<h2 class="anchored" data-anchor-id="baseline-model">Baseline Model</h2>
<p>This model always predicts the mean value of <code>y_train</code> and doesn’t consider the features. Ideally, our best performing model should do better than this baseline model.</p>
<div id="6762f4a9" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.sklearn</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyRegressor</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlflow.models.signature <span class="im">import</span> infer_signature</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.plots <span class="im">import</span> prediction_error_display</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.plots <span class="im">import</span> validation_curve_display</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure X_train and X_test are DataFrames or convertible to one</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>X_train_df <span class="op">=</span> pd.DataFrame(X_train)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>X_test_df <span class="op">=</span> pd.DataFrame(X_test)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>y_train_series <span class="op">=</span> pd.Series(y_train)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>y_test_series <span class="op">=</span> pd.Series(y_test)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tracking URI and experiment name</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns"</span>)</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"dummy_baseline"</span>)</span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"Dummy Regressor"</span>):</span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the Dummy Regressor</span></span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a>    dummy <span class="op">=</span> DummyRegressor(strategy<span class="op">=</span><span class="st">"mean"</span>)</span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a>    dummy.fit(X_train_df, y_train_series)</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict</span></span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> dummy.predict(X_test_df)</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute metrics</span></span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_test_series, y_pred)</span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_test_series, y_pred)</span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log parameters and metrics</span></span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">"strategy"</span>, <span class="st">"mean"</span>)</span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"mse"</span>, mse)</span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"r2"</span>, r2)</span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log the model with signature</span></span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>    signature <span class="op">=</span> infer_signature(X_test_df, y_pred)</span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>    mlflow.sklearn.log_model(</span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        sk_model<span class="op">=</span>dummy,</span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"dummy_model"</span>,  <span class="co"># Use `name=` instead of `artifact_path=`</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>        signature<span class="op">=</span>signature,</span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>        registered_model_name<span class="op">=</span><span class="st">'baseline_dummy'</span>,</span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>        input_example<span class="op">=</span>X_test_df.head(<span class="dv">5</span>)</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create and save the prediction error plot</span></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fig, ax = plt.subplots(figsize=(15, 6))</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a>    display <span class="op">=</span> prediction_error_display(y_test<span class="op">=</span>y_test, y_pred<span class="op">=</span>y_pred)</span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># display.plot(ax=ax)</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plt.title("Prediction Error Plot")</span></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save and log as artifact</span></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a>    artifact_dir <span class="op">=</span> <span class="st">"mlflow_artifacts"</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a>    os.makedirs(artifact_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a>    plot_path <span class="op">=</span> os.path.join(artifact_dir, <span class="st">"prediction_error.png"</span>)</span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>    display.savefig(plot_path)</span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(plot_path)</span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>    mlflow.end_run()</span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a><span class="co"># print(mlflow.search_experiments()) </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:44:46 INFO mlflow.tracking.fluent: Experiment with name 'dummy_baseline' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>&lt;Experiment: artifact_location='file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns/769045443426172346', creation_time=1755846886722, experiment_id='769045443426172346', last_update_time=1755846886722, lifecycle_stage='active', name='dummy_baseline', tags={}&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>DummyRegressor()</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>'mean'</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c6dc42512da14391876b8705bd1284e6","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Successfully registered model 'baseline_dummy'.
Created version '1' of model 'baseline_dummy'.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>&lt;mlflow.models.model.ModelInfo at 0x18433e1ea20&gt;</code></pre>
</div>
</div>
<div id="3d369489" class="cell" data-fig-show="hide" data-execution_count="44">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVR</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns"</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"svr_reg"</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>artifact_dir <span class="op">=</span> <span class="st">"mlflow_artifacts_svr"</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>os.makedirs(artifact_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"SVR Regressor"</span>):</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>  param_grid <span class="op">=</span> {</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__C'</span>: [<span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1100</span>],   <span class="co"># narrowed down from plot results</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__epsilon'</span>: [<span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>],    <span class="co"># narrowed down from plot results</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__gamma'</span>: [<span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>],  <span class="co"># narrowed down</span></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__kernel'</span>: [<span class="st">'rbf'</span>, <span class="st">'poly'</span>, <span class="st">'linear'</span>]    <span class="co"># chose the best-performing kernels from plots</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the pipeline with GridSearchCV</span></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>  svr_pipeline <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(max_iter<span class="op">=</span><span class="dv">500</span>))])</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>  svr_model <span class="op">=</span> GridSearchCV(svr_pipeline, param_grid, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>, n_jobs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit GridSearchCV</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a>  svr_model.fit(X_train, y_train)</span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  best_model <span class="op">=</span> svr_model.best_estimator_</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>  y_pred_test <span class="op">=</span> best_model.predict(X_test)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a>  test_rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test, y_pred_test))</span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CV results</span></span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  cv_results <span class="op">=</span> pd.DataFrame(svr_model.cv_results_).sort_values(by<span class="op">=</span><span class="st">'rank_test_score'</span>).head(<span class="dv">5</span>)</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>  cv_results <span class="op">=</span> cv_results[[<span class="st">'params'</span>, <span class="st">'mean_test_score'</span>, <span class="st">'std_test_score'</span>, <span class="st">'rank_test_score'</span>]]</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>  cv_results[<span class="st">'mean_test_score'</span>] <span class="op">=</span> <span class="op">-</span>cv_results[<span class="st">'mean_test_score'</span>]</span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>  cv_results.to_csv(<span class="st">"mlflow_artifacts_svr/svr_cv_results.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MLflow logging</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>  mlflow.log_params(svr_model.best_params_)</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>  mlflow.log_metric(<span class="st">"train_rmse"</span>, np.sqrt(<span class="op">-</span>svr_model.best_score_))</span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>  mlflow.log_metric(<span class="st">"test_rmse"</span>, test_rmse)</span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mlflow.sklearn.log_model(best_model, name="model")</span></span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>  mlflow.sklearn.log_model(</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>    best_model,</span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>    input_example<span class="op">=</span>X_test.iloc[:<span class="dv">1</span>]</span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>  mlflow.log_artifact(<span class="st">"mlflow_artifacts_svr/svr_cv_results.csv"</span>)</span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig, ax = plt.subplots()</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>  display <span class="op">=</span> prediction_error_display(y_test<span class="op">=</span>y_test, y_pred<span class="op">=</span>y_pred_test)</span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>  plot_path <span class="op">=</span> os.path.join(artifact_dir, <span class="st">"acutual_vs_predicted.png"</span>)</span>
<span id="cb62-55"><a href="#cb62-55" aria-hidden="true" tabindex="-1"></a>  display.savefig(plot_path)</span>
<span id="cb62-56"><a href="#cb62-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.close()</span></span>
<span id="cb62-57"><a href="#cb62-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-58"><a href="#cb62-58" aria-hidden="true" tabindex="-1"></a>  mlflow.log_artifact(plot_path)</span>
<span id="cb62-59"><a href="#cb62-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-60"><a href="#cb62-60" aria-hidden="true" tabindex="-1"></a>  mlflow.end_run()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:45:03 INFO mlflow.tracking.fluent: Experiment with name 'svr_reg' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>GridSearchCV(cv=TimeSeriesSplit(gap=0, max_train_size=None, n_splits=14, test_size=None),
             estimator=Pipeline(steps=[('preprocessor',
                                        ColumnTransformer(remainder='passthrough',
                                                          transformers=[('categoric',
                                                                         OneHotEncoder(handle_unknown='ignore'),
                                                                         ['dist_name']),
                                                                        ('numeric',
                                                                         MinMaxScaler(),
                                                                         ['year',
                                                                          'actual_evapotranspiration',
                                                                          'rice_area',
                                                                          'rice_production',
                                                                          'rice_i...
                                                                          'maximum_temperature',
                                                                          'minimum_temperature',
                                                                          'precipitation',
                                                                          'total_kharif',
                                                                          'total_rabi',
                                                                          'water_deficit'])],
                                                          verbose_feature_names_out=False)),
                                       ('svr', SVR(max_iter=500))]),
             n_jobs=1,
             param_grid={'svr__C': [800, 1000, 1100],
                         'svr__epsilon': [2, 2.5, 3],
                         'svr__gamma': [1e-05, 0.0001, 0.001],
                         'svr__kernel': ['rbf', 'poly', 'linear']},
             scoring='neg_root_mean_squared_error')</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"682e5e131d3b4ad095abd4c0725c6a11","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="eda_notebook_files/figure-html/cell-45-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c3944681" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>exp <span class="op">=</span> mlflow.set_experiment(<span class="st">"svr_reg"</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Experiment ID:"</span>, exp.experiment_id)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tracking URI:"</span>, mlflow.get_tracking_uri())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Experiment ID: 706753193202118080
Tracking URI: file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns</code></pre>
</div>
</div>
<div id="6a7f724b" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> ValidationCurveDisplay, validation_curve</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define your parameter range</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="co"># param_range = [100, 300, 500, 700, 1000, 1100, 1200]</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a><span class="co"># tscv = TimeSeriesSplit(n_splits=5)</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"Validation Curve - SVR__C"</span>):</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  param_range <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">800</span>, <span class="dv">1000</span>]</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create and save validation curve</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  ValidationCurveDisplay.from_estimator(</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>      estimator<span class="op">=</span>svr_pipeline,</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>      X<span class="op">=</span>X_train,</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>      y<span class="op">=</span>y_train,</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>      param_name<span class="op">=</span><span class="st">"svr__C"</span>,  <span class="co"># use correct param name in pipeline</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>      param_range<span class="op">=</span>param_range,</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>      cv<span class="op">=</span>tscv,</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>      scoring<span class="op">=</span><span class="st">"neg_root_mean_squared_error"</span>,</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>      n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>      negate_score<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>      ax<span class="op">=</span>ax</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set title and save the current plot</span></span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a>  plt.title(<span class="st">"Validation Curve for SVR (C)"</span>)</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>  artifact_dir <span class="op">=</span> <span class="st">"mlflow_artifacts_svr"</span></span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>  os.makedirs(artifact_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>  plot_path <span class="op">=</span> os.path.join(artifact_dir, <span class="st">"validation_curve_svr_C.png"</span>)</span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>  plt.savefig(plot_path)</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>  plt.close()</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log the plot to MLflow</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>  mlflow.log_artifact(plot_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>&lt;sklearn.model_selection._plot.ValidationCurveDisplay at 0x1843429ec00&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>Text(0.5, 1.0, 'Validation Curve for SVR (C)')</code></pre>
</div>
</div>
<div id="9bb6ea9a" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVR</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeRegressor</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> ExtraTreesRegressor, AdaBoostRegressor</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>candidate_models <span class="op">=</span> {</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Support Vector Regressor"</span>: {</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(max_iter<span class="op">=</span><span class="dv">500</span>))]),</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__C"</span>: [<span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1100</span>],</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__epsilon"</span>: [<span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>],</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__gamma"</span>: [<span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>],</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Extra Trees Regressor"</span>: {</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'etr'</span>, ExtraTreesRegressor())]),</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_split"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>],</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__n_estimators"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">75</span>],</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__max_depth"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>],</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_leaf"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ada Boost Regressor"</span>: {</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), </span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'ada'</span>, AdaBoostRegressor(DecisionTreeRegressor()))]),</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__n_estimators"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">125</span>],</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__learning_rate"</span>: [<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.04</span>, <span class="fl">0.06</span>],</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">"XGBoost Regressor"</span>: {</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'xgb'</span>, XGBRegressor())]),</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__n_estimators"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">125</span>],</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__learning_rate"</span>: [<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>],</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__max_depth"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>]</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a7172215" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, model_data <span class="kw">in</span> candidate_models.items():</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    pipe <span class="op">=</span> model_data[<span class="st">"pipeline"</span>]</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    param_grid <span class="op">=</span> model_data[<span class="st">"param_grid"</span>]</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="ss">f"Validation_</span><span class="sc">{</span>model_name<span class="sc">.</span>replace(<span class="st">' '</span>, <span class="st">'_'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"validation_curves"</span>):</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>        folder_path <span class="op">=</span> <span class="ss">f"validation_curves/</span><span class="sc">{</span>model_name<span class="sc">.</span>replace(<span class="st">' '</span>, <span class="st">'_'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>        os.makedirs(folder_path, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> param, values <span class="kw">in</span> param_grid.items():</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>            fig <span class="op">=</span> validation_curve_display(</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>                estimator<span class="op">=</span>pipe,</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>                X<span class="op">=</span>X_train,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span>y_train,</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>                param_name<span class="op">=</span>param,</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>                param_range<span class="op">=</span>values,</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>                cv<span class="op">=</span>tscv,</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>                scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>,</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>                negate_score<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>            fig_path <span class="op">=</span> os.path.join(folder_path, <span class="ss">f"</span><span class="sc">{</span>param<span class="sc">.</span>split(<span class="st">'__'</span>)[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>            fig.savefig(fig_path)</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>            mlflow.log_artifact(fig_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e27918f7" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from shiny import render, ui, reactive</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co"># from pathlib import Path</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="co"># from PIL import Image</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib.pyplot as plt</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="co"># model_options = list(candidate_models.keys())</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="co"># @reactive.Calc</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="co"># def selected_model_folder():</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     return Path(f"validation_curves/{"_".join(input.model().split())}")</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a><span class="co"># @render.ui</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a><span class="co"># def dropdown():</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     return ui.input_select("model", "Select a model", choices=model_options)</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="co"># @render.plot</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="co"># def show_all_param_plots():</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     folder = selected_model_folder()</span></span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = [f for f in folder.glob("*.png")]</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     # fig, axs = plt.subplots(len(params), 1, figsize=(8, 20))</span></span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     fig, axs = plt.subplots(len(params), 1, figsize=(10, 10 * len(params)))  # Increase height per plot</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     if len(params) == 1:</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a><span class="co">#         axs = [axs]</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     for ax, param_file in zip(axs, params):</span></span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         img = Image.open(param_file)</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax.imshow(img)</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax.set_title(param_file.stem)</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax.axis("off")</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     # plt.tight_layout()</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     return fig</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c45200ed" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> reactive, render, ui, req</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Base path to saved validation curve plots</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>base_path <span class="op">=</span> Path(<span class="st">"validation_curves"</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatically extract model names from subfolders</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>model_names <span class="op">=</span> <span class="bu">sorted</span>([f.name <span class="cf">for</span> f <span class="kw">in</span> base_path.iterdir() <span class="cf">if</span> f.is_dir()])</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>default_model <span class="op">=</span> model_names[<span class="dv">0</span>] <span class="cf">if</span> model_names <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Model dropdown</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dropdown_model():</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.input_select(</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Select Model"</span>,</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>        choices<span class="op">=</span>model_names,</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        selected<span class="op">=</span>default_model,</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamically get folder path of selected model</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a><span class="at">@reactive.Calc</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_folder():</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> base_path <span class="op">/</span> <span class="bu">input</span>.model()</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamically list available parameter plots in that model's folder</span></span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a><span class="at">@reactive.Calc</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> available_params():</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> model_folder()</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>([f.stem <span class="cf">for</span> f <span class="kw">in</span> folder.glob(<span class="st">"*.png"</span>)])</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter dropdown, reacts to model change</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dropdown_param():</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> available_params()</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>    default_param <span class="op">=</span> params[<span class="dv">0</span>] <span class="cf">if</span> params <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.input_select(</span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"param"</span>,</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Select Parameter"</span>,</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>        choices<span class="op">=</span>params,</span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>        selected<span class="op">=</span>default_param,</span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Show only one selected plot</span></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_plot():</span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># req(input.param())</span></span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># req(input.model())</span></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> model_folder()</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a>    param_file <span class="op">=</span> folder <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">input</span><span class="sc">.</span>param()<span class="sc">}</span><span class="ss">.png"</span></span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if not param_file.exists():</span></span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     raise FileNotFoundError(f"Missing: {param_file}")</span></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> param_file.exists():</span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>  <span class="co"># silently skip rendering</span></span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(param_file)</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">20</span>))</span>
<span id="cb73-62"><a href="#cb73-62" aria-hidden="true" tabindex="-1"></a>    ax.imshow(img)</span>
<span id="cb73-63"><a href="#cb73-63" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span><span class="bu">input</span><span class="sc">.</span>model()<span class="sc">}</span><span class="ss"> — </span><span class="sc">{</span><span class="bu">input</span><span class="sc">.</span>param()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">"off"</span>)</span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display no-overflow-x">
<div class="shiny-html-output" id="dropdown_model"></div>
</div>
<div class="cell-output cell-output-display no-overflow-x">
<div class="shiny-html-output" id="dropdown_param"></div>
</div>
<div class="cell-output cell-output-display">
<div id="show_plot" class="shiny-image-output html-fill-item shiny-plot-output" style="width:100%;height:400px;"></div><script type="application/json" data-html-dependency="">{"name": "htmltools-fill", "version": "0.5.8.9000", "source": {"package": "shiny", "subdir": "www/shared/htmltools/fill"}, "script": [], "stylesheet": [{"href": "fill.css", "rel": "stylesheet"}], "meta": [], "all_files": false, "head": null}</script>
</div>
</div>
</section>
</section>
<section id="chapter-8-hyperparameter-optimization" class="level1">
<h1>Chapter 8: Hyperparameter Optimization</h1>
<p>In this chapter, we will do hyperparameter optimization to find out the optimal parameters using sklearn's GridSearchCV object.</p>
<div id="dc4852d9" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>candidate_models <span class="op">=</span> {</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"svr"</span>: {</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(max_iter<span class="op">=</span><span class="dv">500</span>))]),</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__C"</span>: [<span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1100</span>],</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__epsilon"</span>: [<span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>],</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__gamma"</span>: [<span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>],</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"extratrees"</span>: {</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'etr'</span>, ExtraTreesRegressor())]),</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__max_depth"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>],</span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_split"</span>: [<span class="dv">2</span>, <span class="dv">5</span>],</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_leaf"</span>: [<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xgboost"</span>: {</span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'xgb'</span>, XGBRegressor())]),</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__max_depth"</span>: [<span class="dv">3</span>, <span class="dv">5</span>],</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__learning_rate"</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>]</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adaboost"</span>: {</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), </span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'ada'</span>, AdaBoostRegressor(DecisionTreeRegressor()))]),</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__learning_rate"</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>]</span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>cv_results_dict <span class="op">=</span> {}</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns"</span>)</span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Hyperparameter_Optimization"</span>)</span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, model_info <span class="kw">in</span> candidate_models.items():</span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_gridsearch"</span>):</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>        estimator <span class="op">=</span> model_info[<span class="st">"estimator"</span>]</span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>        param_grid <span class="op">=</span> model_info[<span class="st">"param_grid"</span>]</span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>        grid <span class="op">=</span> GridSearchCV(</span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>            estimator<span class="op">=</span>estimator,</span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>            param_grid<span class="op">=</span>param_grid,</span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a>            scoring<span class="op">=</span><span class="st">"neg_root_mean_squared_error"</span>,</span>
<span id="cb74-55"><a href="#cb74-55" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>tscv,</span>
<span id="cb74-56"><a href="#cb74-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb74-57"><a href="#cb74-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-58"><a href="#cb74-58" aria-hidden="true" tabindex="-1"></a>        grid.fit(X_train, y_train)</span>
<span id="cb74-59"><a href="#cb74-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-60"><a href="#cb74-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get best model &amp; test set RMSE</span></span>
<span id="cb74-61"><a href="#cb74-61" aria-hidden="true" tabindex="-1"></a>        best_model <span class="op">=</span> grid.best_estimator_</span>
<span id="cb74-62"><a href="#cb74-62" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> best_model.predict(X_test)</span>
<span id="cb74-63"><a href="#cb74-63" aria-hidden="true" tabindex="-1"></a>        test_rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test, y_pred))</span>
<span id="cb74-64"><a href="#cb74-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-65"><a href="#cb74-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log best parameters and test score</span></span>
<span id="cb74-66"><a href="#cb74-66" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(grid.best_params_)</span>
<span id="cb74-67"><a href="#cb74-67" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"train_rmse"</span>, <span class="op">-</span>grid.best_score_)</span>
<span id="cb74-68"><a href="#cb74-68" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"test_rmse"</span>, test_rmse)</span>
<span id="cb74-69"><a href="#cb74-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-70"><a href="#cb74-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save and log cv_results</span></span>
<span id="cb74-71"><a href="#cb74-71" aria-hidden="true" tabindex="-1"></a>        top5 <span class="op">=</span> pd.DataFrame(grid.cv_results_).sort_values(<span class="st">"rank_test_score"</span>).head(<span class="dv">5</span>)</span>
<span id="cb74-72"><a href="#cb74-72" aria-hidden="true" tabindex="-1"></a>        full_df <span class="op">=</span> pd.DataFrame(grid.cv_results_)</span>
<span id="cb74-73"><a href="#cb74-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-74"><a href="#cb74-74" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb74-75"><a href="#cb74-75" aria-hidden="true" tabindex="-1"></a>        top5.to_csv(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/top5.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb74-76"><a href="#cb74-76" aria-hidden="true" tabindex="-1"></a>        full_df.to_csv(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/full.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb74-77"><a href="#cb74-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-78"><a href="#cb74-78" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/top5.csv"</span>)</span>
<span id="cb74-79"><a href="#cb74-79" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/full.csv"</span>)</span>
<span id="cb74-80"><a href="#cb74-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-81"><a href="#cb74-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store top5 for Shiny table view</span></span>
<span id="cb74-82"><a href="#cb74-82" aria-hidden="true" tabindex="-1"></a>        cv_results_dict[model_name] <span class="op">=</span> top5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:50:11 INFO mlflow.tracking.fluent: Experiment with name 'Hyperparameter_Optimization' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>&lt;Experiment: artifact_location='file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns/793644598893004823', creation_time=1755847211592, experiment_id='793644598893004823', last_update_time=1755847211592, lifecycle_stage='active', name='Hyperparameter_Optimization', tags={}&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>GridSearchCV(cv=TimeSeriesSplit(gap=0, max_train_size=None, n_splits=14, test_size=None),
             estimator=Pipeline(steps=[('preprocessor',
                                        ColumnTransformer(remainder='passthrough',
                                                          transformers=[('categoric',
                                                                         OneHotEncoder(handle_unknown='ignore'),
                                                                         ['dist_name']),
                                                                        ('numeric',
                                                                         MinMaxScaler(),
                                                                         ['year',
                                                                          'actual_evapotranspiration',
                                                                          'rice_area',
                                                                          'rice_production',
                                                                          'rice_irrigated_area',
                                                                          'maximum_temperature',
                                                                          'minimum_temperature',
                                                                          'precipitation',
                                                                          'total_kharif',
                                                                          'total_rabi',
                                                                          'water_deficit'])],
                                                          verbose_feature_names_out=False)),
                                       ('svr', SVR(max_iter=500))]),
             param_grid={'svr__C': [800, 1000, 1100],
                         'svr__epsilon': [2, 2.5, 3],
                         'svr__gamma': [1e-05, 0.0001, 0.001]},
             scoring='neg_root_mean_squared_error')</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>GridSearchCV(cv=TimeSeriesSplit(gap=0, max_train_size=None, n_splits=14, test_size=None),
             estimator=Pipeline(steps=[('preprocessor',
                                        ColumnTransformer(remainder='passthrough',
                                                          transformers=[('categoric',
                                                                         OneHotEncoder(handle_unknown='ignore'),
                                                                         ['dist_name']),
                                                                        ('numeric',
                                                                         MinMaxScaler(),
                                                                         ['year',
                                                                          'actual_evapotranspiration',
                                                                          'rice_area',
                                                                          'rice_production',
                                                                          'rice_i...ed_area',
                                                                          'maximum_temperature',
                                                                          'minimum_temperature',
                                                                          'precipitation',
                                                                          'total_kharif',
                                                                          'total_rabi',
                                                                          'water_deficit'])],
                                                          verbose_feature_names_out=False)),
                                       ('etr', ExtraTreesRegressor())]),
             param_grid={'etr__max_depth': [5, 10, 15],
                         'etr__min_samples_leaf': [1, 2],
                         'etr__min_samples_split': [2, 5],
                         'etr__n_estimators': [50, 100]},
             scoring='neg_root_mean_squared_error')</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>GridSearchCV(cv=TimeSeriesSplit(gap=0, max_train_size=None, n_splits=14, test_size=None),
             estimator=Pipeline(steps=[('preprocessor',
                                        ColumnTransformer(remainder='passthrough',
                                                          transformers=[('categoric',
                                                                         OneHotEncoder(handle_unknown='ignore'),
                                                                         ['dist_name']),
                                                                        ('numeric',
                                                                         MinMaxScaler(),
                                                                         ['year',
                                                                          'actual_evapotranspiration',
                                                                          'rice_area',
                                                                          'rice_production',
                                                                          'rice_i...
                                                     max_cat_to_onehot=None,
                                                     max_delta_step=None,
                                                     max_depth=None,
                                                     max_leaves=None,
                                                     min_child_weight=None,
                                                     missing=nan,
                                                     monotone_constraints=None,
                                                     multi_strategy=None,
                                                     n_estimators=None,
                                                     n_jobs=None,
                                                     num_parallel_tree=None, ...))]),
             param_grid={'xgb__learning_rate': [0.05, 0.1],
                         'xgb__max_depth': [3, 5],
                         'xgb__n_estimators': [50, 100]},
             scoring='neg_root_mean_squared_error')</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre><code>GridSearchCV(cv=TimeSeriesSplit(gap=0, max_train_size=None, n_splits=14, test_size=None),
             estimator=Pipeline(steps=[('preprocessor',
                                        ColumnTransformer(remainder='passthrough',
                                                          transformers=[('categoric',
                                                                         OneHotEncoder(handle_unknown='ignore'),
                                                                         ['dist_name']),
                                                                        ('numeric',
                                                                         MinMaxScaler(),
                                                                         ['year',
                                                                          'actual_evapotranspiration',
                                                                          'rice_area',
                                                                          'rice_production',
                                                                          'rice_irrigated_area',
                                                                          'maximum_temperature',
                                                                          'minimum_temperature',
                                                                          'precipitation',
                                                                          'total_kharif',
                                                                          'total_rabi',
                                                                          'water_deficit'])],
                                                          verbose_feature_names_out=False)),
                                       ('ada',
                                        AdaBoostRegressor(estimator=DecisionTreeRegressor()))]),
             param_grid={'ada__learning_rate': [0.05, 0.1, 0.5],
                         'ada__n_estimators': [50, 100]},
             scoring='neg_root_mean_squared_error')</code></pre>
</div>
</div>
</section>
<section id="chapter-8a-hyperparameter-optimization-with-optuna" class="level1">
<h1>Chapter 8a: Hyperparameter Optimization with Optuna</h1>
<div id="0be490a2" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># *** Next: Try with Multi objective hyperparameter optimization in Optuna ***</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optuna</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> optuna_integration.mlflow <span class="im">import</span> MLflowCallback</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Mlflow integration</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>mlflc <span class="op">=</span> MLflowCallback(<span class="st">"file:./mlruns"</span>, metric_name<span class="op">=</span><span class="st">'rmse'</span>)</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective(trial):</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Suggest hyperparameters</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># C = trial.suggest_float('C', 1e0, 1e3, log=True)</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># epsilon = trial.suggest_float('epsilon', 1e-3, 1.0, log=True)</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gamma = trial.suggest_float('gamma', 1e-4, 1e-1, log=True)</span></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kernel = trial.suggest_categorical('kernel', ['rbf', 'poly', 'sigmoid'])</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Define model</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># svr = SVR(C=C, epsilon=epsilon, gamma=gamma, kernel=kernel)</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Build pipeline (reuse your preprocessing steps)</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model_pipeline = Pipeline(steps=[('preprocessor', preprocessor),</span></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                  ('svr', svr)])</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model_pipeline.fit(X_train, y_train)</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_pred = model_pipeline.predict(X_test)</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rmse = np.sqrt(mean_squared_error(y_test, y_pred))</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># with mlflow.start_run(nested=True):</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     mlflow.log_params({</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'C': C, </span></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'epsilon': epsilon,</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'gamma': gamma,</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'kernel': kernel})</span></span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     mlflow.log_metric('rmse', rmse)</span></span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return rmse</span></span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"C"</span>: trial.suggest_float(<span class="st">"C"</span>, <span class="fl">0.1</span>, <span class="dv">100</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb81-40"><a href="#cb81-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epsilon"</span>: trial.suggest_float(<span class="st">"epsilon"</span>, <span class="fl">0.01</span>, <span class="fl">1.0</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb81-41"><a href="#cb81-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gamma"</span>: trial.suggest_float(<span class="st">'gamma'</span>, <span class="fl">1e-4</span>, <span class="fl">1e-1</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb81-42"><a href="#cb81-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kernel"</span>: trial.suggest_categorical(<span class="st">"kernel"</span>, [<span class="st">"rbf"</span>, <span class="st">"poly"</span>, <span class="st">"linear"</span>])</span>
<span id="cb81-43"><a href="#cb81-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb81-44"><a href="#cb81-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb81-45"><a href="#cb81-45" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Pipeline([</span>
<span id="cb81-46"><a href="#cb81-46" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb81-47"><a href="#cb81-47" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'svr'</span>, SVR(<span class="op">**</span>params))</span>
<span id="cb81-48"><a href="#cb81-48" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb81-49"><a href="#cb81-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-50"><a href="#cb81-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rmse</span></span>
<span id="cb81-51"><a href="#cb81-51" aria-hidden="true" tabindex="-1"></a>    rmse_scores <span class="op">=</span> cross_val_score(model, X_train, y_train, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>)</span>
<span id="cb81-52"><a href="#cb81-52" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> <span class="op">-</span>np.mean(rmse_scores)</span>
<span id="cb81-53"><a href="#cb81-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-54"><a href="#cb81-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mae</span></span>
<span id="cb81-55"><a href="#cb81-55" aria-hidden="true" tabindex="-1"></a>    mae_scores <span class="op">=</span> cross_val_score(model, X_train, y_train,cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span> )</span>
<span id="cb81-56"><a href="#cb81-56" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> <span class="op">-</span>np.mean(mae_scores)</span>
<span id="cb81-57"><a href="#cb81-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-58"><a href="#cb81-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rmse, mae</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9693d455" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>study <span class="op">=</span> optuna.create_study(directions<span class="op">=</span>[<span class="st">'minimize'</span>, <span class="st">'minimize'</span>],</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>                            study_name<span class="op">=</span><span class="st">'SVR Optimization'</span>, </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>                            storage<span class="op">=</span><span class="st">"sqlite:///./optuna_svr.sqlite3"</span>,  </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>                            load_if_exists<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>study.optimize(objective, n_trials<span class="op">=</span><span class="dv">30</span>, callbacks<span class="op">=</span>[mlflc])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2025-08-22 12:52:31,814] A new study created in RDB with name: SVR Optimization
[I 2025-08-22 12:52:32,567] Trial 0 finished with values: [895.9106120603592, 696.6141316857581] and parameters: {'C': 4.4923760272482305, 'epsilon': 0.04497826568919457, 'gamma': 0.0011970447387752957, 'kernel': 'linear'}.
2025/08/22 12:52:32 INFO mlflow.tracking.fluent: Experiment with name 'SVR Optimization' does not exist. Creating a new experiment.
[I 2025-08-22 12:52:33,790] Trial 1 finished with values: [919.4188751569822, 716.6945669256763] and parameters: {'C': 0.29701135523161487, 'epsilon': 0.0837745288650821, 'gamma': 0.041506198757357636, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:34,657] Trial 2 finished with values: [889.9692118021433, 691.7168676559376] and parameters: {'C': 5.736488945738708, 'epsilon': 0.333421916936164, 'gamma': 0.006279325871459797, 'kernel': 'linear'}.
[I 2025-08-22 12:52:35,922] Trial 3 finished with values: [915.123402887098, 713.045396377169] and parameters: {'C': 38.550444031957426, 'epsilon': 0.01002531738268937, 'gamma': 0.01096437275440613, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:36,916] Trial 4 finished with values: [919.5391628537184, 716.7971650038745] and parameters: {'C': 0.12176655486472404, 'epsilon': 0.1993879837546672, 'gamma': 0.0004169628718097847, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:37,676] Trial 5 finished with values: [919.5361255410331, 716.7947336025014] and parameters: {'C': 74.16192936164403, 'epsilon': 0.017045159752858755, 'gamma': 0.006212675287061333, 'kernel': 'poly'}.
[I 2025-08-22 12:52:38,713] Trial 6 finished with values: [919.5396941535577, 716.7976186872704] and parameters: {'C': 1.200366940612678, 'epsilon': 0.066328726455608, 'gamma': 0.0012276398799944493, 'kernel': 'poly'}.
[I 2025-08-22 12:52:39,591] Trial 7 finished with values: [919.5383416437342, 716.7965252413662] and parameters: {'C': 0.2564020985959266, 'epsilon': 0.059711905386188986, 'gamma': 0.02973543730037146, 'kernel': 'poly'}.
[I 2025-08-22 12:52:40,441] Trial 8 finished with values: [916.310991333172, 714.0093012598271] and parameters: {'C': 16.813402861596913, 'epsilon': 0.011144118465510193, 'gamma': 0.01801303942988479, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:41,257] Trial 9 finished with values: [919.5396943359557, 716.7976188347309] and parameters: {'C': 3.6530922832781876, 'epsilon': 0.01259788130245981, 'gamma': 0.000710828791943724, 'kernel': 'poly'}.
[I 2025-08-22 12:52:42,038] Trial 10 finished with values: [915.9541881526935, 713.6964827747481] and parameters: {'C': 18.9849562328169, 'epsilon': 0.08190516755118508, 'gamma': 0.018008581658543577, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:43,001] Trial 11 finished with values: [919.5396945830993, 716.7976190345352] and parameters: {'C': 71.5835635336594, 'epsilon': 0.014838324603821068, 'gamma': 0.00010405074298325236, 'kernel': 'poly'}.
[I 2025-08-22 12:52:43,835] Trial 12 finished with values: [919.5396945583163, 716.7976190144993] and parameters: {'C': 0.4141676957660803, 'epsilon': 0.234386226397098, 'gamma': 0.0007898985827702733, 'kernel': 'poly'}.
[I 2025-08-22 12:52:44,604] Trial 13 finished with values: [919.4923849435324, 716.7572285080462] and parameters: {'C': 0.1919009960493401, 'epsilon': 0.18395348755974267, 'gamma': 0.024408894487605106, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:45,534] Trial 14 finished with values: [918.1279927745137, 715.6075459487105] and parameters: {'C': 0.24705218121795455, 'epsilon': 0.06535341440010276, 'gamma': 0.0024874615706825414, 'kernel': 'linear'}.
[I 2025-08-22 12:52:46,612] Trial 15 finished with values: [919.5396945952019, 716.7976190443196] and parameters: {'C': 0.7718203714023346, 'epsilon': 0.7614453188515508, 'gamma': 0.00029756228683959827, 'kernel': 'poly'}.
[I 2025-08-22 12:52:47,328] Trial 16 finished with values: [911.7973529971135, 710.3479440979143] and parameters: {'C': 1.464012069542302, 'epsilon': 0.023472341116158913, 'gamma': 0.0015026260910777313, 'kernel': 'linear'}.
[I 2025-08-22 12:52:48,069] Trial 17 finished with values: [919.1488435476734, 716.4707232143455] and parameters: {'C': 1.3461747008966454, 'epsilon': 0.14673989658118058, 'gamma': 0.029149102763561203, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:48,945] Trial 18 finished with values: [919.2764245117321, 716.5762008013589] and parameters: {'C': 1.6874502639608444, 'epsilon': 0.028630766924754598, 'gamma': 0.015341826803322195, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:49,784] Trial 19 finished with values: [740.3623821375561, 575.8301520486535] and parameters: {'C': 76.79289665567111, 'epsilon': 0.05276636876973586, 'gamma': 0.0013719168476484284, 'kernel': 'linear'}.
[I 2025-08-22 12:52:50,553] Trial 20 finished with values: [918.9695808397018, 716.3232597849659] and parameters: {'C': 0.10904090187694368, 'epsilon': 0.012380263264019167, 'gamma': 0.045707469000961856, 'kernel': 'linear'}.
[I 2025-08-22 12:52:51,235] Trial 21 finished with values: [904.1485552371635, 703.6046938267713] and parameters: {'C': 2.8511496264317167, 'epsilon': 0.010603023971754529, 'gamma': 0.00010490571616910243, 'kernel': 'linear'}.
[I 2025-08-22 12:52:51,930] Trial 22 finished with values: [913.2854241637336, 711.5469682863695] and parameters: {'C': 1.175067694418657, 'epsilon': 0.4022572689673282, 'gamma': 0.0023794192857792378, 'kernel': 'linear'}.
[I 2025-08-22 12:52:52,690] Trial 23 finished with values: [919.4017245539644, 716.6798259034213] and parameters: {'C': 42.676688457778525, 'epsilon': 0.022566670726537567, 'gamma': 0.0003107411732351437, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:53,366] Trial 24 finished with values: [828.6048055778583, 640.609746387788] and parameters: {'C': 22.887958223458334, 'epsilon': 0.028708528874488746, 'gamma': 0.0008064004282169123, 'kernel': 'linear'}.
[I 2025-08-22 12:52:54,206] Trial 25 finished with values: [916.956426112217, 714.5735274247079] and parameters: {'C': 0.45010501418828613, 'epsilon': 0.019664167746338897, 'gamma': 0.0002832112318170788, 'kernel': 'linear'}.
[I 2025-08-22 12:52:55,275] Trial 26 finished with values: [919.530268570053, 716.7895708551035] and parameters: {'C': 0.12344782122711608, 'epsilon': 0.12230364211792326, 'gamma': 0.0073675416796940615, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:56,430] Trial 27 finished with values: [918.938301393817, 716.2971735118164] and parameters: {'C': 0.11496764366070912, 'epsilon': 0.05776860422683135, 'gamma': 0.00653594056692399, 'kernel': 'linear'}.
[I 2025-08-22 12:52:57,324] Trial 28 finished with values: [919.4982224151415, 716.7622198132185] and parameters: {'C': 0.1044715723823838, 'epsilon': 0.2997297012024443, 'gamma': 0.0402531765215886, 'kernel': 'rbf'}.
[I 2025-08-22 12:52:57,970] Trial 29 finished with values: [916.6152741540626, 714.2743686395901] and parameters: {'C': 0.5240018903951176, 'epsilon': 0.5451036429725312, 'gamma': 0.00038150869899221965, 'kernel': 'linear'}.</code></pre>
</div>
</div>
<div id="b029a20a" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="co"># best_params = study.best_trial.params</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>best_params <span class="op">=</span> <span class="bu">min</span>(study.best_trials, key<span class="op">=</span><span class="kw">lambda</span> t: t.values[<span class="dv">0</span>]).params <span class="co"># Choosing `rmse` to choose best parameters</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co"># print("Selected trial params:", best_by_rmse.params)</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Train Best Model from Optuna</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(<span class="op">**</span>best_params))])</span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>best_model.fit(X_train, y_train)</span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Log &amp; Register Best Model in MLflow</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Optuna Best SVR"</span>)</span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"SVR_Optuna_Best"</span>):</span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>    mlflow.log_params(best_params)</span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> best_model.predict(X_train)</span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_train, preds))</span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(y_train, preds)</span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"mae"</span>, mae)</span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log model</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>    mlflow.sklearn.log_model(</span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>        artifact_path<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>        sk_model<span class="op">=</span>best_model,</span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>        registered_model_name<span class="op">=</span><span class="st">"Best_SVR"</span>  <span class="co"># model registry name</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Best model registered in MLflow as 'RiceYield_SVR'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('categoric',
                                                  OneHotEncoder(handle_unknown='ignore'),
                                                  ['dist_name']),
                                                 ('numeric', MinMaxScaler(),
                                                  ['year',
                                                   'actual_evapotranspiration',
                                                   'rice_area',
                                                   'rice_production',
                                                   'rice_irrigated_area',
                                                   'maximum_temperature',
                                                   'minimum_temperature',
                                                   'precipitation',
                                                   'total_kharif', 'total_rabi',
                                                   'water_deficit'])],
                                   verbose_feature_names_out=False)),
                ('svr',
                 SVR(C=76.79289665567111, epsilon=0.05276636876973586,
                     gamma=0.0013719168476484284, kernel='linear'))])</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:52:58 INFO mlflow.tracking.fluent: Experiment with name 'Optuna Best SVR' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>&lt;Experiment: artifact_location='file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns/667955242113605719', creation_time=1755847378180, experiment_id='667955242113605719', last_update_time=1755847378180, lifecycle_stage='active', name='Optuna Best SVR', tags={}&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:52:58 WARNING mlflow.models.model: `artifact_path` is deprecated. Please use `name` instead.
2025/08/22 12:53:06 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.
Successfully registered model 'Best_SVR'.
Created version '1' of model 'Best_SVR'.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>&lt;mlflow.models.model.ModelInfo at 0x18434212c60&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Best model registered in MLflow as 'RiceYield_SVR'</code></pre>
</div>
</div>
</section>
<section id="chapter-8b-hyperoptimization-of-all-models-using-optuna" class="level1">
<h1>Chapter 8b: Hyperoptimization of all models using Optuna</h1>
<section id="logging-dataset" class="level2">
<h2 class="anchored" data-anchor-id="logging-dataset">Logging Dataset</h2>
<div id="c65fc7cf" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>dataset_path <span class="op">=</span> <span class="st">"C:/Users/DELL/Desktop/crop_yield/data/combined_file/combined.csv"</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternate: ..\\data\\combined_file\\combined.cs</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(dataset_path)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataset registration experiment</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Dataset_Registration"</span>)</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"Dataset_v1"</span>) <span class="im">as</span> dataset_run:</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(dataset_path, artifact_path<span class="op">=</span><span class="st">"dataset"</span>)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tag(<span class="st">"dataset_version"</span>, <span class="st">"v1"</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tag(<span class="st">"description"</span>, <span class="st">"Cleaned dataset used for all model training"</span>)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    dataset_run_id <span class="op">=</span> dataset_run.info.run_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:53:06 INFO mlflow.tracking.fluent: Experiment with name 'Dataset_Registration' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>&lt;Experiment: artifact_location='file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns/877377042357253728', creation_time=1755847386832, experiment_id='877377042357253728', last_update_time=1755847386832, lifecycle_stage='active', name='Dataset_Registration', tags={}&gt;</code></pre>
</div>
</div>
<div id="20ed8db2" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_svr(trial):</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co">#         "C": trial.suggest_float("C", 0.1, 100, log=True),</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="co">#         "epsilon": trial.suggest_float("epsilon", 0.01, 1.0, log=True),</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float('gamma', 1e-4, 1e-1, log=True),</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         "kernel": trial.suggest_categorical("kernel", ["rbf", "poly", "linear"])</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('preprocessor', preprocessor),</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('svr', SVR(**params))</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     ])</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_etr(trial):</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {"n_estimators": trial.suggest_int("n_estimators", 100, 1000),</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a><span class="co">#               "max_features": trial.suggest_float("max_features", 0.1, 1.0),</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a><span class="co">#               "min_samples_split": trial.suggest_float("min_samples_split", 0.1, 1.0),</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="co">#               "min_samples_leaf": trial.suggest_float("min_samples_leaf", 0.01, 0.5)</span></span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a><span class="co">#               }</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([('preprocessor', preprocessor),</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a><span class="co">#                       ('etr', ExtraTreesRegressor(**params))])</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_xgb(trial):</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a><span class="co">#         "max_depth": trial.suggest_int("max_depth", 3, 15),</span></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a><span class="co">#         "n_estimators": trial.suggest_int("n_estimators", 100, 1000),</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="co">#         "learning_rate": trial.suggest_float("learning_rate", 0.01, 0.3),</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="co">#         "subsample": trial.suggest_float("subsample", 0.5, 1.0),</span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a><span class="co">#         "colsample_bytree": trial.suggest_float("colsample_bytree", 0.5, 1.0),</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float("gamma", 0.0, 5.0)</span></span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([('preprocessor', preprocessor),</span></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a><span class="co">#                       ('xgb', XGBRegressor(**params))])</span></span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_ada(trial):</span></span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a><span class="co">#         "n_estimators": trial.suggest_int("n_estimators", 50, 500),</span></span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a><span class="co">#         "learning_rate": trial.suggest_float("learning_rate", 0.01, 2.0),</span></span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a><span class="co">#         "loss": trial.suggest_categorical("loss", ["linear", "square", "exponential"])</span></span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([('preprocessor', preprocessor),</span></span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a><span class="co">#                       ('ada', AdaBoostRegressor(**params))])</span></span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3ad838bb" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># models_objectives = {</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     "svr": objective_svr, # We want to specify how to set params in `sklearn`</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     "etr": objective_etr,</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     "xgb": objective_xgb,</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     "ada": objective_ada</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="co"># os.makedirs("optuna_studies", exist_ok=True)</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="co"># # Loop through each model and optimize</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="co"># for model_name, objective  in models_objectives.items():</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Optimizing {model_name}...")</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     storage_path = f"sqlite:///./optuna_studies/{model_name}.sqlite3"</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     study = optuna.create_study(direction="minimize", storage=storage_path, study_name=model_name, load_if_exists=True)</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     study.optimize(objective, n_trials=30)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="515b32a9" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mlflow.set_experiment('SVR_Optuna_Hyperparameter_Optimization')</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_svr_(trial):</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co">#         "C": trial.suggest_float("C", 0.1, 100, log=True),</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co">#         "epsilon": trial.suggest_float("epsilon", 0.01, 1.0, log=True),</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float('gamma', 1e-4, 1e-1, log=True),</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         "kernel": trial.suggest_categorical("kernel", ["rbf", "poly", "linear"])</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     with mlflow.start_run(run_name=f"trial {trial.number}", nested=True) as run:</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co">#         # Regiser data for each trial</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         dataset_source = "data\combined_file\combined.csv"  # your dataset path</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, name="Rice_Yield_Training_Data", targets="rice_yield")</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_input(train_dataset, context="training")</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="co">#         trial.set_user_attr("mlflow_run_id", run.info.run_id) # Logging `run_id` on Optuna</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.set_tag("trial_number", trial.number) # Logging `trial number` on MLflow</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a><span class="co">#         model = Pipeline([</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('preprocessor', preprocessor),</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('svr', SVR(**params))</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co">#         ])</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a><span class="co">#         # rmse</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a><span class="co">#         rmse_scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         rmse = -np.mean(rmse_scores)</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         # mae</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         mae_scores = cross_val_score(model, X_train, y_train,cv=tscv, scoring='neg_mean_absolute_error' )</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a><span class="co">#         mae = -np.mean(mae_scores)</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_metric('rmse', rmse)</span></span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_metric('mae', mae)</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_params(params)</span></span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.sklearn.log_model(model, name='model', input_example=X_train.iloc[:5])</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     return rmse</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cef8ce86" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==== Parent run ====</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># with mlflow.start_run(run_name="Optuna_Optimization_SVR") as parent_run:</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Example: log train data</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Register Dataset</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     dataset_source = "data\combined_file\combined.csv"  # your dataset path</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, name="Rice_Yield_Train_Data")</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     # test_dataset = mlflow.data.from_pandas(X_test, source=dataset_source, name="Rice_Yield_Test_Data")</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_input(train_dataset, context="train")</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     # mlflow.log_input(test_dataset, context="testing")</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Create study</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     study = optuna.create_study(study_name="SVR Trials", direction="minimize", storage="sqlite:///./optuna_svr_opt.sqlite3")</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Optimize trials (logged as nested runs)</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     study.optimize(objective_svr_, n_trials=10)</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Best trial</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     best_trial = study.best_trial</span></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     best_run_id = best_trial.user_attrs["mlflow_run_id"]</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("\nBest trial number:", best_trial.number)</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("Best RMSE:", best_trial.value)</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("Best params:", best_trial.params)</span></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("Best trial MLflow run:", best_run_id)</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     # ==== Retrain best model on full training data ====</span></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_model = Pipeline(steps=[('preprocessor', preprocessor), ('svr', SVR(**best_params))])</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_model.fit(X_train, y_train)</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     preds = final_model.predict(X_test)</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_rmse = np.sqrt(mean_squared_error(y_test, preds))</span></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     # === Model signature ===</span></span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     # signature = infer_signature(X_train, final_model.predict(X_train))</span></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     # ==== Log final model in top-level run ====</span></span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.set_tag("best_trial_number", best_trial.number)</span></span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_params(best_trial.params)</span></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_metric("final_rmse", final_rmse)</span></span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.sklearn.log_model(final_model, </span></span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a><span class="co">#                              name="best_final_model", </span></span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a><span class="co">#                              input_example=X_train.iloc[:5],</span></span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a><span class="co">#                              registered_model_name='Best SVR Model')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="chapter-8c-all-models" class="level1">
<h1>Chapter 8c: All models</h1>
<div id="b157d70c" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Common MLflow experiment</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># mlflow.set_experiment("Rice_Yield_Optuna_HPO")</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># # Dictionary of candidate models and their search spaces</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># model_spaces = {</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     "SVR": lambda trial: {</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         "C": trial.suggest_float("C", 0.1, 100, log=True),</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">#         "epsilon": trial.suggest_float("epsilon", 0.01, 1.0, log=True),</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float('gamma', 1e-4, 1e-1, log=True),</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         "kernel": trial.suggest_categorical("kernel", ["rbf", "poly", "linear"])</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     },</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     "AdaBoost": lambda trial: {</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="co">#         "n_estimators": trial.suggest_int("n_estimators", 50, 200, step=50),</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co">#         "learning_rate": trial.suggest_float("learning_rate", 0.01, 1.0, log=True)</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co"># # Mapping model name → actual sklearn class</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co"># model_classes = {</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     "SVR": SVR,</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     "AdaBoost": AdaBoostRegressor</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a><span class="co"># # Reusable objective factory</span></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="co"># def make_objective(model_name):</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     def objective(trial):</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         params = model_spaces[model_name](trial)</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a><span class="co">#         with mlflow.start_run(run_name=f"{model_name}_trial_{trial.number}", nested=True) as run:</span></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a><span class="co">#             # Register dataset (once per trial for traceability)</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a><span class="co">#             dataset_source = "C:/Users/DELL/Desktop/crop_yield/data/combined_file/combined.csv"</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a><span class="co">#             train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, </span></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                     name="Rice_Yield_Training_Data", </span></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                     targets="rice_yield")</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_input(train_dataset, context="training")</span></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a><span class="co">#             trial.set_user_attr("mlflow_run_id", run.info.run_id)</span></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.set_tag("trial_number", trial.number)</span></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.set_tag("model_name", model_name)</span></span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a><span class="co">#             model = Pipeline([</span></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a><span class="co">#                 ("preprocessor", preprocessor),</span></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a><span class="co">#                 (model_name.lower(), model_classes[model_name](**params))</span></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a><span class="co">#             ])</span></span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a><span class="co">#             # RMSE</span></span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a><span class="co">#             rmse_scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring="neg_root_mean_squared_error")</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a><span class="co">#             rmse = -np.mean(rmse_scores)</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a><span class="co">#             # MAE</span></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a><span class="co">#             mae_scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring="neg_mean_absolute_error")</span></span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a><span class="co">#             mae = -np.mean(mae_scores)</span></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_metric("rmse", rmse)</span></span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_metric("mae", mae)</span></span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_params(params)</span></span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.sklearn.log_model(model, name="model", input_example=X_train.iloc[:5])</span></span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a><span class="co">#         return rmse</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a><span class="co">#     return objective</span></span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a><span class="co"># # ==== Parent run for ALL models ====</span></span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a><span class="co"># with mlflow.start_run(run_name="Optuna_HPO_All_Models") as parent_run:</span></span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a><span class="co">#     dataset_source = "data/combined_file/combined.csv"</span></span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, name="Rice_Yield_Train_Data")</span></span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_input(train_dataset, context="train")</span></span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a><span class="co">#     for model_name in model_spaces.keys():</span></span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a><span class="co">#         study = optuna.create_study(</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a><span class="co">#             study_name=f"{model_name}_Trials",</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a><span class="co">#             direction="minimize",</span></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a><span class="co">#             storage="sqlite:///./optuna_all_models.sqlite3",  # Shared DB</span></span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a><span class="co">#             load_if_exists=True</span></span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a><span class="co">#         study.optimize(make_objective(model_name), n_trials=10)</span></span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a><span class="co">#         best_trial = study.best_trial</span></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a><span class="co">#         best_run_id = best_trial.user_attrs["mlflow_run_id"]</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a><span class="co">#         print(f"\nModel: {model_name}")</span></span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best trial number:", best_trial.number)</span></span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best RMSE:", best_trial.value)</span></span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best params:", best_trial.params)</span></span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best trial MLflow run:", best_run_id)</span></span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a><span class="co">#         # Retrain best model</span></span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a><span class="co">#         final_model = Pipeline([</span></span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a><span class="co">#             ("preprocessor", preprocessor),</span></span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a><span class="co">#             (model_name.lower(), model_classes[model_name](**best_trial.params))</span></span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a><span class="co">#         ])</span></span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a><span class="co">#         final_model.fit(X_train, y_train)</span></span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a><span class="co">#         preds = final_model.predict(X_test)</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a><span class="co">#         final_rmse = np.sqrt(mean_squared_error(y_test, preds))</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.set_tag(f"{model_name}_best_trial_number", best_trial.number)</span></span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_params({f"{model_name}_{k}": v for k, v in best_trial.params.items()})</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_metric(f"{model_name}_final_rmse", final_rmse)</span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.sklearn.log_model(final_model, </span></span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  name=f"{model_name}_best_final_model", </span></span>
<span id="cb98-102"><a href="#cb98-102" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  input_example=X_train.iloc[:5],</span></span>
<span id="cb98-103"><a href="#cb98-103" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  registered_model_name=f"Best_{model_name}_Model")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="687b8a49" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Rice_Yield_Optuna_HPO"</span>)</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co"># === Candidate models and their search spaces ===</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>search_spaces <span class="op">=</span> {</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SVR"</span>: {</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_class"</span>: SVR,</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: <span class="kw">lambda</span> trial: {</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"C"</span>: trial.suggest_float(<span class="st">"C"</span>, <span class="fl">0.1</span>, <span class="dv">100</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"epsilon"</span>: trial.suggest_float(<span class="st">"epsilon"</span>, <span class="fl">0.01</span>, <span class="fl">1.0</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"gamma"</span>: trial.suggest_float(<span class="st">"gamma"</span>, <span class="fl">1e-4</span>, <span class="fl">1e-1</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"kernel"</span>: trial.suggest_categorical(<span class="st">"kernel"</span>, [<span class="st">"rbf"</span>, <span class="st">"poly"</span>, <span class="st">"linear"</span>])</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RandomForest"</span>: {</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_class"</span>: RandomForestRegressor,</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: <span class="kw">lambda</span> trial: {</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_estimators"</span>: trial.suggest_int(<span class="st">"n_estimators"</span>, <span class="dv">50</span>, <span class="dv">200</span>),</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_depth"</span>: trial.suggest_int(<span class="st">"max_depth"</span>, <span class="dv">3</span>, <span class="dv">15</span>),</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"min_samples_split"</span>: trial.suggest_int(<span class="st">"min_samples_split"</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"XGB"</span>: {</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_class"</span>: XGBRegressor,</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: <span class="kw">lambda</span> trial: {</span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_estimators"</span>: trial.suggest_int(<span class="st">"n_estimators"</span>, <span class="dv">50</span>, <span class="dv">200</span>),</span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_depth"</span>: trial.suggest_int(<span class="st">"max_depth"</span>, <span class="dv">3</span>, <span class="dv">10</span>),</span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"learning_rate"</span>: trial.suggest_float(<span class="st">"learning_rate"</span>, <span class="fl">0.01</span>, <span class="fl">0.3</span>, log<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_objective(model_name, model_class, param_fn):</span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> objective(trial):</span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a>        params <span class="op">=</span> param_fn(trial)</span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_trial_</span><span class="sc">{</span>trial<span class="sc">.</span>number<span class="sc">}</span><span class="ss">"</span>, nested<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> run:</span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a>            trial.set_user_attr(<span class="st">"mlflow_run_id"</span>, run.info.run_id)</span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> Pipeline([</span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a>                (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a>                (model_name.lower(), model_class(<span class="op">**</span>params))</span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># cross-val metrics</span></span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a>            rmse_scores <span class="op">=</span> cross_val_score(model, X_train, y_train, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">"neg_root_mean_squared_error"</span>)</span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a>            rmse <span class="op">=</span> <span class="op">-</span>np.mean(rmse_scores)</span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a>            mae_scores <span class="op">=</span> cross_val_score(model, X_train, y_train, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">"neg_mean_absolute_error"</span>)</span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a>            mae <span class="op">=</span> <span class="op">-</span>np.mean(mae_scores)</span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(params)</span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a>            mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a>            mlflow.log_metric(<span class="st">"mae"</span>, mae)</span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rmse</span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> objective</span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a>best_models <span class="op">=</span> {}</span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-62"><a href="#cb99-62" aria-hidden="true" tabindex="-1"></a><span class="co"># === Loop over candidate models ===</span></span>
<span id="cb99-63"><a href="#cb99-63" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, cfg <span class="kw">in</span> search_spaces.items():</span>
<span id="cb99-64"><a href="#cb99-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_Optimization"</span>) <span class="im">as</span> parent_run:</span>
<span id="cb99-65"><a href="#cb99-65" aria-hidden="true" tabindex="-1"></a>        study <span class="op">=</span> optuna.create_study(</span>
<span id="cb99-66"><a href="#cb99-66" aria-hidden="true" tabindex="-1"></a>            study_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_Study"</span>,</span>
<span id="cb99-67"><a href="#cb99-67" aria-hidden="true" tabindex="-1"></a>            direction<span class="op">=</span><span class="st">"minimize"</span>,</span>
<span id="cb99-68"><a href="#cb99-68" aria-hidden="true" tabindex="-1"></a>            storage<span class="op">=</span><span class="ss">f"sqlite:///./optuna_models.sqlite3"</span></span>
<span id="cb99-69"><a href="#cb99-69" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb99-70"><a href="#cb99-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-71"><a href="#cb99-71" aria-hidden="true" tabindex="-1"></a>        study.optimize(make_objective(model_name, cfg[<span class="st">"model_class"</span>], cfg[<span class="st">"params"</span>]), n_trials<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb99-72"><a href="#cb99-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-73"><a href="#cb99-73" aria-hidden="true" tabindex="-1"></a>        best_trial <span class="op">=</span> study.best_trial</span>
<span id="cb99-74"><a href="#cb99-74" aria-hidden="true" tabindex="-1"></a>        best_run_id <span class="op">=</span> best_trial.user_attrs[<span class="st">"mlflow_run_id"</span>]</span>
<span id="cb99-75"><a href="#cb99-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-76"><a href="#cb99-76" aria-hidden="true" tabindex="-1"></a>        mlflow.set_tag(<span class="st">"best_trial_number"</span>, best_trial.number)</span>
<span id="cb99-77"><a href="#cb99-77" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_trial.params)</span>
<span id="cb99-78"><a href="#cb99-78" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"best_rmse"</span>, best_trial.value)</span>
<span id="cb99-79"><a href="#cb99-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-80"><a href="#cb99-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Retrain best model</span></span>
<span id="cb99-81"><a href="#cb99-81" aria-hidden="true" tabindex="-1"></a>        best_model <span class="op">=</span> Pipeline([</span>
<span id="cb99-82"><a href="#cb99-82" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb99-83"><a href="#cb99-83" aria-hidden="true" tabindex="-1"></a>            (model_name.lower(), cfg[<span class="st">"model_class"</span>](<span class="op">**</span>best_trial.params))</span>
<span id="cb99-84"><a href="#cb99-84" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb99-85"><a href="#cb99-85" aria-hidden="true" tabindex="-1"></a>        best_model.fit(X_train, y_train)</span>
<span id="cb99-86"><a href="#cb99-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-87"><a href="#cb99-87" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> best_model.predict(X_test)</span>
<span id="cb99-88"><a href="#cb99-88" aria-hidden="true" tabindex="-1"></a>        final_rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test, preds))</span>
<span id="cb99-89"><a href="#cb99-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-90"><a href="#cb99-90" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"final_rmse"</span>, final_rmse)</span>
<span id="cb99-91"><a href="#cb99-91" aria-hidden="true" tabindex="-1"></a>        mlflow.sklearn.log_model(</span>
<span id="cb99-92"><a href="#cb99-92" aria-hidden="true" tabindex="-1"></a>            best_model,</span>
<span id="cb99-93"><a href="#cb99-93" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_final_model"</span>,</span>
<span id="cb99-94"><a href="#cb99-94" aria-hidden="true" tabindex="-1"></a>            input_example<span class="op">=</span>X_train.iloc[:<span class="dv">5</span>],</span>
<span id="cb99-95"><a href="#cb99-95" aria-hidden="true" tabindex="-1"></a>            registered_model_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_Best_Model"</span></span>
<span id="cb99-96"><a href="#cb99-96" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb99-97"><a href="#cb99-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-98"><a href="#cb99-98" aria-hidden="true" tabindex="-1"></a>        best_models[model_name] <span class="op">=</span> {</span>
<span id="cb99-99"><a href="#cb99-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rmse"</span>: final_rmse,</span>
<span id="cb99-100"><a href="#cb99-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">"params"</span>: best_trial.params,</span>
<span id="cb99-101"><a href="#cb99-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mlflow_run_id"</span>: parent_run.info.run_id</span>
<span id="cb99-102"><a href="#cb99-102" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb99-103"><a href="#cb99-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-104"><a href="#cb99-104" aria-hidden="true" tabindex="-1"></a>        <span class="co"># === Inside your loop, after training best_model and evaluating ===</span></span>
<span id="cb99-105"><a href="#cb99-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save the retrained best model locally</span></span>
<span id="cb99-106"><a href="#cb99-106" aria-hidden="true" tabindex="-1"></a>        model_filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_best_model.pkl"</span></span>
<span id="cb99-107"><a href="#cb99-107" aria-hidden="true" tabindex="-1"></a>        joblib.dump(best_model, model_filename)</span>
<span id="cb99-108"><a href="#cb99-108" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> best model as </span><span class="sc">{</span>model_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb99-109"><a href="#cb99-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-110"><a href="#cb99-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-111"><a href="#cb99-111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Summary of best models:"</span>)</span>
<span id="cb99-112"><a href="#cb99-112" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(best_models)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2025/08/22 12:53:07 INFO mlflow.tracking.fluent: Experiment with name 'Rice_Yield_Optuna_HPO' does not exist. Creating a new experiment.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>&lt;Experiment: artifact_location='file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns/489070748757225041', creation_time=1755847387142, experiment_id='489070748757225041', last_update_time=1755847387142, lifecycle_stage='active', name='Rice_Yield_Optuna_HPO', tags={}&gt;</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2025-08-22 12:53:07,657] A new study created in RDB with name: SVR_Study
[I 2025-08-22 12:53:08,917] Trial 0 finished with value: 919.5389846775137 and parameters: {'C': 78.1317804745043, 'epsilon': 0.015309010789904357, 'gamma': 0.0035640822121832394, 'kernel': 'poly'}. Best is trial 0 with value: 919.5389846775137.
[I 2025-08-22 12:53:09,621] Trial 1 finished with value: 905.5876625299976 and parameters: {'C': 2.6018455544683654, 'epsilon': 0.04766127010443026, 'gamma': 0.0008295594786462055, 'kernel': 'linear'}. Best is trial 1 with value: 905.5876625299976.
[I 2025-08-22 12:53:10,368] Trial 2 finished with value: 919.5396753087362 and parameters: {'C': 0.8353496820880091, 'epsilon': 0.01716641891936428, 'gamma': 0.004863832670452816, 'kernel': 'poly'}. Best is trial 1 with value: 905.5876625299976.
[I 2025-08-22 12:53:11,463] Trial 3 finished with value: 919.5381927559401 and parameters: {'C': 0.12202345739626919, 'epsilon': 0.2966962009510897, 'gamma': 0.0011765232900683286, 'kernel': 'rbf'}. Best is trial 1 with value: 905.5876625299976.
[I 2025-08-22 12:53:12,280] Trial 4 finished with value: 913.9536376692361 and parameters: {'C': 11.741904109573166, 'epsilon': 0.14708429757769625, 'gamma': 0.04836486338138776, 'kernel': 'rbf'}. Best is trial 1 with value: 905.5876625299976.
[I 2025-08-22 12:53:12,950] Trial 5 finished with value: 901.6269209953952 and parameters: {'C': 3.314045936661498, 'epsilon': 0.1767592120909914, 'gamma': 0.0017654577198250741, 'kernel': 'linear'}. Best is trial 5 with value: 901.6269209953952.
[I 2025-08-22 12:53:13,576] Trial 6 finished with value: 898.5646411875802 and parameters: {'C': 3.9089387777818643, 'epsilon': 0.014794650975612483, 'gamma': 0.00013187817398601807, 'kernel': 'linear'}. Best is trial 6 with value: 898.5646411875802.
[I 2025-08-22 12:53:14,255] Trial 7 finished with value: 919.5303670603372 and parameters: {'C': 6.0849856894651735, 'epsilon': 0.5107817037043144, 'gamma': 0.01969362302358275, 'kernel': 'poly'}. Best is trial 6 with value: 898.5646411875802.
[I 2025-08-22 12:53:14,927] Trial 8 finished with value: 753.3763460118186 and parameters: {'C': 65.531491610807, 'epsilon': 0.08480690124616108, 'gamma': 0.0003349748444500705, 'kernel': 'linear'}. Best is trial 8 with value: 753.3763460118186.
[I 2025-08-22 12:53:15,807] Trial 9 finished with value: 736.4643859578937 and parameters: {'C': 81.21922888388735, 'epsilon': 0.08010931300870007, 'gamma': 0.000640551217856536, 'kernel': 'linear'}. Best is trial 9 with value: 736.4643859578937.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('categoric',
                                                  OneHotEncoder(handle_unknown='ignore'),
                                                  ['dist_name']),
                                                 ('numeric', MinMaxScaler(),
                                                  ['year',
                                                   'actual_evapotranspiration',
                                                   'rice_area',
                                                   'rice_production',
                                                   'rice_irrigated_area',
                                                   'maximum_temperature',
                                                   'minimum_temperature',
                                                   'precipitation',
                                                   'total_kharif', 'total_rabi',
                                                   'water_deficit'])],
                                   verbose_feature_names_out=False)),
                ('svr',
                 SVR(C=81.21922888388735, epsilon=0.08010931300870007,
                     gamma=0.000640551217856536, kernel='linear'))])</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"324290c6762f440e91be680a040b15d2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Successfully registered model 'SVR_Best_Model'.
Created version '1' of model 'SVR_Best_Model'.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>&lt;mlflow.models.model.ModelInfo at 0x1845b77ecc0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>['SVR_best_model.pkl']</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2025-08-22 12:53:22,321] A new study created in RDB with name: RandomForest_Study</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved SVR best model as SVR_best_model.pkl</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2025-08-22 12:53:37,445] Trial 0 finished with value: 655.4701681050857 and parameters: {'n_estimators': 158, 'max_depth': 14, 'min_samples_split': 9}. Best is trial 0 with value: 655.4701681050857.
[I 2025-08-22 12:53:46,723] Trial 1 finished with value: 686.8784865082356 and parameters: {'n_estimators': 133, 'max_depth': 6, 'min_samples_split': 9}. Best is trial 0 with value: 655.4701681050857.
[I 2025-08-22 12:53:52,160] Trial 2 finished with value: 667.6287178860656 and parameters: {'n_estimators': 66, 'max_depth': 8, 'min_samples_split': 7}. Best is trial 0 with value: 655.4701681050857.
[I 2025-08-22 12:54:04,851] Trial 3 finished with value: 644.6708374983676 and parameters: {'n_estimators': 116, 'max_depth': 11, 'min_samples_split': 3}. Best is trial 3 with value: 644.6708374983676.
[I 2025-08-22 12:54:25,977] Trial 4 finished with value: 636.5747008555618 and parameters: {'n_estimators': 121, 'max_depth': 14, 'min_samples_split': 3}. Best is trial 4 with value: 636.5747008555618.
[I 2025-08-22 12:54:54,867] Trial 5 finished with value: 643.4219501660983 and parameters: {'n_estimators': 159, 'max_depth': 11, 'min_samples_split': 4}. Best is trial 4 with value: 636.5747008555618.
[I 2025-08-22 12:55:08,515] Trial 6 finished with value: 678.8032798361664 and parameters: {'n_estimators': 93, 'max_depth': 6, 'min_samples_split': 5}. Best is trial 4 with value: 636.5747008555618.
[I 2025-08-22 12:55:26,690] Trial 7 finished with value: 694.9634884608828 and parameters: {'n_estimators': 121, 'max_depth': 6, 'min_samples_split': 10}. Best is trial 4 with value: 636.5747008555618.
[I 2025-08-22 12:55:37,313] Trial 8 finished with value: 722.9745223581423 and parameters: {'n_estimators': 81, 'max_depth': 4, 'min_samples_split': 9}. Best is trial 4 with value: 636.5747008555618.
[I 2025-08-22 12:56:00,402] Trial 9 finished with value: 719.8939092781993 and parameters: {'n_estimators': 182, 'max_depth': 4, 'min_samples_split': 2}. Best is trial 4 with value: 636.5747008555618.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('categoric',
                                                  OneHotEncoder(handle_unknown='ignore'),
                                                  ['dist_name']),
                                                 ('numeric', MinMaxScaler(),
                                                  ['year',
                                                   'actual_evapotranspiration',
                                                   'rice_area',
                                                   'rice_production',
                                                   'rice_irrigated_area',
                                                   'maximum_temperature',
                                                   'minimum_temperature',
                                                   'precipitation',
                                                   'total_kharif', 'total_rabi',
                                                   'water_deficit'])],
                                   verbose_feature_names_out=False)),
                ('randomforest',
                 RandomForestRegressor(max_depth=14, min_samples_split=3,
                                       n_estimators=121))])</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b2d3920304484347916d1166b1eb89a9","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Successfully registered model 'RandomForest_Best_Model'.
Created version '1' of model 'RandomForest_Best_Model'.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>&lt;mlflow.models.model.ModelInfo at 0x184591292b0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>['RandomForest_best_model.pkl']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved RandomForest best model as RandomForest_best_model.pkl</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[I 2025-08-22 12:56:08,711] A new study created in RDB with name: XGB_Study
[I 2025-08-22 12:56:13,252] Trial 0 finished with value: 587.2267080137668 and parameters: {'n_estimators': 57, 'max_depth': 4, 'learning_rate': 0.0983901923425306}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:56:34,094] Trial 1 finished with value: 638.6334304071992 and parameters: {'n_estimators': 111, 'max_depth': 10, 'learning_rate': 0.07985014633719016}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:56:54,434] Trial 2 finished with value: 628.5706541420874 and parameters: {'n_estimators': 143, 'max_depth': 9, 'learning_rate': 0.13562072792359478}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:57:04,564] Trial 3 finished with value: 629.6477986220146 and parameters: {'n_estimators': 99, 'max_depth': 6, 'learning_rate': 0.03004987471361335}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:57:22,100] Trial 4 finished with value: 606.8070972549103 and parameters: {'n_estimators': 153, 'max_depth': 7, 'learning_rate': 0.04579357575715562}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:57:30,370] Trial 5 finished with value: 601.1066233880146 and parameters: {'n_estimators': 78, 'max_depth': 5, 'learning_rate': 0.05653306863465809}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:57:51,444] Trial 6 finished with value: 688.5648902985412 and parameters: {'n_estimators': 160, 'max_depth': 6, 'learning_rate': 0.011488297261474927}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:58:03,460] Trial 7 finished with value: 726.0495500032991 and parameters: {'n_estimators': 162, 'max_depth': 3, 'learning_rate': 0.010258229587384664}. Best is trial 0 with value: 587.2267080137668.
[I 2025-08-22 12:58:15,717] Trial 8 finished with value: 555.7756931435906 and parameters: {'n_estimators': 189, 'max_depth': 3, 'learning_rate': 0.05862994394856417}. Best is trial 8 with value: 555.7756931435906.
[I 2025-08-22 12:58:41,792] Trial 9 finished with value: 664.3644365475526 and parameters: {'n_estimators': 157, 'max_depth': 9, 'learning_rate': 0.01732924964434197}. Best is trial 8 with value: 555.7756931435906.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>Pipeline(steps=[('preprocessor',
                 ColumnTransformer(remainder='passthrough',
                                   transformers=[('categoric',
                                                  OneHotEncoder(handle_unknown='ignore'),
                                                  ['dist_name']),
                                                 ('numeric', MinMaxScaler(),
                                                  ['year',
                                                   'actual_evapotranspiration',
                                                   'rice_area',
                                                   'rice_production',
                                                   'rice_irrigated_area',
                                                   'maximum_temperature',
                                                   'minimum_temperature',
                                                   'precipitation',
                                                   'total_kharif', 'total...
                              gamma=None, grow_policy=None,
                              importance_type=None,
                              interaction_constraints=None,
                              learning_rate=0.05862994394856417, max_bin=None,
                              max_cat_threshold=None, max_cat_to_onehot=None,
                              max_delta_step=None, max_depth=3, max_leaves=None,
                              min_child_weight=None, missing=nan,
                              monotone_constraints=None, multi_strategy=None,
                              n_estimators=189, n_jobs=None,
                              num_parallel_tree=None, ...))])</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"aea756e336324b34bf08ba692f3b7233","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Successfully registered model 'XGB_Best_Model'.
Created version '1' of model 'XGB_Best_Model'.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>&lt;mlflow.models.model.ModelInfo at 0x18439d385c0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>['XGB_best_model.pkl']</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved XGB best model as XGB_best_model.pkl
Summary of best models:
{'SVR': {'rmse': np.float64(1009.5222285795704), 'params': {'C': 81.21922888388735, 'epsilon': 0.08010931300870007, 'gamma': 0.000640551217856536, 'kernel': 'linear'}, 'mlflow_run_id': '8378d58721e34404975b7ac58a2ac223'}, 'RandomForest': {'rmse': np.float64(824.6900587303282), 'params': {'n_estimators': 121, 'max_depth': 14, 'min_samples_split': 3}, 'mlflow_run_id': 'b310e73e3fd2464ab7e2fcdbac736444'}, 'XGB': {'rmse': np.float64(797.1357663183096), 'params': {'n_estimators': 189, 'max_depth': 3, 'learning_rate': 0.05862994394856417}, 'mlflow_run_id': '5a6fef6aef8f4925a42264a13a930b37'}}</code></pre>
</div>
</div>
<div id="dda38c2a" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_shap_analysis(model_name, run_id, X_train, preprocessor):</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Run SHAP analysis on a model stored in MLflow.</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the trained model from MLflow</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    model_uri <span class="op">=</span> <span class="ss">f"runs:/</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_final_model"</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> mlflow.sklearn.load_model(model_uri)</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocess training data</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    X_train_preprocessed <span class="op">=</span> preprocessor.transform(X_train)</span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    estimator <span class="op">=</span> model.named_steps[model_name.lower()]</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute SHAP values</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>    explainer <span class="op">=</span> shap.Explainer(estimator, X_train_preprocessed)</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>    shap_values <span class="op">=</span> explainer(X_train_preprocessed)</span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Beeswarm plot</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>    shap.plots.beeswarm(shap_values, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>    beeswarm_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_shap_beeswarm.png"</span></span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a>    plt.savefig(beeswarm_file)</span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary bar plot</span></span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a>    shap.plots.bar(shap_values, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a>    summary_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_shap_summary.png"</span></span>
<span id="cb121-32"><a href="#cb121-32" aria-hidden="true" tabindex="-1"></a>    plt.savefig(summary_file)</span>
<span id="cb121-33"><a href="#cb121-33" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb121-34"><a href="#cb121-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-35"><a href="#cb121-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SHAP analysis completed for </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb121-36"><a href="#cb121-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> beeswarm_file, summary_file</span>
<span id="cb121-37"><a href="#cb121-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-38"><a href="#cb121-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ===== Example: Run SHAP on the two models you manually select =====</span></span>
<span id="cb121-39"><a href="#cb121-39" aria-hidden="true" tabindex="-1"></a>selected_models <span class="op">=</span> [<span class="st">"SVR"</span>, <span class="st">"XGB"</span>]</span>
<span id="cb121-40"><a href="#cb121-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-41"><a href="#cb121-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name <span class="kw">in</span> selected_models:</span>
<span id="cb121-42"><a href="#cb121-42" aria-hidden="true" tabindex="-1"></a>    run_id <span class="op">=</span> best_models[model_name][<span class="st">"mlflow_run_id"</span>]</span>
<span id="cb121-43"><a href="#cb121-43" aria-hidden="true" tabindex="-1"></a>    run_shap_analysis(model_name, run_id, X_train, preprocessor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b955d162d69a42ce99e77e390ee4e0f2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"8b92917956264142bafb82e0fa82e409","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>SHAP analysis completed for SVR</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>('SVR_shap_beeswarm.png', 'SVR_shap_summary.png')</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"568a7e0b9e9e4f8da029f1945a484a73","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"87e8c8f89a5340bdbe2375fbf815173d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>SHAP analysis completed for XGB</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>('XGB_shap_beeswarm.png', 'XGB_shap_summary.png')</code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"05e047f9f269426ba195fdb5b1fd3f10":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"060aa756cdaa4bc584a24530cb3e0b99":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"0631d1dfa57a44c28b9ddf5b526eb077":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"09c4a911ffd44fadbb8a06814bfd7ed1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"0ed03c0fcaa246588a8d6ffb30201058":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"12265fd4bdeb4436b6c36e17f5df2ba8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_709e2407d6bc4e409ef00fd24108451a","max":1,"min":0,"orientation":"horizontal","style":"IPY_MODEL_09c4a911ffd44fadbb8a06814bfd7ed1","tabbable":null,"tooltip":null,"value":0}},"14097600ceb74412b1fb099ed1a0c6a6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"14c898fabd3b4f618e4f99d4e628364c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_546e1520af3b4b6c85744e5cc530f359","placeholder":"​","style":"IPY_MODEL_be5f6e0f2e824196bf45a58c20d9d601","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"1c3cbd3fd916407fbb04e941717bcb6d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"1e060b186e804b448d24e6eb1d62fb60":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"1f5b989dd4ac4acbbc701a6a6f537a9a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"1fe6fc0c09024301aadf800406ef7fd9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"324290c6762f440e91be680a040b15d2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_3a3d5ed5dbbd49da9d427a7f9ba335f6","IPY_MODEL_c5377daaae42482dbc1d4e5e35d40a12","IPY_MODEL_fef4f6d209e542c28698133fb684b137"],"layout":"IPY_MODEL_4ecd71e5ed8647ee8256a606591ffeee","tabbable":null,"tooltip":null}},"3a3d5ed5dbbd49da9d427a7f9ba335f6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_3b439c876d77446e8e6760163107faf9","placeholder":"​","style":"IPY_MODEL_cd88f3fbf66540daaec72b8bee004e0f","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"3a8134f14a0543258616497a6231ea3c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"3b063b2bc348437d8190cf81763501e3":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_cc70a2048cf445b7bfe244ad066e0d4a","placeholder":"​","style":"IPY_MODEL_7ec4b6d8391040a085b20cd91ab9d5e5","tabbable":null,"tooltip":null,"value":"Downloading artifacts:   0%"}},"3b439c876d77446e8e6760163107faf9":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"3cd8198ded004846826665b3c0b72819":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_c2605d91a8654cdf8faf96be0c7c630e","placeholder":"​","style":"IPY_MODEL_14097600ceb74412b1fb099ed1a0c6a6","tabbable":null,"tooltip":null,"value":" 0/1 [00:00&lt;?, ?it/s]"}},"4306dbf5b74c4505907c64712afebf88":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"4423b1a4742744d0824ae9913a8d7b9b":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"4625813f14f144e79aa0ce65cf1ecd4a":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"4b97967a1eda436cad014306164680ac":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_b35f9893a2294db6851f1c375649fcee","placeholder":"​","style":"IPY_MODEL_c2c943de80cf404c885d023b1852e4d8","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 139.82it/s]"}},"4c7a11f6c7114c659ae33aea55d2cb21":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"4cd774a2e3bb4ab9ba812348cd15217c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"4ecd71e5ed8647ee8256a606591ffeee":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"546e1520af3b4b6c85744e5cc530f359":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"568a7e0b9e9e4f8da029f1945a484a73":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_3b063b2bc348437d8190cf81763501e3","IPY_MODEL_12265fd4bdeb4436b6c36e17f5df2ba8","IPY_MODEL_84ca8e9fc9fb465ebeb1b3c9aec4a548"],"layout":"IPY_MODEL_bdd7915de56649768da41511850e8ef0","tabbable":null,"tooltip":null}},"5bbebf0e942b43b6876aff0ab36447fe":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"5d36ddd48c834bc5b3eae7fce5be4b08":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"5ee8e62c6f8444968ebc8e4c20fb1e48":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_e422a3f8a82c4f56bb758bc9329559e3","placeholder":"​","style":"IPY_MODEL_bd2ced4faffb45e7b33823b73a562101","tabbable":null,"tooltip":null,"value":"Downloading artifacts:   0%"}},"5ff43a2021ba42119adc631b90f59eb9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_d12c50529a89412ea4280ddc039a0a54","placeholder":"​","style":"IPY_MODEL_05e047f9f269426ba195fdb5b1fd3f10","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"62dfc50121d14ce994e48cbe077fbdd0":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"652598fe47584fd297dd561c66363277":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"682e5e131d3b4ad095abd4c0725c6a11":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_d9fc6c682a634f8d9ad20ef989df92f0","IPY_MODEL_8275593fd5de4818a9aca9fdbf44a405","IPY_MODEL_dd6dbcde9e564fd4917dba1f36ae2f1f"],"layout":"IPY_MODEL_eefb7e1c99034341921a35862126cd96","tabbable":null,"tooltip":null}},"685fba163fd44321b6391487c7e749ab":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_5bbebf0e942b43b6876aff0ab36447fe","placeholder":"​","style":"IPY_MODEL_4625813f14f144e79aa0ce65cf1ecd4a","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 213.92it/s]"}},"6b0a43ccf8324943ac04d7cc494524c6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"6b6fd079d83b45cabde926500757f1f2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"6cd61aa7af3240468818ecc968c69546":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"6f7010ca2a084bc2b76970ee6e6aabe1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_f88d8ef59e2f4fe185a404ed849f9926","placeholder":"​","style":"IPY_MODEL_ca4b0451f3f4435c8edce263f206df74","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 151.87it/s]"}},"709e2407d6bc4e409ef00fd24108451a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"7137929a29d24e8d86e691025b775b3b":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"75787c0edb434a7eaf849f22db429bc9":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"78e96690df1c490ea8d14d1146b4bee2":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"7e2c8009a2af4aacb7b4570ca476a0c1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_652598fe47584fd297dd561c66363277","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_d1ffd07a35d94698b10437d71b76affe","tabbable":null,"tooltip":null,"value":7}},"7e9dfda7a5de48f1a5c50d30405ab6d5":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_62dfc50121d14ce994e48cbe077fbdd0","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_1c3cbd3fd916407fbb04e941717bcb6d","tabbable":null,"tooltip":null,"value":7}},"7ec4b6d8391040a085b20cd91ab9d5e5":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"8275593fd5de4818a9aca9fdbf44a405":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_75787c0edb434a7eaf849f22db429bc9","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_4306dbf5b74c4505907c64712afebf88","tabbable":null,"tooltip":null,"value":7}},"84ca8e9fc9fb465ebeb1b3c9aec4a548":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_ed5a62092bb645d8b697c62126f207f2","placeholder":"​","style":"IPY_MODEL_6b0a43ccf8324943ac04d7cc494524c6","tabbable":null,"tooltip":null,"value":" 0/1 [00:00&lt;?, ?it/s]"}},"87e8c8f89a5340bdbe2375fbf815173d":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_fae82d8b686344bc8f534e87f4d02df5","IPY_MODEL_7e9dfda7a5de48f1a5c50d30405ab6d5","IPY_MODEL_6f7010ca2a084bc2b76970ee6e6aabe1"],"layout":"IPY_MODEL_cec5be99f4564341b3a9596aa52f1ee0","tabbable":null,"tooltip":null}},"8adc548356e94f45a791368e268bf63b":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"8b92917956264142bafb82e0fa82e409":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_14c898fabd3b4f618e4f99d4e628364c","IPY_MODEL_7e2c8009a2af4aacb7b4570ca476a0c1","IPY_MODEL_4b97967a1eda436cad014306164680ac"],"layout":"IPY_MODEL_d29a2c3a56bc47e3b48e1f34c7bcb984","tabbable":null,"tooltip":null}},"90da410d91524b8f8180eae4a815750b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"94ca911d80c44b66b254f4af26fc02e4":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"976d11d7ed8e4db28363f0afcd79a3a1":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"9952b825c6c843d3ab5f2660dfbadc8c":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"99701407cef745e89d0d0d84c397ece9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_8adc548356e94f45a791368e268bf63b","placeholder":"​","style":"IPY_MODEL_94ca911d80c44b66b254f4af26fc02e4","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 190.72it/s]"}},"9b936744a8044b8097e6e87c38c4e0a5":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_c64a344122a3405f862c3ed257dfa709","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_1fe6fc0c09024301aadf800406ef7fd9","tabbable":null,"tooltip":null,"value":7}},"a246c83718484b768ff094447b9c4a7f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"aea756e336324b34bf08ba692f3b7233":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_b373a94af368496f9fccbc7b716f274e","IPY_MODEL_cd31abc4db0444aaa1af4878446b41e4","IPY_MODEL_db89dade7e234dacb68c3e2563df4be1"],"layout":"IPY_MODEL_7137929a29d24e8d86e691025b775b3b","tabbable":null,"tooltip":null}},"b2d3920304484347916d1166b1eb89a9":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_5ff43a2021ba42119adc631b90f59eb9","IPY_MODEL_d7e1e17210c349178331d008c7386d06","IPY_MODEL_685fba163fd44321b6391487c7e749ab"],"layout":"IPY_MODEL_1e060b186e804b448d24e6eb1d62fb60","tabbable":null,"tooltip":null}},"b35f9893a2294db6851f1c375649fcee":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"b373a94af368496f9fccbc7b716f274e":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_4c7a11f6c7114c659ae33aea55d2cb21","placeholder":"​","style":"IPY_MODEL_0631d1dfa57a44c28b9ddf5b526eb077","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"b955d162d69a42ce99e77e390ee4e0f2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_5ee8e62c6f8444968ebc8e4c20fb1e48","IPY_MODEL_cb7c6aa9d51f4b67bf7beaacf0650228","IPY_MODEL_3cd8198ded004846826665b3c0b72819"],"layout":"IPY_MODEL_976d11d7ed8e4db28363f0afcd79a3a1","tabbable":null,"tooltip":null}},"bd2ced4faffb45e7b33823b73a562101":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"bdd7915de56649768da41511850e8ef0":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"be5f6e0f2e824196bf45a58c20d9d601":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"c1a2411042ce4fc49b76d479910b5167":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"c2605d91a8654cdf8faf96be0c7c630e":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"c2c943de80cf404c885d023b1852e4d8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"c462010f553f4dd18e9c5e0952e54382":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"c4974613b70c430393b8f83d88b4e35b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_4423b1a4742744d0824ae9913a8d7b9b","placeholder":"​","style":"IPY_MODEL_a246c83718484b768ff094447b9c4a7f","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"c4f94b40d91b48769b152549bc600649":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"c5377daaae42482dbc1d4e5e35d40a12":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_4cd774a2e3bb4ab9ba812348cd15217c","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_c462010f553f4dd18e9c5e0952e54382","tabbable":null,"tooltip":null,"value":7}},"c64a344122a3405f862c3ed257dfa709":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"c6dc42512da14391876b8705bd1284e6":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_c4974613b70c430393b8f83d88b4e35b","IPY_MODEL_9b936744a8044b8097e6e87c38c4e0a5","IPY_MODEL_99701407cef745e89d0d0d84c397ece9"],"layout":"IPY_MODEL_5d36ddd48c834bc5b3eae7fce5be4b08","tabbable":null,"tooltip":null}},"ca4b0451f3f4435c8edce263f206df74":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"cb7c6aa9d51f4b67bf7beaacf0650228":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_6cd61aa7af3240468818ecc968c69546","max":1,"min":0,"orientation":"horizontal","style":"IPY_MODEL_c1a2411042ce4fc49b76d479910b5167","tabbable":null,"tooltip":null,"value":0}},"cc70a2048cf445b7bfe244ad066e0d4a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"cd1cbc2a468449d0a75d525cd03805f7":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"cd31abc4db0444aaa1af4878446b41e4":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_9952b825c6c843d3ab5f2660dfbadc8c","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_db44fdc55e5646af8ded83ea2b24194a","tabbable":null,"tooltip":null,"value":7}},"cd88f3fbf66540daaec72b8bee004e0f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"cec5be99f4564341b3a9596aa52f1ee0":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d12c50529a89412ea4280ddc039a0a54":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d1ffd07a35d94698b10437d71b76affe":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"d29a2c3a56bc47e3b48e1f34c7bcb984":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"d7e1e17210c349178331d008c7386d06":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_cd1cbc2a468449d0a75d525cd03805f7","max":7,"min":0,"orientation":"horizontal","style":"IPY_MODEL_060aa756cdaa4bc584a24530cb3e0b99","tabbable":null,"tooltip":null,"value":7}},"d9fc6c682a634f8d9ad20ef989df92f0":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_0ed03c0fcaa246588a8d6ffb30201058","placeholder":"​","style":"IPY_MODEL_90da410d91524b8f8180eae4a815750b","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"db44fdc55e5646af8ded83ea2b24194a":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"db89dade7e234dacb68c3e2563df4be1":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_78e96690df1c490ea8d14d1146b4bee2","placeholder":"​","style":"IPY_MODEL_6b6fd079d83b45cabde926500757f1f2","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 175.89it/s]"}},"dd6dbcde9e564fd4917dba1f36ae2f1f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_1f5b989dd4ac4acbbc701a6a6f537a9a","placeholder":"​","style":"IPY_MODEL_e20bac3c80a44c91b8eaed44b4502ed4","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 199.05it/s]"}},"e20bac3c80a44c91b8eaed44b4502ed4":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"e422a3f8a82c4f56bb758bc9329559e3":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"e675d632966f4e4f96a81dc87c9539d8":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"ec934b9056db419e8254c6275e243518":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"ed5a62092bb645d8b697c62126f207f2":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"eefb7e1c99034341921a35862126cd96":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"f88d8ef59e2f4fe185a404ed849f9926":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"fae82d8b686344bc8f534e87f4d02df5":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_c4f94b40d91b48769b152549bc600649","placeholder":"​","style":"IPY_MODEL_3a8134f14a0543258616497a6231ea3c","tabbable":null,"tooltip":null,"value":"Downloading artifacts: 100%"}},"fef4f6d209e542c28698133fb684b137":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_ec934b9056db419e8254c6275e243518","placeholder":"​","style":"IPY_MODEL_e675d632966f4e4f96a81dc87c9539d8","tabbable":null,"tooltip":null,"value":" 7/7 [00:00&lt;00:00, 534.87it/s]"}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb126" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Exploratory Data Analysis on Rice Yield Dataset"</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a><span class="co">    encoding: utf-8</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 2</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: zephyr</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a><span class="co">    monofont: "JetBrains Mono"</span></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="co">    page-layout: full</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="co">    include-in-header: </span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="co">      text: |</span></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&amp;display=swap" rel="stylesheet"&gt;</span></span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;style&gt;</span></span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a><span class="co">          code, pre {</span></span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a><span class="co">            font-family: 'JetBrains Mono', monospace !important;</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a><span class="co">          }</span></span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;/style&gt;</span></span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a><span class="co">        &lt;meta charset="UTF-8"&gt;</span></span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a><span class="co">  enabled: true</span></span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a><span class="co">  output: true</span></span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a><span class="an">server:</span><span class="co"> shiny</span></span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>In this project, we are going to explore the cleaned dataset by visualizing attributes, imputing missing values, checking data types and so on.</span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 1: Data Import</span></span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>os.environ[<span class="st">"GIT_PYTHON_REFRESH"</span>] <span class="op">=</span> <span class="st">"quiet"</span></span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>SEED <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>random.seed(SEED)</span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>np.random.seed(SEED)</span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>)</span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-65"><a href="#cb126-65" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-66"><a href="#cb126-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb126-67"><a href="#cb126-67" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb126-68"><a href="#cb126-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-69"><a href="#cb126-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Add src/ to Python path</span></span>
<span id="cb126-70"><a href="#cb126-70" aria-hidden="true" tabindex="-1"></a>sys.path.append(<span class="bu">str</span>(Path.cwd().parent <span class="op">/</span> <span class="st">"src"</span>))</span>
<span id="cb126-71"><a href="#cb126-71" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-72"><a href="#cb126-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-75"><a href="#cb126-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-76"><a href="#cb126-76" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'..</span><span class="ch">\\</span><span class="st">data</span><span class="ch">\\</span><span class="st">combined_file</span><span class="ch">\\</span><span class="st">combined.csv'</span>)</span>
<span id="cb126-77"><a href="#cb126-77" aria-hidden="true" tabindex="-1"></a><span class="co"># df.head()</span></span>
<span id="cb126-78"><a href="#cb126-78" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-79"><a href="#cb126-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-82"><a href="#cb126-82" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-83"><a href="#cb126-83" aria-hidden="true" tabindex="-1"></a>df.columns</span>
<span id="cb126-84"><a href="#cb126-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-85"><a href="#cb126-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-88"><a href="#cb126-88" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-89"><a href="#cb126-89" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(df.columns, columns<span class="op">=</span>[<span class="st">'Parameters / Columns'</span>])</span>
<span id="cb126-90"><a href="#cb126-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-91"><a href="#cb126-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-92"><a href="#cb126-92" aria-hidden="true" tabindex="-1"></a>The target variable is <span class="in">`rice_yield_kg_per_ha`</span>. Every other column is a feature that we'll be using to predict the target.</span>
<span id="cb126-93"><a href="#cb126-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-96"><a href="#cb126-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-97"><a href="#cb126-97" aria-hidden="true" tabindex="-1"></a><span class="co"># df.info()</span></span>
<span id="cb126-98"><a href="#cb126-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-99"><a href="#cb126-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-100"><a href="#cb126-100" aria-hidden="true" tabindex="-1"></a>There are no <span class="in">`null`</span> values in the dataset. The method <span class="in">`.info()`</span> only counts <span class="in">`numpy.nan`</span> as <span class="in">`null`</span> values but not <span class="in">`-1`</span>.</span>
<span id="cb126-101"><a href="#cb126-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-104"><a href="#cb126-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-105"><a href="#cb126-105" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(df[<span class="st">'dist_name'</span>].unique(), columns<span class="op">=</span>[<span class="st">'Districts'</span>])</span>
<span id="cb126-106"><a href="#cb126-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-107"><a href="#cb126-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-110"><a href="#cb126-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-111"><a href="#cb126-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Renaming the column names for better readability</span></span>
<span id="cb126-112"><a href="#cb126-112" aria-hidden="true" tabindex="-1"></a>df.rename(columns<span class="op">=</span>{</span>
<span id="cb126-113"><a href="#cb126-113" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_area_1000_ha'</span>: <span class="st">'rice_area'</span>,</span>
<span id="cb126-114"><a href="#cb126-114" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_production_1000_tons'</span>: <span class="st">'rice_production'</span>,</span>
<span id="cb126-115"><a href="#cb126-115" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_yield_kg_per_ha'</span>: <span class="st">'rice_yield'</span>,</span>
<span id="cb126-116"><a href="#cb126-116" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_evapotranspiration_mm'</span>: <span class="st">'avg_act_evapotranspiration'</span>,</span>
<span id="cb126-117"><a href="#cb126-117" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_pot_evapotranspiration_mm'</span>: <span class="st">'avg_pot_evapotranspiration'</span>,</span>
<span id="cb126-118"><a href="#cb126-118" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'rice_irrigated_area_1000_ha'</span>: <span class="st">'rice_irrigated_area'</span>,</span>
<span id="cb126-119"><a href="#cb126-119" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_precipitation_mm'</span>: <span class="st">'avg_precipitation'</span>,</span>
<span id="cb126-120"><a href="#cb126-120" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'avg_water_deficit_mm'</span>: <span class="st">'avg_water_deficit'</span>,</span>
<span id="cb126-121"><a href="#cb126-121" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'nitrogen_kharif_consumption_tons'</span>: <span class="st">'nitrogen_kharif'</span>,</span>
<span id="cb126-122"><a href="#cb126-122" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'nitrogen_rabi_consumption_tons'</span>: <span class="st">'nitrogen_rabi'</span>,</span>
<span id="cb126-123"><a href="#cb126-123" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phosphate_kharif_consumption_tons'</span>: <span class="st">'phosphate_kharif'</span>,</span>
<span id="cb126-124"><a href="#cb126-124" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'phosphate_rabi_consumption_tons'</span>: <span class="st">'phosphate_rabi'</span>,</span>
<span id="cb126-125"><a href="#cb126-125" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'potash_kharif_consumption_tons'</span>: <span class="st">'potash_kharif'</span>,</span>
<span id="cb126-126"><a href="#cb126-126" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'potash_rabi_consumption_tons'</span>: <span class="st">'potash_rabi'</span>,</span>
<span id="cb126-127"><a href="#cb126-127" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'total_kharif_consumption_tons'</span>: <span class="st">'total_kharif'</span>,</span>
<span id="cb126-128"><a href="#cb126-128" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'total_rabi_consumption_tons'</span>: <span class="st">'total_rabi'</span></span>
<span id="cb126-129"><a href="#cb126-129" aria-hidden="true" tabindex="-1"></a>                   },</span>
<span id="cb126-130"><a href="#cb126-130" aria-hidden="true" tabindex="-1"></a>          inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-131"><a href="#cb126-131" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-132"><a href="#cb126-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-133"><a href="#cb126-133" aria-hidden="true" tabindex="-1"></a>We can observe that the column names have been changed and it is easy to read.</span>
<span id="cb126-134"><a href="#cb126-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-137"><a href="#cb126-137" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-138"><a href="#cb126-138" aria-hidden="true" tabindex="-1"></a>df.drop(columns<span class="op">=</span>[<span class="st">'nitrogen_kharif'</span>,</span>
<span id="cb126-139"><a href="#cb126-139" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'nitrogen_rabi'</span>,</span>
<span id="cb126-140"><a href="#cb126-140" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'phosphate_kharif'</span>,</span>
<span id="cb126-141"><a href="#cb126-141" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'phosphate_rabi'</span>,</span>
<span id="cb126-142"><a href="#cb126-142" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'potash_kharif'</span>,</span>
<span id="cb126-143"><a href="#cb126-143" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'potash_rabi'</span>],</span>
<span id="cb126-144"><a href="#cb126-144" aria-hidden="true" tabindex="-1"></a>        inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-145"><a href="#cb126-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-146"><a href="#cb126-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-147"><a href="#cb126-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-150"><a href="#cb126-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-151"><a href="#cb126-151" aria-hidden="true" tabindex="-1"></a><span class="co"># df.columns</span></span>
<span id="cb126-152"><a href="#cb126-152" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-153"><a href="#cb126-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-156"><a href="#cb126-156" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-157"><a href="#cb126-157" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb126-158"><a href="#cb126-158" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb126-159"><a href="#cb126-159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-160"><a href="#cb126-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-163"><a href="#cb126-163" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-164"><a href="#cb126-164" aria-hidden="true" tabindex="-1"></a>n_years <span class="op">=</span> df[<span class="st">'year'</span>].nunique()</span>
<span id="cb126-165"><a href="#cb126-165" aria-hidden="true" tabindex="-1"></a>min_year<span class="op">=</span> df[<span class="st">'year'</span>].<span class="bu">min</span>()</span>
<span id="cb126-166"><a href="#cb126-166" aria-hidden="true" tabindex="-1"></a>max_year <span class="op">=</span> df[<span class="st">'year'</span>].<span class="bu">max</span>()</span>
<span id="cb126-167"><a href="#cb126-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-168"><a href="#cb126-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"The rice yield dataset has </span><span class="sc">{</span>n_years<span class="sc">}</span><span class="ss"> years' data with minimum year: </span><span class="sc">{</span>min_year<span class="sc">}</span><span class="ss"> and maximum year: </span><span class="sc">{</span>max_year<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb126-169"><a href="#cb126-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-170"><a href="#cb126-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-173"><a href="#cb126-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-174"><a href="#cb126-174" aria-hidden="true" tabindex="-1"></a>n_districts <span class="op">=</span> df[<span class="st">'dist_name'</span>].nunique()</span>
<span id="cb126-175"><a href="#cb126-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-176"><a href="#cb126-176" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'There are </span><span class="sc">{</span>n_districts<span class="sc">}</span><span class="ss"> unique districts in the dataset'</span>)</span>
<span id="cb126-177"><a href="#cb126-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-178"><a href="#cb126-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-181"><a href="#cb126-181" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-182"><a href="#cb126-182" aria-hidden="true" tabindex="-1"></a>district_data_count <span class="op">=</span> pd.DataFrame(df[<span class="st">'dist_name'</span>].value_counts())</span>
<span id="cb126-183"><a href="#cb126-183" aria-hidden="true" tabindex="-1"></a>district_data_count</span>
<span id="cb126-184"><a href="#cb126-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-185"><a href="#cb126-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-186"><a href="#cb126-186" aria-hidden="true" tabindex="-1"></a>More than half of the districts have data for all the 26 years. So, we are removing some districts that do not have enough data.</span>
<span id="cb126-187"><a href="#cb126-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-190"><a href="#cb126-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-191"><a href="#cb126-191" aria-hidden="true" tabindex="-1"></a>low_data_districts <span class="op">=</span> district_data_count[district_data_count[<span class="st">'count'</span>] <span class="op">&lt;=</span> <span class="dv">20</span>].index</span>
<span id="cb126-192"><a href="#cb126-192" aria-hidden="true" tabindex="-1"></a>low_data_districts</span>
<span id="cb126-193"><a href="#cb126-193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-194"><a href="#cb126-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-197"><a href="#cb126-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-198"><a href="#cb126-198" aria-hidden="true" tabindex="-1"></a>district_mask <span class="op">=</span> <span class="op">~</span>df[<span class="st">'dist_name'</span>].isin(low_data_districts)</span>
<span id="cb126-199"><a href="#cb126-199" aria-hidden="true" tabindex="-1"></a>district_mask</span>
<span id="cb126-200"><a href="#cb126-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-201"><a href="#cb126-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-204"><a href="#cb126-204" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-205"><a href="#cb126-205" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="op">=</span> df[district_mask]</span>
<span id="cb126-206"><a href="#cb126-206" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'dist_name'</span>].unique()</span>
<span id="cb126-207"><a href="#cb126-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-208"><a href="#cb126-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-211"><a href="#cb126-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-212"><a href="#cb126-212" aria-hidden="true" tabindex="-1"></a>filtered_df.info()</span>
<span id="cb126-213"><a href="#cb126-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-214"><a href="#cb126-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-217"><a href="#cb126-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-218"><a href="#cb126-218" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'year'</span>].nunique()</span>
<span id="cb126-219"><a href="#cb126-219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-220"><a href="#cb126-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-221"><a href="#cb126-221" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb126-222"><a href="#cb126-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-223"><a href="#cb126-223" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 2: Feature Engineering</span></span>
<span id="cb126-226"><a href="#cb126-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-227"><a href="#cb126-227" aria-hidden="true" tabindex="-1"></a> <span class="co"># The `year_rescale` feature contains values between 1 and 26 which corresponds to 1990 and 2015.</span></span>
<span id="cb126-228"><a href="#cb126-228" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'year_rescale'</span>] <span class="op">=</span> <span class="bu">abs</span>((filtered_df[<span class="st">'year'</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="dv">1</span>) <span class="op">-</span> filtered_df[<span class="st">'year'</span>])</span>
<span id="cb126-229"><a href="#cb126-229" aria-hidden="true" tabindex="-1"></a>filtered_df[<span class="st">'year_rescale'</span>].<span class="bu">min</span>(), filtered_df[<span class="st">'year_rescale'</span>].<span class="bu">max</span>()</span>
<span id="cb126-230"><a href="#cb126-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-231"><a href="#cb126-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-232"><a href="#cb126-232" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb126-233"><a href="#cb126-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-234"><a href="#cb126-234" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 3: Distribution of Variables</span></span>
<span id="cb126-235"><a href="#cb126-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-238"><a href="#cb126-238" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-239"><a href="#cb126-239" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny.express <span class="im">import</span> <span class="bu">input</span>, render, ui</span>
<span id="cb126-240"><a href="#cb126-240" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> htmltools <span class="im">import</span> TagList, tags</span>
<span id="cb126-241"><a href="#cb126-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-242"><a href="#cb126-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-245"><a href="#cb126-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-246"><a href="#cb126-246" aria-hidden="true" tabindex="-1"></a>dist_variables <span class="op">=</span> [<span class="st">'dist_name'</span>,</span>
<span id="cb126-247"><a href="#cb126-247" aria-hidden="true" tabindex="-1"></a>             <span class="st">'actual_evapotranspiration'</span>,</span>
<span id="cb126-248"><a href="#cb126-248" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_area'</span>,</span>
<span id="cb126-249"><a href="#cb126-249" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_production'</span>,</span>
<span id="cb126-250"><a href="#cb126-250" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_yield'</span>,</span>
<span id="cb126-251"><a href="#cb126-251" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_irrigated_area'</span>,</span>
<span id="cb126-252"><a href="#cb126-252" aria-hidden="true" tabindex="-1"></a>             <span class="st">'maximum_temperature'</span>,</span>
<span id="cb126-253"><a href="#cb126-253" aria-hidden="true" tabindex="-1"></a>             <span class="st">'minimum_temperature'</span>, </span>
<span id="cb126-254"><a href="#cb126-254" aria-hidden="true" tabindex="-1"></a>             <span class="st">'precipitation'</span>,</span>
<span id="cb126-255"><a href="#cb126-255" aria-hidden="true" tabindex="-1"></a>             <span class="st">'water_deficit'</span>,</span>
<span id="cb126-256"><a href="#cb126-256" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_kharif'</span>,</span>
<span id="cb126-257"><a href="#cb126-257" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_rabi'</span></span>
<span id="cb126-258"><a href="#cb126-258" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb126-259"><a href="#cb126-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-260"><a href="#cb126-260" aria-hidden="true" tabindex="-1"></a>dist_remarks <span class="op">=</span> {</span>
<span id="cb126-261"><a href="#cb126-261" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dist_name"</span>: <span class="st">"Most of the districts have 26 years' data, except a few."</span>,</span>
<span id="cb126-262"><a href="#cb126-262" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_evapotranspiration"</span>: <span class="st">"Almost normally distributed with no outliers or skewness."</span>,</span>
<span id="cb126-263"><a href="#cb126-263" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_area"</span>: <span class="st">"The data is approximately normal with right skew."</span>,</span>
<span id="cb126-264"><a href="#cb126-264" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_production"</span>: <span class="st">"The data is approximately normal with slight right skew."</span>,</span>
<span id="cb126-265"><a href="#cb126-265" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_yield"</span>: <span class="st">'The `rice_yield` variable is approximately normal with left skew.'</span>,</span>
<span id="cb126-266"><a href="#cb126-266" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_irrigated_area"</span>: <span class="st">"The data is approximately normal with right skew."</span>,</span>
<span id="cb126-267"><a href="#cb126-267" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maximum_temperature"</span>: <span class="st">"Distribution is bi-modal"</span>,</span>
<span id="cb126-268"><a href="#cb126-268" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minimum_temperature"</span>: <span class="st">"Distribution is bi-modal."</span>,</span>
<span id="cb126-269"><a href="#cb126-269" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precipitation"</span>: <span class="st">"The data is approximately normal with slight right skew."</span>,      </span>
<span id="cb126-270"><a href="#cb126-270" aria-hidden="true" tabindex="-1"></a>    <span class="st">"water_deficit"</span>: <span class="st">"Almost normally distributed with no outliers or skewness."</span>,</span>
<span id="cb126-271"><a href="#cb126-271" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_kharif"</span>: <span class="st">"Almost normally distributed"</span>,</span>
<span id="cb126-272"><a href="#cb126-272" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_rabi"</span>: <span class="st">"Almost normally distributed"</span></span>
<span id="cb126-273"><a href="#cb126-273" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-274"><a href="#cb126-274" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-275"><a href="#cb126-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-278"><a href="#cb126-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-279"><a href="#cb126-279" aria-hidden="true" tabindex="-1"></a><span class="co"># UI elements</span></span>
<span id="cb126-280"><a href="#cb126-280" aria-hidden="true" tabindex="-1"></a>ui.input_select(<span class="st">"dist_var"</span>, <span class="st">"Choose Variable"</span>, choices<span class="op">=</span>dist_variables)</span>
<span id="cb126-281"><a href="#cb126-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-282"><a href="#cb126-282" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot output</span></span>
<span id="cb126-283"><a href="#cb126-283" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb126-284"><a href="#cb126-284" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dist_plot():</span>
<span id="cb126-285"><a href="#cb126-285" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.dist_var()</span>
<span id="cb126-286"><a href="#cb126-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-287"><a href="#cb126-287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="op">!=</span> <span class="st">'dist_name'</span>:</span>
<span id="cb126-288"><a href="#cb126-288" aria-hidden="true" tabindex="-1"></a>      fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb126-289"><a href="#cb126-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-290"><a href="#cb126-290" aria-hidden="true" tabindex="-1"></a>      plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb126-291"><a href="#cb126-291" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Axes 1: original distribution</span></span>
<span id="cb126-292"><a href="#cb126-292" aria-hidden="true" tabindex="-1"></a>      sns.distplot(filtered_df[col], ax<span class="op">=</span>ax[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb126-293"><a href="#cb126-293" aria-hidden="true" tabindex="-1"></a>      ax[<span class="dv">0</span>].set_xlabel(col, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-294"><a href="#cb126-294" aria-hidden="true" tabindex="-1"></a>      ax[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-295"><a href="#cb126-295" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb126-296"><a href="#cb126-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-297"><a href="#cb126-297" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Axes 2: box plot of the original distribution</span></span>
<span id="cb126-298"><a href="#cb126-298" aria-hidden="true" tabindex="-1"></a>      sns.boxplot(filtered_df[col], ax<span class="op">=</span>ax[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb126-299"><a href="#cb126-299" aria-hidden="true" tabindex="-1"></a>      ax[<span class="dv">1</span>].set_ylabel(col, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-300"><a href="#cb126-300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-301"><a href="#cb126-301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb126-302"><a href="#cb126-302" aria-hidden="true" tabindex="-1"></a>      plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb126-303"><a href="#cb126-303" aria-hidden="true" tabindex="-1"></a>      fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb126-304"><a href="#cb126-304" aria-hidden="true" tabindex="-1"></a>      filtered_df[col].value_counts().plot(kind<span class="op">=</span><span class="st">'bar'</span>)<span class="op">;</span></span>
<span id="cb126-305"><a href="#cb126-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-306"><a href="#cb126-306" aria-hidden="true" tabindex="-1"></a>      ax.set_ylim(<span class="dv">0</span>, <span class="dv">27</span>)</span>
<span id="cb126-307"><a href="#cb126-307" aria-hidden="true" tabindex="-1"></a>      ax.set_yticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">27</span>, <span class="dv">5</span>))</span>
<span id="cb126-308"><a href="#cb126-308" aria-hidden="true" tabindex="-1"></a>      ax.set_xlabel(<span class="st">''</span>) <span class="co"># Hide the x-axis label </span></span>
<span id="cb126-309"><a href="#cb126-309" aria-hidden="true" tabindex="-1"></a>      ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-310"><a href="#cb126-310" aria-hidden="true" tabindex="-1"></a>      ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-311"><a href="#cb126-311" aria-hidden="true" tabindex="-1"></a>      ax.xaxis.grid(<span class="va">False</span>)</span>
<span id="cb126-312"><a href="#cb126-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-313"><a href="#cb126-313" aria-hidden="true" tabindex="-1"></a><span class="co"># Remarks output</span></span>
<span id="cb126-314"><a href="#cb126-314" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb126-315"><a href="#cb126-315" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dist_remarks_ui():</span>
<span id="cb126-316"><a href="#cb126-316" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.dist_var()</span>
<span id="cb126-317"><a href="#cb126-317" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TagList(tags.p(<span class="st">"Remarks for "</span>, tags.code(col), <span class="st">": "</span>, tags.strong(dist_remarks.get(col))))</span>
<span id="cb126-318"><a href="#cb126-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-319"><a href="#cb126-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-320"><a href="#cb126-320" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb126-321"><a href="#cb126-321" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 4: Correlation Analysis</span></span>
<span id="cb126-322"><a href="#cb126-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-325"><a href="#cb126-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-326"><a href="#cb126-326" aria-hidden="true" tabindex="-1"></a>corr_variables <span class="op">=</span> [<span class="st">'actual_evapotranspiration'</span>,</span>
<span id="cb126-327"><a href="#cb126-327" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_area'</span>,</span>
<span id="cb126-328"><a href="#cb126-328" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_production'</span>,</span>
<span id="cb126-329"><a href="#cb126-329" aria-hidden="true" tabindex="-1"></a>             <span class="st">'rice_irrigated_area'</span>,</span>
<span id="cb126-330"><a href="#cb126-330" aria-hidden="true" tabindex="-1"></a>             <span class="st">'maximum_temperature'</span>,</span>
<span id="cb126-331"><a href="#cb126-331" aria-hidden="true" tabindex="-1"></a>             <span class="st">'minimum_temperature'</span>, </span>
<span id="cb126-332"><a href="#cb126-332" aria-hidden="true" tabindex="-1"></a>             <span class="st">'precipitation'</span>,</span>
<span id="cb126-333"><a href="#cb126-333" aria-hidden="true" tabindex="-1"></a>             <span class="st">'water_deficit'</span>,</span>
<span id="cb126-334"><a href="#cb126-334" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_kharif'</span>,</span>
<span id="cb126-335"><a href="#cb126-335" aria-hidden="true" tabindex="-1"></a>             <span class="st">'total_rabi'</span></span>
<span id="cb126-336"><a href="#cb126-336" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb126-337"><a href="#cb126-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-338"><a href="#cb126-338" aria-hidden="true" tabindex="-1"></a>corr_remarks <span class="op">=</span> {</span>
<span id="cb126-339"><a href="#cb126-339" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_evapotranspiration"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb126-340"><a href="#cb126-340" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_area"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb126-341"><a href="#cb126-341" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_production"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb126-342"><a href="#cb126-342" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_irrigated_area"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb126-343"><a href="#cb126-343" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maximum_temperature"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb126-344"><a href="#cb126-344" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minimum_temperature"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb126-345"><a href="#cb126-345" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precipitation"</span>: <span class="st">"No Correlation."</span>,      </span>
<span id="cb126-346"><a href="#cb126-346" aria-hidden="true" tabindex="-1"></a>    <span class="st">"water_deficit"</span>: <span class="st">"No Correlation."</span>,</span>
<span id="cb126-347"><a href="#cb126-347" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_kharif"</span>: <span class="st">"No Correlation"</span>,</span>
<span id="cb126-348"><a href="#cb126-348" aria-hidden="true" tabindex="-1"></a>    <span class="st">"total_rabi"</span>: <span class="st">"No Correlation"</span></span>
<span id="cb126-349"><a href="#cb126-349" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-350"><a href="#cb126-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-351"><a href="#cb126-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-354"><a href="#cb126-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-355"><a href="#cb126-355" aria-hidden="true" tabindex="-1"></a><span class="co"># UI elements</span></span>
<span id="cb126-356"><a href="#cb126-356" aria-hidden="true" tabindex="-1"></a>ui.input_select(<span class="st">"corr_var"</span>, <span class="st">"Choose Variable"</span>, choices<span class="op">=</span>corr_variables)</span>
<span id="cb126-357"><a href="#cb126-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-358"><a href="#cb126-358" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb126-359"><a href="#cb126-359" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corr_plot():</span>
<span id="cb126-360"><a href="#cb126-360" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.corr_var()</span>
<span id="cb126-361"><a href="#cb126-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-362"><a href="#cb126-362" aria-hidden="true" tabindex="-1"></a>    corr <span class="op">=</span> filtered_df[<span class="st">'rice_yield'</span>].corr(filtered_df[col])</span>
<span id="cb126-363"><a href="#cb126-363" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(f'Correlation: {corr:.2f}')</span></span>
<span id="cb126-364"><a href="#cb126-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-365"><a href="#cb126-365" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Scatter plot with regression line</span></span>
<span id="cb126-366"><a href="#cb126-366" aria-hidden="true" tabindex="-1"></a>    plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb126-367"><a href="#cb126-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-368"><a href="#cb126-368" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb126-369"><a href="#cb126-369" aria-hidden="true" tabindex="-1"></a>    sns.regplot(x<span class="op">=</span>col, y<span class="op">=</span><span class="st">'rice_yield'</span>, data<span class="op">=</span>filtered_df, ax<span class="op">=</span>ax)</span>
<span id="cb126-370"><a href="#cb126-370" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f'Scatter Plot (Correlation: </span><span class="sc">{</span>corr<span class="sc">:.2f}</span><span class="ss">)'</span>, fontdict<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">12</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>, <span class="st">'family'</span>: <span class="st">'Arial'</span>})</span>
<span id="cb126-371"><a href="#cb126-371" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(ax.get_xlabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-372"><a href="#cb126-372" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(ax.get_ylabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-373"><a href="#cb126-373" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb126-374"><a href="#cb126-374" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb126-375"><a href="#cb126-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-376"><a href="#cb126-376" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb126-377"><a href="#cb126-377" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> corr_remarks_ui():</span>
<span id="cb126-378"><a href="#cb126-378" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="bu">input</span>.corr_var()</span>
<span id="cb126-379"><a href="#cb126-379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> TagList(tags.p(<span class="st">"Remarks for "</span>, tags.code(col), <span class="st">": "</span>, tags.strong(corr_remarks.get(col))))</span>
<span id="cb126-380"><a href="#cb126-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-381"><a href="#cb126-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-384"><a href="#cb126-384" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-385"><a href="#cb126-385" aria-hidden="true" tabindex="-1"></a>corr_df <span class="op">=</span> filtered_df.drop(columns<span class="op">=</span>[<span class="st">'dist_name'</span>, <span class="st">'year'</span>, <span class="st">'year_rescale'</span>]).corr()</span>
<span id="cb126-386"><a href="#cb126-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-387"><a href="#cb126-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-390"><a href="#cb126-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-391"><a href="#cb126-391" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb126-392"><a href="#cb126-392" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.colors <span class="im">as</span> mcolors</span>
<span id="cb126-393"><a href="#cb126-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-394"><a href="#cb126-394" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">700</span>)</span>
<span id="cb126-395"><a href="#cb126-395" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cor_plot():</span>
<span id="cb126-396"><a href="#cb126-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-397"><a href="#cb126-397" aria-hidden="true" tabindex="-1"></a>    plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb126-398"><a href="#cb126-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-399"><a href="#cb126-399" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb126-400"><a href="#cb126-400" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sky_blue_cmap = sns.light_palette('deepskyblue', as_cmap=True, reverse=True)</span></span>
<span id="cb126-401"><a href="#cb126-401" aria-hidden="true" tabindex="-1"></a>    cmap <span class="op">=</span> mcolors.LinearSegmentedColormap.from_list(<span class="st">'custom_deepskyblue'</span>, [<span class="st">'deepskyblue'</span>, <span class="st">'white'</span>, <span class="st">'deepskyblue'</span>], N<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb126-402"><a href="#cb126-402" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> mcolors.CenteredNorm()</span>
<span id="cb126-403"><a href="#cb126-403" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the heatmap</span></span>
<span id="cb126-404"><a href="#cb126-404" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(corr_df,</span>
<span id="cb126-405"><a href="#cb126-405" aria-hidden="true" tabindex="-1"></a>                annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb126-406"><a href="#cb126-406" aria-hidden="true" tabindex="-1"></a>                cmap<span class="op">=</span>cmap,</span>
<span id="cb126-407"><a href="#cb126-407" aria-hidden="true" tabindex="-1"></a>                vmin<span class="op">=-</span><span class="dv">1</span>,</span>
<span id="cb126-408"><a href="#cb126-408" aria-hidden="true" tabindex="-1"></a>                vmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb126-409"><a href="#cb126-409" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">=</span><span class="st">'.1f'</span>,</span>
<span id="cb126-410"><a href="#cb126-410" aria-hidden="true" tabindex="-1"></a>                mask<span class="op">=</span>np.triu(np.ones_like(corr_df, dtype<span class="op">=</span><span class="bu">bool</span>)),</span>
<span id="cb126-411"><a href="#cb126-411" aria-hidden="true" tabindex="-1"></a>                norm<span class="op">=</span>norm</span>
<span id="cb126-412"><a href="#cb126-412" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb126-413"><a href="#cb126-413" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Heatmap of Correlation Coefficient Matrix'</span>, fontdict<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">12</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>, <span class="st">'family'</span>: <span class="st">'Arial'</span>})<span class="op">;</span></span>
<span id="cb126-414"><a href="#cb126-414" aria-hidden="true" tabindex="-1"></a>    ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb126-415"><a href="#cb126-415" aria-hidden="true" tabindex="-1"></a>    ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb126-416"><a href="#cb126-416" aria-hidden="true" tabindex="-1"></a>    ax.xaxis.grid(<span class="va">False</span>)</span>
<span id="cb126-417"><a href="#cb126-417" aria-hidden="true" tabindex="-1"></a>    ax.yaxis.grid(<span class="va">False</span>)</span>
<span id="cb126-418"><a href="#cb126-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-419"><a href="#cb126-419" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-420"><a href="#cb126-420" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 5: Split Data - Train and Test</span></span>
<span id="cb126-421"><a href="#cb126-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-424"><a href="#cb126-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-425"><a href="#cb126-425" aria-hidden="true" tabindex="-1"></a>filtered_df <span class="op">=</span> filtered_df.drop(columns<span class="op">=</span>[<span class="st">'year_rescale'</span>])</span>
<span id="cb126-426"><a href="#cb126-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-427"><a href="#cb126-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-430"><a href="#cb126-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-431"><a href="#cb126-431" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> filtered_df.sort_values([<span class="st">'year'</span>, <span class="st">'dist_name'</span>])</span>
<span id="cb126-432"><a href="#cb126-432" aria-hidden="true" tabindex="-1"></a>df</span>
<span id="cb126-433"><a href="#cb126-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-434"><a href="#cb126-434" aria-hidden="true" tabindex="-1"></a><span class="co"># Split</span></span>
<span id="cb126-435"><a href="#cb126-435" aria-hidden="true" tabindex="-1"></a>train_df <span class="op">=</span> df[df[<span class="st">'year'</span>] <span class="op">&lt;=</span> <span class="dv">2010</span>].copy()</span>
<span id="cb126-436"><a href="#cb126-436" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> df[df[<span class="st">'year'</span>] <span class="op">&gt;</span> <span class="dv">2010</span>].copy()</span>
<span id="cb126-437"><a href="#cb126-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-438"><a href="#cb126-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-441"><a href="#cb126-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-442"><a href="#cb126-442" aria-hidden="true" tabindex="-1"></a>train_df.head(<span class="dv">30</span>)</span>
<span id="cb126-443"><a href="#cb126-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-444"><a href="#cb126-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-447"><a href="#cb126-447" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-448"><a href="#cb126-448" aria-hidden="true" tabindex="-1"></a>train_df.info()</span>
<span id="cb126-449"><a href="#cb126-449" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-450"><a href="#cb126-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-453"><a href="#cb126-453" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-454"><a href="#cb126-454" aria-hidden="true" tabindex="-1"></a>test_df.info()</span>
<span id="cb126-455"><a href="#cb126-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-456"><a href="#cb126-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-459"><a href="#cb126-459" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-460"><a href="#cb126-460" aria-hidden="true" tabindex="-1"></a>df[<span class="st">'split'</span>] <span class="op">=</span> df[<span class="st">'year'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="st">"Train"</span> <span class="cf">if</span> x <span class="op">&lt;=</span> <span class="dv">2010</span> <span class="cf">else</span> <span class="st">"Test"</span>)</span>
<span id="cb126-461"><a href="#cb126-461" aria-hidden="true" tabindex="-1"></a>df.tail()</span>
<span id="cb126-462"><a href="#cb126-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-463"><a href="#cb126-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-466"><a href="#cb126-466" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-467"><a href="#cb126-467" aria-hidden="true" tabindex="-1"></a>plot_columns <span class="op">=</span> [</span>
<span id="cb126-468"><a href="#cb126-468" aria-hidden="true" tabindex="-1"></a>    <span class="st">"maximum_temperature"</span>,</span>
<span id="cb126-469"><a href="#cb126-469" aria-hidden="true" tabindex="-1"></a>    <span class="st">"minimum_temperature"</span>,</span>
<span id="cb126-470"><a href="#cb126-470" aria-hidden="true" tabindex="-1"></a>    <span class="st">"precipitation"</span>,</span>
<span id="cb126-471"><a href="#cb126-471" aria-hidden="true" tabindex="-1"></a>    <span class="st">"actual_evapotranspiration"</span>,</span>
<span id="cb126-472"><a href="#cb126-472" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_yield"</span>,</span>
<span id="cb126-473"><a href="#cb126-473" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rice_production"</span>,</span>
<span id="cb126-474"><a href="#cb126-474" aria-hidden="true" tabindex="-1"></a>    <span class="st">"water_deficit"</span></span>
<span id="cb126-475"><a href="#cb126-475" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb126-476"><a href="#cb126-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-477"><a href="#cb126-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-480"><a href="#cb126-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-481"><a href="#cb126-481" aria-hidden="true" tabindex="-1"></a>ui.input_select(<span class="st">'feature'</span>, <span class="st">'Choose a feature'</span>, choices<span class="op">=</span>plot_columns)</span>
<span id="cb126-482"><a href="#cb126-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-483"><a href="#cb126-483" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span>(width<span class="op">=</span><span class="dv">900</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb126-484"><a href="#cb126-484" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_test_plot():</span>
<span id="cb126-485"><a href="#cb126-485" aria-hidden="true" tabindex="-1"></a>  plt.style.use(<span class="st">'fivethirtyeight'</span>)</span>
<span id="cb126-486"><a href="#cb126-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-487"><a href="#cb126-487" aria-hidden="true" tabindex="-1"></a>  fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>)</span>
<span id="cb126-488"><a href="#cb126-488" aria-hidden="true" tabindex="-1"></a>  sns.scatterplot(data<span class="op">=</span>df,</span>
<span id="cb126-489"><a href="#cb126-489" aria-hidden="true" tabindex="-1"></a>                  x<span class="op">=</span><span class="st">'year'</span>,</span>
<span id="cb126-490"><a href="#cb126-490" aria-hidden="true" tabindex="-1"></a>                  y<span class="op">=</span><span class="bu">input</span>.feature(),</span>
<span id="cb126-491"><a href="#cb126-491" aria-hidden="true" tabindex="-1"></a>                  hue<span class="op">=</span><span class="st">'split'</span>,</span>
<span id="cb126-492"><a href="#cb126-492" aria-hidden="true" tabindex="-1"></a>                  ax<span class="op">=</span>ax)</span>
<span id="cb126-493"><a href="#cb126-493" aria-hidden="true" tabindex="-1"></a>  plt.title(<span class="st">'Train test split'</span>, fontdict<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">13</span>, <span class="st">'fontweight'</span>: <span class="st">'bold'</span>, <span class="st">'family'</span>: <span class="st">'Arial'</span>})</span>
<span id="cb126-494"><a href="#cb126-494" aria-hidden="true" tabindex="-1"></a>  plt.xlabel(<span class="st">'Year'</span>)</span>
<span id="cb126-495"><a href="#cb126-495" aria-hidden="true" tabindex="-1"></a>  plt.legend(</span>
<span id="cb126-496"><a href="#cb126-496" aria-hidden="true" tabindex="-1"></a>        bbox_to_anchor<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">1</span>),  <span class="co"># x=1.05 (right outside), y=1 (top aligned)</span></span>
<span id="cb126-497"><a href="#cb126-497" aria-hidden="true" tabindex="-1"></a>        loc<span class="op">=</span><span class="st">"upper left"</span>,</span>
<span id="cb126-498"><a href="#cb126-498" aria-hidden="true" tabindex="-1"></a>        ncol<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb126-499"><a href="#cb126-499" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb126-500"><a href="#cb126-500" aria-hidden="true" tabindex="-1"></a>  ax.set_xlabel(ax.get_xlabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-501"><a href="#cb126-501" aria-hidden="true" tabindex="-1"></a>  ax.set_ylabel(ax.get_ylabel(), fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb126-502"><a href="#cb126-502" aria-hidden="true" tabindex="-1"></a>  ax.set_xticklabels(ax.get_xticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb126-503"><a href="#cb126-503" aria-hidden="true" tabindex="-1"></a>  ax.set_yticklabels(ax.get_yticklabels(), fontsize<span class="op">=</span><span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb126-504"><a href="#cb126-504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-505"><a href="#cb126-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-506"><a href="#cb126-506" aria-hidden="true" tabindex="-1"></a><span class="fu">## Train and Test Set</span></span>
<span id="cb126-509"><a href="#cb126-509" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-510"><a href="#cb126-510" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> train_df.drop(columns<span class="op">=</span>[<span class="st">'rice_yield'</span>])</span>
<span id="cb126-511"><a href="#cb126-511" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> train_df[<span class="st">'rice_yield'</span>]</span>
<span id="cb126-512"><a href="#cb126-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-513"><a href="#cb126-513" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> test_df.drop(columns<span class="op">=</span>[<span class="st">'rice_yield'</span>])</span>
<span id="cb126-514"><a href="#cb126-514" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> test_df[<span class="st">'rice_yield'</span>]</span>
<span id="cb126-515"><a href="#cb126-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-516"><a href="#cb126-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-517"><a href="#cb126-517" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time-series Split</span></span>
<span id="cb126-520"><a href="#cb126-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-521"><a href="#cb126-521" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> set_config</span>
<span id="cb126-522"><a href="#cb126-522" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb126-523"><a href="#cb126-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-524"><a href="#cb126-524" aria-hidden="true" tabindex="-1"></a>set_config(display<span class="op">=</span><span class="st">'text'</span>)</span>
<span id="cb126-525"><a href="#cb126-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-526"><a href="#cb126-526" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> X_train.shape[<span class="dv">0</span>]</span>
<span id="cb126-527"><a href="#cb126-527" aria-hidden="true" tabindex="-1"></a>MIN_TEST_SIZE <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb126-528"><a href="#cb126-528" aria-hidden="true" tabindex="-1"></a>n_splits <span class="op">=</span> N <span class="op">//</span> MIN_TEST_SIZE <span class="op">-</span> <span class="dv">1</span> <span class="co"># To ensure we get the atleast the same size for every split</span></span>
<span id="cb126-529"><a href="#cb126-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-530"><a href="#cb126-530" aria-hidden="true" tabindex="-1"></a>tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span>n_splits)</span>
<span id="cb126-531"><a href="#cb126-531" aria-hidden="true" tabindex="-1"></a>tscv</span>
<span id="cb126-532"><a href="#cb126-532" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-533"><a href="#cb126-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-534"><a href="#cb126-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-535"><a href="#cb126-535" aria-hidden="true" tabindex="-1"></a><span class="fu">## Checking Time-series Splits</span></span>
<span id="cb126-538"><a href="#cb126-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-539"><a href="#cb126-539" aria-hidden="true" tabindex="-1"></a><span class="co"># for i, (train_idx, test_idx) in enumerate(tscv.split(X_train)):</span></span>
<span id="cb126-540"><a href="#cb126-540" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Split {i+1}: Train size = {len(train_idx)}, Test size = {len(test_idx)}")</span></span>
<span id="cb126-541"><a href="#cb126-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-542"><a href="#cb126-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-543"><a href="#cb126-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-544"><a href="#cb126-544" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 6: Data Preprocessing</span></span>
<span id="cb126-545"><a href="#cb126-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-546"><a href="#cb126-546" aria-hidden="true" tabindex="-1"></a>In this chapter, we'll use a preprocessing pipeline to transfom numeric and categoric data in our dataset. Post this, we will be building our candidate models and do hyperparameter optimization to pick the best one.</span>
<span id="cb126-547"><a href="#cb126-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-550"><a href="#cb126-550" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-551"><a href="#cb126-551" aria-hidden="true" tabindex="-1"></a><span class="co"># Column Selector</span></span>
<span id="cb126-552"><a href="#cb126-552" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> make_column_selector <span class="im">as</span> selector</span>
<span id="cb126-553"><a href="#cb126-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-554"><a href="#cb126-554" aria-hidden="true" tabindex="-1"></a>numeric_columns_selector <span class="op">=</span> selector(dtype_exclude<span class="op">=</span><span class="bu">object</span>)</span>
<span id="cb126-555"><a href="#cb126-555" aria-hidden="true" tabindex="-1"></a>categoric_columns_selector <span class="op">=</span> selector(dtype_include<span class="op">=</span><span class="bu">object</span>)</span>
<span id="cb126-556"><a href="#cb126-556" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-557"><a href="#cb126-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-560"><a href="#cb126-560" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-561"><a href="#cb126-561" aria-hidden="true" tabindex="-1"></a>numeric_columns <span class="op">=</span> numeric_columns_selector(X_train)</span>
<span id="cb126-562"><a href="#cb126-562" aria-hidden="true" tabindex="-1"></a>categoric_columns <span class="op">=</span> categoric_columns_selector(X_train)</span>
<span id="cb126-563"><a href="#cb126-563" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-564"><a href="#cb126-564" aria-hidden="true" tabindex="-1"></a><span class="fu">## Preprocessor Pipeline</span></span>
<span id="cb126-565"><a href="#cb126-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-568"><a href="#cb126-568" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-569"><a href="#cb126-569" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb126-570"><a href="#cb126-570" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> OneHotEncoder, MinMaxScaler</span>
<span id="cb126-571"><a href="#cb126-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-572"><a href="#cb126-572" aria-hidden="true" tabindex="-1"></a>categoric_transformer <span class="op">=</span> OneHotEncoder(handle_unknown<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb126-573"><a href="#cb126-573" aria-hidden="true" tabindex="-1"></a>numeric_transformer <span class="op">=</span> MinMaxScaler()</span>
<span id="cb126-574"><a href="#cb126-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-575"><a href="#cb126-575" aria-hidden="true" tabindex="-1"></a>preprocessor <span class="op">=</span> ColumnTransformer(transformers<span class="op">=</span>[(<span class="st">'categoric'</span>, categoric_transformer, categoric_columns),</span>
<span id="cb126-576"><a href="#cb126-576" aria-hidden="true" tabindex="-1"></a>                                               (<span class="st">'numeric'</span>, numeric_transformer, numeric_columns)],</span>
<span id="cb126-577"><a href="#cb126-577" aria-hidden="true" tabindex="-1"></a>                                remainder<span class="op">=</span><span class="st">'passthrough'</span>,</span>
<span id="cb126-578"><a href="#cb126-578" aria-hidden="true" tabindex="-1"></a>                                verbose_feature_names_out<span class="op">=</span><span class="va">False</span></span>
<span id="cb126-579"><a href="#cb126-579" aria-hidden="true" tabindex="-1"></a>                                )</span>
<span id="cb126-580"><a href="#cb126-580" aria-hidden="true" tabindex="-1"></a><span class="in">```</span>                                </span>
<span id="cb126-581"><a href="#cb126-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-582"><a href="#cb126-582" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 7: Validation Curves</span></span>
<span id="cb126-583"><a href="#cb126-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-584"><a href="#cb126-584" aria-hidden="true" tabindex="-1"></a><span class="fu">## Baseline Model</span></span>
<span id="cb126-585"><a href="#cb126-585" aria-hidden="true" tabindex="-1"></a>This model always predicts the mean value of <span class="in">`y_train`</span> and doesn't consider the features. Ideally, our best performing model should do better than this baseline model.</span>
<span id="cb126-586"><a href="#cb126-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-589"><a href="#cb126-589" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-590"><a href="#cb126-590" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb126-591"><a href="#cb126-591" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb126-592"><a href="#cb126-592" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb126-593"><a href="#cb126-593" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.sklearn</span>
<span id="cb126-594"><a href="#cb126-594" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.dummy <span class="im">import</span> DummyRegressor</span>
<span id="cb126-595"><a href="#cb126-595" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, r2_score</span>
<span id="cb126-596"><a href="#cb126-596" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mlflow.models.signature <span class="im">import</span> infer_signature</span>
<span id="cb126-597"><a href="#cb126-597" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.plots <span class="im">import</span> prediction_error_display</span>
<span id="cb126-598"><a href="#cb126-598" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> utils.plots <span class="im">import</span> validation_curve_display</span>
<span id="cb126-599"><a href="#cb126-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-600"><a href="#cb126-600" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure X_train and X_test are DataFrames or convertible to one</span></span>
<span id="cb126-601"><a href="#cb126-601" aria-hidden="true" tabindex="-1"></a>X_train_df <span class="op">=</span> pd.DataFrame(X_train)</span>
<span id="cb126-602"><a href="#cb126-602" aria-hidden="true" tabindex="-1"></a>X_test_df <span class="op">=</span> pd.DataFrame(X_test)</span>
<span id="cb126-603"><a href="#cb126-603" aria-hidden="true" tabindex="-1"></a>y_train_series <span class="op">=</span> pd.Series(y_train)</span>
<span id="cb126-604"><a href="#cb126-604" aria-hidden="true" tabindex="-1"></a>y_test_series <span class="op">=</span> pd.Series(y_test)</span>
<span id="cb126-605"><a href="#cb126-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-606"><a href="#cb126-606" aria-hidden="true" tabindex="-1"></a><span class="co"># Set tracking URI and experiment name</span></span>
<span id="cb126-607"><a href="#cb126-607" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns"</span>)</span>
<span id="cb126-608"><a href="#cb126-608" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"dummy_baseline"</span>)</span>
<span id="cb126-609"><a href="#cb126-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-610"><a href="#cb126-610" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb126-611"><a href="#cb126-611" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"Dummy Regressor"</span>):</span>
<span id="cb126-612"><a href="#cb126-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-613"><a href="#cb126-613" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the Dummy Regressor</span></span>
<span id="cb126-614"><a href="#cb126-614" aria-hidden="true" tabindex="-1"></a>    dummy <span class="op">=</span> DummyRegressor(strategy<span class="op">=</span><span class="st">"mean"</span>)</span>
<span id="cb126-615"><a href="#cb126-615" aria-hidden="true" tabindex="-1"></a>    dummy.fit(X_train_df, y_train_series)</span>
<span id="cb126-616"><a href="#cb126-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-617"><a href="#cb126-617" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predict</span></span>
<span id="cb126-618"><a href="#cb126-618" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> dummy.predict(X_test_df)</span>
<span id="cb126-619"><a href="#cb126-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-620"><a href="#cb126-620" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute metrics</span></span>
<span id="cb126-621"><a href="#cb126-621" aria-hidden="true" tabindex="-1"></a>    mse <span class="op">=</span> mean_squared_error(y_test_series, y_pred)</span>
<span id="cb126-622"><a href="#cb126-622" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> r2_score(y_test_series, y_pred)</span>
<span id="cb126-623"><a href="#cb126-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-624"><a href="#cb126-624" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log parameters and metrics</span></span>
<span id="cb126-625"><a href="#cb126-625" aria-hidden="true" tabindex="-1"></a>    mlflow.log_param(<span class="st">"strategy"</span>, <span class="st">"mean"</span>)</span>
<span id="cb126-626"><a href="#cb126-626" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"mse"</span>, mse)</span>
<span id="cb126-627"><a href="#cb126-627" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"r2"</span>, r2)</span>
<span id="cb126-628"><a href="#cb126-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-629"><a href="#cb126-629" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log the model with signature</span></span>
<span id="cb126-630"><a href="#cb126-630" aria-hidden="true" tabindex="-1"></a>    signature <span class="op">=</span> infer_signature(X_test_df, y_pred)</span>
<span id="cb126-631"><a href="#cb126-631" aria-hidden="true" tabindex="-1"></a>    mlflow.sklearn.log_model(</span>
<span id="cb126-632"><a href="#cb126-632" aria-hidden="true" tabindex="-1"></a>        sk_model<span class="op">=</span>dummy,</span>
<span id="cb126-633"><a href="#cb126-633" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"dummy_model"</span>,  <span class="co"># Use `name=` instead of `artifact_path=`</span></span>
<span id="cb126-634"><a href="#cb126-634" aria-hidden="true" tabindex="-1"></a>        signature<span class="op">=</span>signature,</span>
<span id="cb126-635"><a href="#cb126-635" aria-hidden="true" tabindex="-1"></a>        registered_model_name<span class="op">=</span><span class="st">'baseline_dummy'</span>,</span>
<span id="cb126-636"><a href="#cb126-636" aria-hidden="true" tabindex="-1"></a>        input_example<span class="op">=</span>X_test_df.head(<span class="dv">5</span>)</span>
<span id="cb126-637"><a href="#cb126-637" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-638"><a href="#cb126-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-639"><a href="#cb126-639" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create and save the prediction error plot</span></span>
<span id="cb126-640"><a href="#cb126-640" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fig, ax = plt.subplots(figsize=(15, 6))</span></span>
<span id="cb126-641"><a href="#cb126-641" aria-hidden="true" tabindex="-1"></a>    display <span class="op">=</span> prediction_error_display(y_test<span class="op">=</span>y_test, y_pred<span class="op">=</span>y_pred)</span>
<span id="cb126-642"><a href="#cb126-642" aria-hidden="true" tabindex="-1"></a>    <span class="co"># display.plot(ax=ax)</span></span>
<span id="cb126-643"><a href="#cb126-643" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plt.title("Prediction Error Plot")</span></span>
<span id="cb126-644"><a href="#cb126-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-645"><a href="#cb126-645" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save and log as artifact</span></span>
<span id="cb126-646"><a href="#cb126-646" aria-hidden="true" tabindex="-1"></a>    artifact_dir <span class="op">=</span> <span class="st">"mlflow_artifacts"</span></span>
<span id="cb126-647"><a href="#cb126-647" aria-hidden="true" tabindex="-1"></a>    os.makedirs(artifact_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-648"><a href="#cb126-648" aria-hidden="true" tabindex="-1"></a>    plot_path <span class="op">=</span> os.path.join(artifact_dir, <span class="st">"prediction_error.png"</span>)</span>
<span id="cb126-649"><a href="#cb126-649" aria-hidden="true" tabindex="-1"></a>    display.savefig(plot_path)</span>
<span id="cb126-650"><a href="#cb126-650" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb126-651"><a href="#cb126-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-652"><a href="#cb126-652" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(plot_path)</span>
<span id="cb126-653"><a href="#cb126-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-654"><a href="#cb126-654" aria-hidden="true" tabindex="-1"></a>    mlflow.end_run()</span>
<span id="cb126-655"><a href="#cb126-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-656"><a href="#cb126-656" aria-hidden="true" tabindex="-1"></a><span class="co"># print(mlflow.search_experiments()) </span></span>
<span id="cb126-657"><a href="#cb126-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-658"><a href="#cb126-658" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-659"><a href="#cb126-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-662"><a href="#cb126-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-663"><a href="#cb126-663" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-show: hide</span></span>
<span id="cb126-664"><a href="#cb126-664" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVR</span>
<span id="cb126-665"><a href="#cb126-665" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb126-666"><a href="#cb126-666" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb126-667"><a href="#cb126-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-668"><a href="#cb126-668" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns"</span>)</span>
<span id="cb126-669"><a href="#cb126-669" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"svr_reg"</span>)</span>
<span id="cb126-670"><a href="#cb126-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-671"><a href="#cb126-671" aria-hidden="true" tabindex="-1"></a>artifact_dir <span class="op">=</span> <span class="st">"mlflow_artifacts_svr"</span></span>
<span id="cb126-672"><a href="#cb126-672" aria-hidden="true" tabindex="-1"></a>os.makedirs(artifact_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-673"><a href="#cb126-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-674"><a href="#cb126-674" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb126-675"><a href="#cb126-675" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"SVR Regressor"</span>):</span>
<span id="cb126-676"><a href="#cb126-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-677"><a href="#cb126-677" aria-hidden="true" tabindex="-1"></a>  param_grid <span class="op">=</span> {</span>
<span id="cb126-678"><a href="#cb126-678" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__C'</span>: [<span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1100</span>],   <span class="co"># narrowed down from plot results</span></span>
<span id="cb126-679"><a href="#cb126-679" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__epsilon'</span>: [<span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>],    <span class="co"># narrowed down from plot results</span></span>
<span id="cb126-680"><a href="#cb126-680" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__gamma'</span>: [<span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>],  <span class="co"># narrowed down</span></span>
<span id="cb126-681"><a href="#cb126-681" aria-hidden="true" tabindex="-1"></a>      <span class="st">'svr__kernel'</span>: [<span class="st">'rbf'</span>, <span class="st">'poly'</span>, <span class="st">'linear'</span>]    <span class="co"># chose the best-performing kernels from plots</span></span>
<span id="cb126-682"><a href="#cb126-682" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-683"><a href="#cb126-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-684"><a href="#cb126-684" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the pipeline with GridSearchCV</span></span>
<span id="cb126-685"><a href="#cb126-685" aria-hidden="true" tabindex="-1"></a>  svr_pipeline <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(max_iter<span class="op">=</span><span class="dv">500</span>))])</span>
<span id="cb126-686"><a href="#cb126-686" aria-hidden="true" tabindex="-1"></a>  svr_model <span class="op">=</span> GridSearchCV(svr_pipeline, param_grid, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>, n_jobs<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb126-687"><a href="#cb126-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-688"><a href="#cb126-688" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit GridSearchCV</span></span>
<span id="cb126-689"><a href="#cb126-689" aria-hidden="true" tabindex="-1"></a>  svr_model.fit(X_train, y_train)</span>
<span id="cb126-690"><a href="#cb126-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-691"><a href="#cb126-691" aria-hidden="true" tabindex="-1"></a>  best_model <span class="op">=</span> svr_model.best_estimator_</span>
<span id="cb126-692"><a href="#cb126-692" aria-hidden="true" tabindex="-1"></a>  y_pred_test <span class="op">=</span> best_model.predict(X_test)</span>
<span id="cb126-693"><a href="#cb126-693" aria-hidden="true" tabindex="-1"></a>  test_rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test, y_pred_test))</span>
<span id="cb126-694"><a href="#cb126-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-695"><a href="#cb126-695" aria-hidden="true" tabindex="-1"></a>  <span class="co"># CV results</span></span>
<span id="cb126-696"><a href="#cb126-696" aria-hidden="true" tabindex="-1"></a>  cv_results <span class="op">=</span> pd.DataFrame(svr_model.cv_results_).sort_values(by<span class="op">=</span><span class="st">'rank_test_score'</span>).head(<span class="dv">5</span>)</span>
<span id="cb126-697"><a href="#cb126-697" aria-hidden="true" tabindex="-1"></a>  cv_results <span class="op">=</span> cv_results[[<span class="st">'params'</span>, <span class="st">'mean_test_score'</span>, <span class="st">'std_test_score'</span>, <span class="st">'rank_test_score'</span>]]</span>
<span id="cb126-698"><a href="#cb126-698" aria-hidden="true" tabindex="-1"></a>  cv_results[<span class="st">'mean_test_score'</span>] <span class="op">=</span> <span class="op">-</span>cv_results[<span class="st">'mean_test_score'</span>]</span>
<span id="cb126-699"><a href="#cb126-699" aria-hidden="true" tabindex="-1"></a>  cv_results.to_csv(<span class="st">"mlflow_artifacts_svr/svr_cv_results.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb126-700"><a href="#cb126-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-701"><a href="#cb126-701" aria-hidden="true" tabindex="-1"></a>  <span class="co">#MLflow logging</span></span>
<span id="cb126-702"><a href="#cb126-702" aria-hidden="true" tabindex="-1"></a>  mlflow.log_params(svr_model.best_params_)</span>
<span id="cb126-703"><a href="#cb126-703" aria-hidden="true" tabindex="-1"></a>  mlflow.log_metric(<span class="st">"train_rmse"</span>, np.sqrt(<span class="op">-</span>svr_model.best_score_))</span>
<span id="cb126-704"><a href="#cb126-704" aria-hidden="true" tabindex="-1"></a>  mlflow.log_metric(<span class="st">"test_rmse"</span>, test_rmse)</span>
<span id="cb126-705"><a href="#cb126-705" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mlflow.sklearn.log_model(best_model, name="model")</span></span>
<span id="cb126-706"><a href="#cb126-706" aria-hidden="true" tabindex="-1"></a>  mlflow.sklearn.log_model(</span>
<span id="cb126-707"><a href="#cb126-707" aria-hidden="true" tabindex="-1"></a>    best_model,</span>
<span id="cb126-708"><a href="#cb126-708" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb126-709"><a href="#cb126-709" aria-hidden="true" tabindex="-1"></a>    input_example<span class="op">=</span>X_test.iloc[:<span class="dv">1</span>]</span>
<span id="cb126-710"><a href="#cb126-710" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-711"><a href="#cb126-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-712"><a href="#cb126-712" aria-hidden="true" tabindex="-1"></a>  mlflow.log_artifact(<span class="st">"mlflow_artifacts_svr/svr_cv_results.csv"</span>)</span>
<span id="cb126-713"><a href="#cb126-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-714"><a href="#cb126-714" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fig, ax = plt.subplots()</span></span>
<span id="cb126-715"><a href="#cb126-715" aria-hidden="true" tabindex="-1"></a>  display <span class="op">=</span> prediction_error_display(y_test<span class="op">=</span>y_test, y_pred<span class="op">=</span>y_pred_test)</span>
<span id="cb126-716"><a href="#cb126-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-717"><a href="#cb126-717" aria-hidden="true" tabindex="-1"></a>  plot_path <span class="op">=</span> os.path.join(artifact_dir, <span class="st">"acutual_vs_predicted.png"</span>)</span>
<span id="cb126-718"><a href="#cb126-718" aria-hidden="true" tabindex="-1"></a>  display.savefig(plot_path)</span>
<span id="cb126-719"><a href="#cb126-719" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plt.close()</span></span>
<span id="cb126-720"><a href="#cb126-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-721"><a href="#cb126-721" aria-hidden="true" tabindex="-1"></a>  mlflow.log_artifact(plot_path)</span>
<span id="cb126-722"><a href="#cb126-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-723"><a href="#cb126-723" aria-hidden="true" tabindex="-1"></a>  mlflow.end_run()</span>
<span id="cb126-724"><a href="#cb126-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-725"><a href="#cb126-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-728"><a href="#cb126-728" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-729"><a href="#cb126-729" aria-hidden="true" tabindex="-1"></a>exp <span class="op">=</span> mlflow.set_experiment(<span class="st">"svr_reg"</span>)</span>
<span id="cb126-730"><a href="#cb126-730" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Experiment ID:"</span>, exp.experiment_id)</span>
<span id="cb126-731"><a href="#cb126-731" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Tracking URI:"</span>, mlflow.get_tracking_uri())</span>
<span id="cb126-732"><a href="#cb126-732" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-733"><a href="#cb126-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-736"><a href="#cb126-736" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-737"><a href="#cb126-737" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb126-738"><a href="#cb126-738" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> ValidationCurveDisplay, validation_curve</span>
<span id="cb126-739"><a href="#cb126-739" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb126-740"><a href="#cb126-740" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb126-741"><a href="#cb126-741" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb126-742"><a href="#cb126-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-743"><a href="#cb126-743" aria-hidden="true" tabindex="-1"></a><span class="co"># Define your parameter range</span></span>
<span id="cb126-744"><a href="#cb126-744" aria-hidden="true" tabindex="-1"></a><span class="co"># param_range = [100, 300, 500, 700, 1000, 1100, 1200]</span></span>
<span id="cb126-745"><a href="#cb126-745" aria-hidden="true" tabindex="-1"></a><span class="co"># tscv = TimeSeriesSplit(n_splits=5)</span></span>
<span id="cb126-746"><a href="#cb126-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-747"><a href="#cb126-747" aria-hidden="true" tabindex="-1"></a><span class="co"># Start MLflow run</span></span>
<span id="cb126-748"><a href="#cb126-748" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"Validation Curve - SVR__C"</span>):</span>
<span id="cb126-749"><a href="#cb126-749" aria-hidden="true" tabindex="-1"></a>  fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb126-750"><a href="#cb126-750" aria-hidden="true" tabindex="-1"></a>  param_range <span class="op">=</span> [<span class="dv">0</span>, <span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">800</span>, <span class="dv">1000</span>]</span>
<span id="cb126-751"><a href="#cb126-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-752"><a href="#cb126-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-753"><a href="#cb126-753" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create and save validation curve</span></span>
<span id="cb126-754"><a href="#cb126-754" aria-hidden="true" tabindex="-1"></a>  ValidationCurveDisplay.from_estimator(</span>
<span id="cb126-755"><a href="#cb126-755" aria-hidden="true" tabindex="-1"></a>      estimator<span class="op">=</span>svr_pipeline,</span>
<span id="cb126-756"><a href="#cb126-756" aria-hidden="true" tabindex="-1"></a>      X<span class="op">=</span>X_train,</span>
<span id="cb126-757"><a href="#cb126-757" aria-hidden="true" tabindex="-1"></a>      y<span class="op">=</span>y_train,</span>
<span id="cb126-758"><a href="#cb126-758" aria-hidden="true" tabindex="-1"></a>      param_name<span class="op">=</span><span class="st">"svr__C"</span>,  <span class="co"># use correct param name in pipeline</span></span>
<span id="cb126-759"><a href="#cb126-759" aria-hidden="true" tabindex="-1"></a>      param_range<span class="op">=</span>param_range,</span>
<span id="cb126-760"><a href="#cb126-760" aria-hidden="true" tabindex="-1"></a>      cv<span class="op">=</span>tscv,</span>
<span id="cb126-761"><a href="#cb126-761" aria-hidden="true" tabindex="-1"></a>      scoring<span class="op">=</span><span class="st">"neg_root_mean_squared_error"</span>,</span>
<span id="cb126-762"><a href="#cb126-762" aria-hidden="true" tabindex="-1"></a>      n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb126-763"><a href="#cb126-763" aria-hidden="true" tabindex="-1"></a>      negate_score<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb126-764"><a href="#cb126-764" aria-hidden="true" tabindex="-1"></a>      ax<span class="op">=</span>ax</span>
<span id="cb126-765"><a href="#cb126-765" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb126-766"><a href="#cb126-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-767"><a href="#cb126-767" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set title and save the current plot</span></span>
<span id="cb126-768"><a href="#cb126-768" aria-hidden="true" tabindex="-1"></a>  plt.title(<span class="st">"Validation Curve for SVR (C)"</span>)</span>
<span id="cb126-769"><a href="#cb126-769" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb126-770"><a href="#cb126-770" aria-hidden="true" tabindex="-1"></a>  artifact_dir <span class="op">=</span> <span class="st">"mlflow_artifacts_svr"</span></span>
<span id="cb126-771"><a href="#cb126-771" aria-hidden="true" tabindex="-1"></a>  os.makedirs(artifact_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-772"><a href="#cb126-772" aria-hidden="true" tabindex="-1"></a>  plot_path <span class="op">=</span> os.path.join(artifact_dir, <span class="st">"validation_curve_svr_C.png"</span>)</span>
<span id="cb126-773"><a href="#cb126-773" aria-hidden="true" tabindex="-1"></a>  plt.savefig(plot_path)</span>
<span id="cb126-774"><a href="#cb126-774" aria-hidden="true" tabindex="-1"></a>  plt.close()</span>
<span id="cb126-775"><a href="#cb126-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-776"><a href="#cb126-776" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log the plot to MLflow</span></span>
<span id="cb126-777"><a href="#cb126-777" aria-hidden="true" tabindex="-1"></a>  mlflow.log_artifact(plot_path)</span>
<span id="cb126-778"><a href="#cb126-778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-779"><a href="#cb126-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-780"><a href="#cb126-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-783"><a href="#cb126-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-784"><a href="#cb126-784" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.svm <span class="im">import</span> SVR</span>
<span id="cb126-785"><a href="#cb126-785" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeRegressor</span>
<span id="cb126-786"><a href="#cb126-786" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> ExtraTreesRegressor, AdaBoostRegressor</span>
<span id="cb126-787"><a href="#cb126-787" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb126-788"><a href="#cb126-788" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb126-789"><a href="#cb126-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-790"><a href="#cb126-790" aria-hidden="true" tabindex="-1"></a>candidate_models <span class="op">=</span> {</span>
<span id="cb126-791"><a href="#cb126-791" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Support Vector Regressor"</span>: {</span>
<span id="cb126-792"><a href="#cb126-792" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(max_iter<span class="op">=</span><span class="dv">500</span>))]),</span>
<span id="cb126-793"><a href="#cb126-793" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-794"><a href="#cb126-794" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__C"</span>: [<span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1100</span>],</span>
<span id="cb126-795"><a href="#cb126-795" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__epsilon"</span>: [<span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>],</span>
<span id="cb126-796"><a href="#cb126-796" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__gamma"</span>: [<span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>],</span>
<span id="cb126-797"><a href="#cb126-797" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-798"><a href="#cb126-798" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-799"><a href="#cb126-799" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Extra Trees Regressor"</span>: {</span>
<span id="cb126-800"><a href="#cb126-800" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'etr'</span>, ExtraTreesRegressor())]),</span>
<span id="cb126-801"><a href="#cb126-801" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-802"><a href="#cb126-802" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_split"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>],</span>
<span id="cb126-803"><a href="#cb126-803" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__n_estimators"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">75</span>],</span>
<span id="cb126-804"><a href="#cb126-804" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__max_depth"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>],</span>
<span id="cb126-805"><a href="#cb126-805" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_leaf"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">10</span>]</span>
<span id="cb126-806"><a href="#cb126-806" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-807"><a href="#cb126-807" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-808"><a href="#cb126-808" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ada Boost Regressor"</span>: {</span>
<span id="cb126-809"><a href="#cb126-809" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), </span>
<span id="cb126-810"><a href="#cb126-810" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'ada'</span>, AdaBoostRegressor(DecisionTreeRegressor()))]),</span>
<span id="cb126-811"><a href="#cb126-811" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-812"><a href="#cb126-812" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__n_estimators"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">125</span>],</span>
<span id="cb126-813"><a href="#cb126-813" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__learning_rate"</span>: [<span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.04</span>, <span class="fl">0.06</span>],</span>
<span id="cb126-814"><a href="#cb126-814" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-815"><a href="#cb126-815" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-816"><a href="#cb126-816" aria-hidden="true" tabindex="-1"></a>    <span class="st">"XGBoost Regressor"</span>: {</span>
<span id="cb126-817"><a href="#cb126-817" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pipeline"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb126-818"><a href="#cb126-818" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'xgb'</span>, XGBRegressor())]),</span>
<span id="cb126-819"><a href="#cb126-819" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-820"><a href="#cb126-820" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__n_estimators"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">125</span>],</span>
<span id="cb126-821"><a href="#cb126-821" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__learning_rate"</span>: [<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>],</span>
<span id="cb126-822"><a href="#cb126-822" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__max_depth"</span>: [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>]</span>
<span id="cb126-823"><a href="#cb126-823" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-824"><a href="#cb126-824" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-825"><a href="#cb126-825" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-826"><a href="#cb126-826" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-827"><a href="#cb126-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-828"><a href="#cb126-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-831"><a href="#cb126-831" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-832"><a href="#cb126-832" aria-hidden="true" tabindex="-1"></a><span class="co">#| output: false</span></span>
<span id="cb126-833"><a href="#cb126-833" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb126-834"><a href="#cb126-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-835"><a href="#cb126-835" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, model_data <span class="kw">in</span> candidate_models.items():</span>
<span id="cb126-836"><a href="#cb126-836" aria-hidden="true" tabindex="-1"></a>    pipe <span class="op">=</span> model_data[<span class="st">"pipeline"</span>]</span>
<span id="cb126-837"><a href="#cb126-837" aria-hidden="true" tabindex="-1"></a>    param_grid <span class="op">=</span> model_data[<span class="st">"param_grid"</span>]</span>
<span id="cb126-838"><a href="#cb126-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-839"><a href="#cb126-839" aria-hidden="true" tabindex="-1"></a>    mlflow.set_experiment(<span class="ss">f"Validation_</span><span class="sc">{</span>model_name<span class="sc">.</span>replace(<span class="st">' '</span>, <span class="st">'_'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb126-840"><a href="#cb126-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-841"><a href="#cb126-841" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"validation_curves"</span>):</span>
<span id="cb126-842"><a href="#cb126-842" aria-hidden="true" tabindex="-1"></a>        folder_path <span class="op">=</span> <span class="ss">f"validation_curves/</span><span class="sc">{</span>model_name<span class="sc">.</span>replace(<span class="st">' '</span>, <span class="st">'_'</span>)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb126-843"><a href="#cb126-843" aria-hidden="true" tabindex="-1"></a>        os.makedirs(folder_path, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-844"><a href="#cb126-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-845"><a href="#cb126-845" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> param, values <span class="kw">in</span> param_grid.items():</span>
<span id="cb126-846"><a href="#cb126-846" aria-hidden="true" tabindex="-1"></a>            fig <span class="op">=</span> validation_curve_display(</span>
<span id="cb126-847"><a href="#cb126-847" aria-hidden="true" tabindex="-1"></a>                estimator<span class="op">=</span>pipe,</span>
<span id="cb126-848"><a href="#cb126-848" aria-hidden="true" tabindex="-1"></a>                X<span class="op">=</span>X_train,</span>
<span id="cb126-849"><a href="#cb126-849" aria-hidden="true" tabindex="-1"></a>                y<span class="op">=</span>y_train,</span>
<span id="cb126-850"><a href="#cb126-850" aria-hidden="true" tabindex="-1"></a>                param_name<span class="op">=</span>param,</span>
<span id="cb126-851"><a href="#cb126-851" aria-hidden="true" tabindex="-1"></a>                param_range<span class="op">=</span>values,</span>
<span id="cb126-852"><a href="#cb126-852" aria-hidden="true" tabindex="-1"></a>                cv<span class="op">=</span>tscv,</span>
<span id="cb126-853"><a href="#cb126-853" aria-hidden="true" tabindex="-1"></a>                scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>,</span>
<span id="cb126-854"><a href="#cb126-854" aria-hidden="true" tabindex="-1"></a>                negate_score<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb126-855"><a href="#cb126-855" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb126-856"><a href="#cb126-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-857"><a href="#cb126-857" aria-hidden="true" tabindex="-1"></a>            fig_path <span class="op">=</span> os.path.join(folder_path, <span class="ss">f"</span><span class="sc">{</span>param<span class="sc">.</span>split(<span class="st">'__'</span>)[<span class="dv">1</span>]<span class="sc">}</span><span class="ss">.png"</span>)</span>
<span id="cb126-858"><a href="#cb126-858" aria-hidden="true" tabindex="-1"></a>            fig.savefig(fig_path)</span>
<span id="cb126-859"><a href="#cb126-859" aria-hidden="true" tabindex="-1"></a>            mlflow.log_artifact(fig_path)</span>
<span id="cb126-860"><a href="#cb126-860" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-861"><a href="#cb126-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-864"><a href="#cb126-864" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-865"><a href="#cb126-865" aria-hidden="true" tabindex="-1"></a><span class="co"># from shiny import render, ui, reactive</span></span>
<span id="cb126-866"><a href="#cb126-866" aria-hidden="true" tabindex="-1"></a><span class="co"># from pathlib import Path</span></span>
<span id="cb126-867"><a href="#cb126-867" aria-hidden="true" tabindex="-1"></a><span class="co"># from PIL import Image</span></span>
<span id="cb126-868"><a href="#cb126-868" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib.pyplot as plt</span></span>
<span id="cb126-869"><a href="#cb126-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-870"><a href="#cb126-870" aria-hidden="true" tabindex="-1"></a><span class="co"># model_options = list(candidate_models.keys())</span></span>
<span id="cb126-871"><a href="#cb126-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-872"><a href="#cb126-872" aria-hidden="true" tabindex="-1"></a><span class="co"># @reactive.Calc</span></span>
<span id="cb126-873"><a href="#cb126-873" aria-hidden="true" tabindex="-1"></a><span class="co"># def selected_model_folder():</span></span>
<span id="cb126-874"><a href="#cb126-874" aria-hidden="true" tabindex="-1"></a><span class="co">#     return Path(f"validation_curves/{"_".join(input.model().split())}")</span></span>
<span id="cb126-875"><a href="#cb126-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-876"><a href="#cb126-876" aria-hidden="true" tabindex="-1"></a><span class="co"># @render.ui</span></span>
<span id="cb126-877"><a href="#cb126-877" aria-hidden="true" tabindex="-1"></a><span class="co"># def dropdown():</span></span>
<span id="cb126-878"><a href="#cb126-878" aria-hidden="true" tabindex="-1"></a><span class="co">#     return ui.input_select("model", "Select a model", choices=model_options)</span></span>
<span id="cb126-879"><a href="#cb126-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-880"><a href="#cb126-880" aria-hidden="true" tabindex="-1"></a><span class="co"># @render.plot</span></span>
<span id="cb126-881"><a href="#cb126-881" aria-hidden="true" tabindex="-1"></a><span class="co"># def show_all_param_plots():</span></span>
<span id="cb126-882"><a href="#cb126-882" aria-hidden="true" tabindex="-1"></a><span class="co">#     folder = selected_model_folder()</span></span>
<span id="cb126-883"><a href="#cb126-883" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = [f for f in folder.glob("*.png")]</span></span>
<span id="cb126-884"><a href="#cb126-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-885"><a href="#cb126-885" aria-hidden="true" tabindex="-1"></a><span class="co">#     # fig, axs = plt.subplots(len(params), 1, figsize=(8, 20))</span></span>
<span id="cb126-886"><a href="#cb126-886" aria-hidden="true" tabindex="-1"></a><span class="co">#     fig, axs = plt.subplots(len(params), 1, figsize=(10, 10 * len(params)))  # Increase height per plot</span></span>
<span id="cb126-887"><a href="#cb126-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-888"><a href="#cb126-888" aria-hidden="true" tabindex="-1"></a><span class="co">#     if len(params) == 1:</span></span>
<span id="cb126-889"><a href="#cb126-889" aria-hidden="true" tabindex="-1"></a><span class="co">#         axs = [axs]</span></span>
<span id="cb126-890"><a href="#cb126-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-891"><a href="#cb126-891" aria-hidden="true" tabindex="-1"></a><span class="co">#     for ax, param_file in zip(axs, params):</span></span>
<span id="cb126-892"><a href="#cb126-892" aria-hidden="true" tabindex="-1"></a><span class="co">#         img = Image.open(param_file)</span></span>
<span id="cb126-893"><a href="#cb126-893" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax.imshow(img)</span></span>
<span id="cb126-894"><a href="#cb126-894" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax.set_title(param_file.stem)</span></span>
<span id="cb126-895"><a href="#cb126-895" aria-hidden="true" tabindex="-1"></a><span class="co">#         ax.axis("off")</span></span>
<span id="cb126-896"><a href="#cb126-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-897"><a href="#cb126-897" aria-hidden="true" tabindex="-1"></a><span class="co">#     # plt.tight_layout()</span></span>
<span id="cb126-898"><a href="#cb126-898" aria-hidden="true" tabindex="-1"></a><span class="co">#     return fig</span></span>
<span id="cb126-899"><a href="#cb126-899" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-900"><a href="#cb126-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-903"><a href="#cb126-903" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-904"><a href="#cb126-904" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shiny <span class="im">import</span> reactive, render, ui, req</span>
<span id="cb126-905"><a href="#cb126-905" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb126-906"><a href="#cb126-906" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb126-907"><a href="#cb126-907" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb126-908"><a href="#cb126-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-909"><a href="#cb126-909" aria-hidden="true" tabindex="-1"></a><span class="co"># Base path to saved validation curve plots</span></span>
<span id="cb126-910"><a href="#cb126-910" aria-hidden="true" tabindex="-1"></a>base_path <span class="op">=</span> Path(<span class="st">"validation_curves"</span>)</span>
<span id="cb126-911"><a href="#cb126-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-912"><a href="#cb126-912" aria-hidden="true" tabindex="-1"></a><span class="co"># Automatically extract model names from subfolders</span></span>
<span id="cb126-913"><a href="#cb126-913" aria-hidden="true" tabindex="-1"></a>model_names <span class="op">=</span> <span class="bu">sorted</span>([f.name <span class="cf">for</span> f <span class="kw">in</span> base_path.iterdir() <span class="cf">if</span> f.is_dir()])</span>
<span id="cb126-914"><a href="#cb126-914" aria-hidden="true" tabindex="-1"></a>default_model <span class="op">=</span> model_names[<span class="dv">0</span>] <span class="cf">if</span> model_names <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb126-915"><a href="#cb126-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-916"><a href="#cb126-916" aria-hidden="true" tabindex="-1"></a><span class="co"># Model dropdown</span></span>
<span id="cb126-917"><a href="#cb126-917" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb126-918"><a href="#cb126-918" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dropdown_model():</span>
<span id="cb126-919"><a href="#cb126-919" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.input_select(</span>
<span id="cb126-920"><a href="#cb126-920" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb126-921"><a href="#cb126-921" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Select Model"</span>,</span>
<span id="cb126-922"><a href="#cb126-922" aria-hidden="true" tabindex="-1"></a>        choices<span class="op">=</span>model_names,</span>
<span id="cb126-923"><a href="#cb126-923" aria-hidden="true" tabindex="-1"></a>        selected<span class="op">=</span>default_model,</span>
<span id="cb126-924"><a href="#cb126-924" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-925"><a href="#cb126-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-926"><a href="#cb126-926" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamically get folder path of selected model</span></span>
<span id="cb126-927"><a href="#cb126-927" aria-hidden="true" tabindex="-1"></a><span class="at">@reactive.Calc</span></span>
<span id="cb126-928"><a href="#cb126-928" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_folder():</span>
<span id="cb126-929"><a href="#cb126-929" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> base_path <span class="op">/</span> <span class="bu">input</span>.model()</span>
<span id="cb126-930"><a href="#cb126-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-931"><a href="#cb126-931" aria-hidden="true" tabindex="-1"></a><span class="co"># Dynamically list available parameter plots in that model's folder</span></span>
<span id="cb126-932"><a href="#cb126-932" aria-hidden="true" tabindex="-1"></a><span class="at">@reactive.Calc</span></span>
<span id="cb126-933"><a href="#cb126-933" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> available_params():</span>
<span id="cb126-934"><a href="#cb126-934" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> model_folder()</span>
<span id="cb126-935"><a href="#cb126-935" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sorted</span>([f.stem <span class="cf">for</span> f <span class="kw">in</span> folder.glob(<span class="st">"*.png"</span>)])</span>
<span id="cb126-936"><a href="#cb126-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-937"><a href="#cb126-937" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter dropdown, reacts to model change</span></span>
<span id="cb126-938"><a href="#cb126-938" aria-hidden="true" tabindex="-1"></a><span class="at">@render.ui</span></span>
<span id="cb126-939"><a href="#cb126-939" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dropdown_param():</span>
<span id="cb126-940"><a href="#cb126-940" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> available_params()</span>
<span id="cb126-941"><a href="#cb126-941" aria-hidden="true" tabindex="-1"></a>    default_param <span class="op">=</span> params[<span class="dv">0</span>] <span class="cf">if</span> params <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb126-942"><a href="#cb126-942" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ui.input_select(</span>
<span id="cb126-943"><a href="#cb126-943" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span><span class="st">"param"</span>,</span>
<span id="cb126-944"><a href="#cb126-944" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Select Parameter"</span>,</span>
<span id="cb126-945"><a href="#cb126-945" aria-hidden="true" tabindex="-1"></a>        choices<span class="op">=</span>params,</span>
<span id="cb126-946"><a href="#cb126-946" aria-hidden="true" tabindex="-1"></a>        selected<span class="op">=</span>default_param,</span>
<span id="cb126-947"><a href="#cb126-947" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-948"><a href="#cb126-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-949"><a href="#cb126-949" aria-hidden="true" tabindex="-1"></a><span class="co"># Show only one selected plot</span></span>
<span id="cb126-950"><a href="#cb126-950" aria-hidden="true" tabindex="-1"></a><span class="at">@render.plot</span></span>
<span id="cb126-951"><a href="#cb126-951" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_plot():</span>
<span id="cb126-952"><a href="#cb126-952" aria-hidden="true" tabindex="-1"></a>    <span class="co"># req(input.param())</span></span>
<span id="cb126-953"><a href="#cb126-953" aria-hidden="true" tabindex="-1"></a>    <span class="co"># req(input.model())</span></span>
<span id="cb126-954"><a href="#cb126-954" aria-hidden="true" tabindex="-1"></a>    folder <span class="op">=</span> model_folder()</span>
<span id="cb126-955"><a href="#cb126-955" aria-hidden="true" tabindex="-1"></a>    param_file <span class="op">=</span> folder <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span><span class="bu">input</span><span class="sc">.</span>param()<span class="sc">}</span><span class="ss">.png"</span></span>
<span id="cb126-956"><a href="#cb126-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-957"><a href="#cb126-957" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if not param_file.exists():</span></span>
<span id="cb126-958"><a href="#cb126-958" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     raise FileNotFoundError(f"Missing: {param_file}")</span></span>
<span id="cb126-959"><a href="#cb126-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-960"><a href="#cb126-960" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> param_file.exists():</span>
<span id="cb126-961"><a href="#cb126-961" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>  <span class="co"># silently skip rendering</span></span>
<span id="cb126-962"><a href="#cb126-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-963"><a href="#cb126-963" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(param_file)</span>
<span id="cb126-964"><a href="#cb126-964" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">20</span>))</span>
<span id="cb126-965"><a href="#cb126-965" aria-hidden="true" tabindex="-1"></a>    ax.imshow(img)</span>
<span id="cb126-966"><a href="#cb126-966" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span><span class="bu">input</span><span class="sc">.</span>model()<span class="sc">}</span><span class="ss"> — </span><span class="sc">{</span><span class="bu">input</span><span class="sc">.</span>param()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb126-967"><a href="#cb126-967" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">"off"</span>)</span>
<span id="cb126-968"><a href="#cb126-968" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb126-969"><a href="#cb126-969" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-970"><a href="#cb126-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-971"><a href="#cb126-971" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 8: Hyperparameter Optimization</span></span>
<span id="cb126-972"><a href="#cb126-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-973"><a href="#cb126-973" aria-hidden="true" tabindex="-1"></a>In this chapter, we will do hyperparameter optimization to find out the optimal parameters using sklearn\'s GridSearchCV object.</span>
<span id="cb126-974"><a href="#cb126-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-977"><a href="#cb126-977" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-978"><a href="#cb126-978" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb126-979"><a href="#cb126-979" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb126-980"><a href="#cb126-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-981"><a href="#cb126-981" aria-hidden="true" tabindex="-1"></a>candidate_models <span class="op">=</span> {</span>
<span id="cb126-982"><a href="#cb126-982" aria-hidden="true" tabindex="-1"></a>    <span class="st">"svr"</span>: {</span>
<span id="cb126-983"><a href="#cb126-983" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(max_iter<span class="op">=</span><span class="dv">500</span>))]),</span>
<span id="cb126-984"><a href="#cb126-984" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-985"><a href="#cb126-985" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__C"</span>: [<span class="dv">800</span>, <span class="dv">1000</span>, <span class="dv">1100</span>],</span>
<span id="cb126-986"><a href="#cb126-986" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__epsilon"</span>: [<span class="dv">2</span>, <span class="fl">2.5</span>, <span class="dv">3</span>],</span>
<span id="cb126-987"><a href="#cb126-987" aria-hidden="true" tabindex="-1"></a>            <span class="st">"svr__gamma"</span>: [<span class="fl">0.00001</span>, <span class="fl">0.0001</span>, <span class="fl">0.001</span>],</span>
<span id="cb126-988"><a href="#cb126-988" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-989"><a href="#cb126-989" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-990"><a href="#cb126-990" aria-hidden="true" tabindex="-1"></a>    <span class="st">"extratrees"</span>: {</span>
<span id="cb126-991"><a href="#cb126-991" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'etr'</span>, ExtraTreesRegressor())]),</span>
<span id="cb126-992"><a href="#cb126-992" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-993"><a href="#cb126-993" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__max_depth"</span>: [<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>],</span>
<span id="cb126-994"><a href="#cb126-994" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb126-995"><a href="#cb126-995" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_split"</span>: [<span class="dv">2</span>, <span class="dv">5</span>],</span>
<span id="cb126-996"><a href="#cb126-996" aria-hidden="true" tabindex="-1"></a>            <span class="st">"etr__min_samples_leaf"</span>: [<span class="dv">1</span>, <span class="dv">2</span>]</span>
<span id="cb126-997"><a href="#cb126-997" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-998"><a href="#cb126-998" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-999"><a href="#cb126-999" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xgboost"</span>: {</span>
<span id="cb126-1000"><a href="#cb126-1000" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb126-1001"><a href="#cb126-1001" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'xgb'</span>, XGBRegressor())]),</span>
<span id="cb126-1002"><a href="#cb126-1002" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-1003"><a href="#cb126-1003" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb126-1004"><a href="#cb126-1004" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__max_depth"</span>: [<span class="dv">3</span>, <span class="dv">5</span>],</span>
<span id="cb126-1005"><a href="#cb126-1005" aria-hidden="true" tabindex="-1"></a>            <span class="st">"xgb__learning_rate"</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>]</span>
<span id="cb126-1006"><a href="#cb126-1006" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-1007"><a href="#cb126-1007" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-1008"><a href="#cb126-1008" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adaboost"</span>: {</span>
<span id="cb126-1009"><a href="#cb126-1009" aria-hidden="true" tabindex="-1"></a>        <span class="st">"estimator"</span>: Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), </span>
<span id="cb126-1010"><a href="#cb126-1010" aria-hidden="true" tabindex="-1"></a>                                    (<span class="st">'ada'</span>, AdaBoostRegressor(DecisionTreeRegressor()))]),</span>
<span id="cb126-1011"><a href="#cb126-1011" aria-hidden="true" tabindex="-1"></a>        <span class="st">"param_grid"</span>: {</span>
<span id="cb126-1012"><a href="#cb126-1012" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__n_estimators"</span>: [<span class="dv">50</span>, <span class="dv">100</span>],</span>
<span id="cb126-1013"><a href="#cb126-1013" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ada__learning_rate"</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>]</span>
<span id="cb126-1014"><a href="#cb126-1014" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-1015"><a href="#cb126-1015" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-1016"><a href="#cb126-1016" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-1017"><a href="#cb126-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1018"><a href="#cb126-1018" aria-hidden="true" tabindex="-1"></a>cv_results_dict <span class="op">=</span> {}</span>
<span id="cb126-1019"><a href="#cb126-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1020"><a href="#cb126-1020" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"file:C:/Users/DELL/Desktop/crop_yield/eda/mlruns"</span>)</span>
<span id="cb126-1021"><a href="#cb126-1021" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Hyperparameter_Optimization"</span>)</span>
<span id="cb126-1022"><a href="#cb126-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1023"><a href="#cb126-1023" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, model_info <span class="kw">in</span> candidate_models.items():</span>
<span id="cb126-1024"><a href="#cb126-1024" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_gridsearch"</span>):</span>
<span id="cb126-1025"><a href="#cb126-1025" aria-hidden="true" tabindex="-1"></a>        estimator <span class="op">=</span> model_info[<span class="st">"estimator"</span>]</span>
<span id="cb126-1026"><a href="#cb126-1026" aria-hidden="true" tabindex="-1"></a>        param_grid <span class="op">=</span> model_info[<span class="st">"param_grid"</span>]</span>
<span id="cb126-1027"><a href="#cb126-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1028"><a href="#cb126-1028" aria-hidden="true" tabindex="-1"></a>        grid <span class="op">=</span> GridSearchCV(</span>
<span id="cb126-1029"><a href="#cb126-1029" aria-hidden="true" tabindex="-1"></a>            estimator<span class="op">=</span>estimator,</span>
<span id="cb126-1030"><a href="#cb126-1030" aria-hidden="true" tabindex="-1"></a>            param_grid<span class="op">=</span>param_grid,</span>
<span id="cb126-1031"><a href="#cb126-1031" aria-hidden="true" tabindex="-1"></a>            scoring<span class="op">=</span><span class="st">"neg_root_mean_squared_error"</span>,</span>
<span id="cb126-1032"><a href="#cb126-1032" aria-hidden="true" tabindex="-1"></a>            cv<span class="op">=</span>tscv,</span>
<span id="cb126-1033"><a href="#cb126-1033" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb126-1034"><a href="#cb126-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1035"><a href="#cb126-1035" aria-hidden="true" tabindex="-1"></a>        grid.fit(X_train, y_train)</span>
<span id="cb126-1036"><a href="#cb126-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1037"><a href="#cb126-1037" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get best model &amp; test set RMSE</span></span>
<span id="cb126-1038"><a href="#cb126-1038" aria-hidden="true" tabindex="-1"></a>        best_model <span class="op">=</span> grid.best_estimator_</span>
<span id="cb126-1039"><a href="#cb126-1039" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> best_model.predict(X_test)</span>
<span id="cb126-1040"><a href="#cb126-1040" aria-hidden="true" tabindex="-1"></a>        test_rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test, y_pred))</span>
<span id="cb126-1041"><a href="#cb126-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1042"><a href="#cb126-1042" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log best parameters and test score</span></span>
<span id="cb126-1043"><a href="#cb126-1043" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(grid.best_params_)</span>
<span id="cb126-1044"><a href="#cb126-1044" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"train_rmse"</span>, <span class="op">-</span>grid.best_score_)</span>
<span id="cb126-1045"><a href="#cb126-1045" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"test_rmse"</span>, test_rmse)</span>
<span id="cb126-1046"><a href="#cb126-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1047"><a href="#cb126-1047" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save and log cv_results</span></span>
<span id="cb126-1048"><a href="#cb126-1048" aria-hidden="true" tabindex="-1"></a>        top5 <span class="op">=</span> pd.DataFrame(grid.cv_results_).sort_values(<span class="st">"rank_test_score"</span>).head(<span class="dv">5</span>)</span>
<span id="cb126-1049"><a href="#cb126-1049" aria-hidden="true" tabindex="-1"></a>        full_df <span class="op">=</span> pd.DataFrame(grid.cv_results_)</span>
<span id="cb126-1050"><a href="#cb126-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1051"><a href="#cb126-1051" aria-hidden="true" tabindex="-1"></a>        os.makedirs(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-1052"><a href="#cb126-1052" aria-hidden="true" tabindex="-1"></a>        top5.to_csv(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/top5.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb126-1053"><a href="#cb126-1053" aria-hidden="true" tabindex="-1"></a>        full_df.to_csv(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/full.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb126-1054"><a href="#cb126-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1055"><a href="#cb126-1055" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/top5.csv"</span>)</span>
<span id="cb126-1056"><a href="#cb126-1056" aria-hidden="true" tabindex="-1"></a>        mlflow.log_artifact(<span class="ss">f"grid_search/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">/full.csv"</span>)</span>
<span id="cb126-1057"><a href="#cb126-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1058"><a href="#cb126-1058" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store top5 for Shiny table view</span></span>
<span id="cb126-1059"><a href="#cb126-1059" aria-hidden="true" tabindex="-1"></a>        cv_results_dict[model_name] <span class="op">=</span> top5</span>
<span id="cb126-1060"><a href="#cb126-1060" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1061"><a href="#cb126-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1062"><a href="#cb126-1062" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 8a: Hyperparameter Optimization with Optuna</span></span>
<span id="cb126-1063"><a href="#cb126-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1066"><a href="#cb126-1066" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1067"><a href="#cb126-1067" aria-hidden="true" tabindex="-1"></a><span class="co"># *** Next: Try with Multi objective hyperparameter optimization in Optuna ***</span></span>
<span id="cb126-1068"><a href="#cb126-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1069"><a href="#cb126-1069" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optuna</span>
<span id="cb126-1070"><a href="#cb126-1070" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> optuna_integration.mlflow <span class="im">import</span> MLflowCallback</span>
<span id="cb126-1071"><a href="#cb126-1071" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb126-1072"><a href="#cb126-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1073"><a href="#cb126-1073" aria-hidden="true" tabindex="-1"></a><span class="co"># Mlflow integration</span></span>
<span id="cb126-1074"><a href="#cb126-1074" aria-hidden="true" tabindex="-1"></a>mlflc <span class="op">=</span> MLflowCallback(<span class="st">"file:./mlruns"</span>, metric_name<span class="op">=</span><span class="st">'rmse'</span>)</span>
<span id="cb126-1075"><a href="#cb126-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1076"><a href="#cb126-1076" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective(trial):</span>
<span id="cb126-1077"><a href="#cb126-1077" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Suggest hyperparameters</span></span>
<span id="cb126-1078"><a href="#cb126-1078" aria-hidden="true" tabindex="-1"></a>    <span class="co"># C = trial.suggest_float('C', 1e0, 1e3, log=True)</span></span>
<span id="cb126-1079"><a href="#cb126-1079" aria-hidden="true" tabindex="-1"></a>    <span class="co"># epsilon = trial.suggest_float('epsilon', 1e-3, 1.0, log=True)</span></span>
<span id="cb126-1080"><a href="#cb126-1080" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gamma = trial.suggest_float('gamma', 1e-4, 1e-1, log=True)</span></span>
<span id="cb126-1081"><a href="#cb126-1081" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kernel = trial.suggest_categorical('kernel', ['rbf', 'poly', 'sigmoid'])</span></span>
<span id="cb126-1082"><a href="#cb126-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1083"><a href="#cb126-1083" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Define model</span></span>
<span id="cb126-1084"><a href="#cb126-1084" aria-hidden="true" tabindex="-1"></a>    <span class="co"># svr = SVR(C=C, epsilon=epsilon, gamma=gamma, kernel=kernel)</span></span>
<span id="cb126-1085"><a href="#cb126-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1086"><a href="#cb126-1086" aria-hidden="true" tabindex="-1"></a>    <span class="co"># # Build pipeline (reuse your preprocessing steps)</span></span>
<span id="cb126-1087"><a href="#cb126-1087" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model_pipeline = Pipeline(steps=[('preprocessor', preprocessor),</span></span>
<span id="cb126-1088"><a href="#cb126-1088" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                  ('svr', svr)])</span></span>
<span id="cb126-1089"><a href="#cb126-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1090"><a href="#cb126-1090" aria-hidden="true" tabindex="-1"></a>    <span class="co"># model_pipeline.fit(X_train, y_train)</span></span>
<span id="cb126-1091"><a href="#cb126-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1092"><a href="#cb126-1092" aria-hidden="true" tabindex="-1"></a>    <span class="co"># y_pred = model_pipeline.predict(X_test)</span></span>
<span id="cb126-1093"><a href="#cb126-1093" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rmse = np.sqrt(mean_squared_error(y_test, y_pred))</span></span>
<span id="cb126-1094"><a href="#cb126-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1095"><a href="#cb126-1095" aria-hidden="true" tabindex="-1"></a>    <span class="co"># with mlflow.start_run(nested=True):</span></span>
<span id="cb126-1096"><a href="#cb126-1096" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     mlflow.log_params({</span></span>
<span id="cb126-1097"><a href="#cb126-1097" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'C': C, </span></span>
<span id="cb126-1098"><a href="#cb126-1098" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'epsilon': epsilon,</span></span>
<span id="cb126-1099"><a href="#cb126-1099" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'gamma': gamma,</span></span>
<span id="cb126-1100"><a href="#cb126-1100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         'kernel': kernel})</span></span>
<span id="cb126-1101"><a href="#cb126-1101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     mlflow.log_metric('rmse', rmse)</span></span>
<span id="cb126-1102"><a href="#cb126-1102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return rmse</span></span>
<span id="cb126-1103"><a href="#cb126-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1104"><a href="#cb126-1104" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb126-1105"><a href="#cb126-1105" aria-hidden="true" tabindex="-1"></a>        <span class="st">"C"</span>: trial.suggest_float(<span class="st">"C"</span>, <span class="fl">0.1</span>, <span class="dv">100</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb126-1106"><a href="#cb126-1106" aria-hidden="true" tabindex="-1"></a>        <span class="st">"epsilon"</span>: trial.suggest_float(<span class="st">"epsilon"</span>, <span class="fl">0.01</span>, <span class="fl">1.0</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb126-1107"><a href="#cb126-1107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"gamma"</span>: trial.suggest_float(<span class="st">'gamma'</span>, <span class="fl">1e-4</span>, <span class="fl">1e-1</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb126-1108"><a href="#cb126-1108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"kernel"</span>: trial.suggest_categorical(<span class="st">"kernel"</span>, [<span class="st">"rbf"</span>, <span class="st">"poly"</span>, <span class="st">"linear"</span>])</span>
<span id="cb126-1109"><a href="#cb126-1109" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-1110"><a href="#cb126-1110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-1111"><a href="#cb126-1111" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> Pipeline([</span>
<span id="cb126-1112"><a href="#cb126-1112" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb126-1113"><a href="#cb126-1113" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'svr'</span>, SVR(<span class="op">**</span>params))</span>
<span id="cb126-1114"><a href="#cb126-1114" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb126-1115"><a href="#cb126-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1116"><a href="#cb126-1116" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rmse</span></span>
<span id="cb126-1117"><a href="#cb126-1117" aria-hidden="true" tabindex="-1"></a>    rmse_scores <span class="op">=</span> cross_val_score(model, X_train, y_train, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'neg_root_mean_squared_error'</span>)</span>
<span id="cb126-1118"><a href="#cb126-1118" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> <span class="op">-</span>np.mean(rmse_scores)</span>
<span id="cb126-1119"><a href="#cb126-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1120"><a href="#cb126-1120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mae</span></span>
<span id="cb126-1121"><a href="#cb126-1121" aria-hidden="true" tabindex="-1"></a>    mae_scores <span class="op">=</span> cross_val_score(model, X_train, y_train,cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span> )</span>
<span id="cb126-1122"><a href="#cb126-1122" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> <span class="op">-</span>np.mean(mae_scores)</span>
<span id="cb126-1123"><a href="#cb126-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1124"><a href="#cb126-1124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rmse, mae</span>
<span id="cb126-1125"><a href="#cb126-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1126"><a href="#cb126-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1129"><a href="#cb126-1129" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1130"><a href="#cb126-1130" aria-hidden="true" tabindex="-1"></a>study <span class="op">=</span> optuna.create_study(directions<span class="op">=</span>[<span class="st">'minimize'</span>, <span class="st">'minimize'</span>],</span>
<span id="cb126-1131"><a href="#cb126-1131" aria-hidden="true" tabindex="-1"></a>                            study_name<span class="op">=</span><span class="st">'SVR Optimization'</span>, </span>
<span id="cb126-1132"><a href="#cb126-1132" aria-hidden="true" tabindex="-1"></a>                            storage<span class="op">=</span><span class="st">"sqlite:///./optuna_svr.sqlite3"</span>,  </span>
<span id="cb126-1133"><a href="#cb126-1133" aria-hidden="true" tabindex="-1"></a>                            load_if_exists<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-1134"><a href="#cb126-1134" aria-hidden="true" tabindex="-1"></a>study.optimize(objective, n_trials<span class="op">=</span><span class="dv">30</span>, callbacks<span class="op">=</span>[mlflc])</span>
<span id="cb126-1135"><a href="#cb126-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1136"><a href="#cb126-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1139"><a href="#cb126-1139" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1140"><a href="#cb126-1140" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb126-1141"><a href="#cb126-1141" aria-hidden="true" tabindex="-1"></a><span class="co"># best_params = study.best_trial.params</span></span>
<span id="cb126-1142"><a href="#cb126-1142" aria-hidden="true" tabindex="-1"></a>best_params <span class="op">=</span> <span class="bu">min</span>(study.best_trials, key<span class="op">=</span><span class="kw">lambda</span> t: t.values[<span class="dv">0</span>]).params <span class="co"># Choosing `rmse` to choose best parameters</span></span>
<span id="cb126-1143"><a href="#cb126-1143" aria-hidden="true" tabindex="-1"></a><span class="co"># print("Selected trial params:", best_by_rmse.params)</span></span>
<span id="cb126-1144"><a href="#cb126-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1145"><a href="#cb126-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1146"><a href="#cb126-1146" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb126-1147"><a href="#cb126-1147" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Train Best Model from Optuna</span></span>
<span id="cb126-1148"><a href="#cb126-1148" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb126-1149"><a href="#cb126-1149" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">'preprocessor'</span>, preprocessor), (<span class="st">'svr'</span>, SVR(<span class="op">**</span>best_params))])</span>
<span id="cb126-1150"><a href="#cb126-1150" aria-hidden="true" tabindex="-1"></a>best_model.fit(X_train, y_train)</span>
<span id="cb126-1151"><a href="#cb126-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1152"><a href="#cb126-1152" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb126-1153"><a href="#cb126-1153" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Log &amp; Register Best Model in MLflow</span></span>
<span id="cb126-1154"><a href="#cb126-1154" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------</span></span>
<span id="cb126-1155"><a href="#cb126-1155" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Optuna Best SVR"</span>)</span>
<span id="cb126-1156"><a href="#cb126-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1157"><a href="#cb126-1157" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"SVR_Optuna_Best"</span>):</span>
<span id="cb126-1158"><a href="#cb126-1158" aria-hidden="true" tabindex="-1"></a>    mlflow.log_params(best_params)</span>
<span id="cb126-1159"><a href="#cb126-1159" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> best_model.predict(X_train)</span>
<span id="cb126-1160"><a href="#cb126-1160" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_train, preds))</span>
<span id="cb126-1161"><a href="#cb126-1161" aria-hidden="true" tabindex="-1"></a>    mae <span class="op">=</span> mean_absolute_error(y_train, preds)</span>
<span id="cb126-1162"><a href="#cb126-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1163"><a href="#cb126-1163" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb126-1164"><a href="#cb126-1164" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metric(<span class="st">"mae"</span>, mae)</span>
<span id="cb126-1165"><a href="#cb126-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1166"><a href="#cb126-1166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log model</span></span>
<span id="cb126-1167"><a href="#cb126-1167" aria-hidden="true" tabindex="-1"></a>    mlflow.sklearn.log_model(</span>
<span id="cb126-1168"><a href="#cb126-1168" aria-hidden="true" tabindex="-1"></a>        artifact_path<span class="op">=</span><span class="st">"model"</span>,</span>
<span id="cb126-1169"><a href="#cb126-1169" aria-hidden="true" tabindex="-1"></a>        sk_model<span class="op">=</span>best_model,</span>
<span id="cb126-1170"><a href="#cb126-1170" aria-hidden="true" tabindex="-1"></a>        registered_model_name<span class="op">=</span><span class="st">"Best_SVR"</span>  <span class="co"># model registry name</span></span>
<span id="cb126-1171"><a href="#cb126-1171" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb126-1172"><a href="#cb126-1172" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Best model registered in MLflow as 'RiceYield_SVR'"</span>)</span>
<span id="cb126-1173"><a href="#cb126-1173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1174"><a href="#cb126-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1175"><a href="#cb126-1175" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 8b: Hyperoptimization of all models using Optuna</span></span>
<span id="cb126-1176"><a href="#cb126-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1177"><a href="#cb126-1177" aria-hidden="true" tabindex="-1"></a><span class="fu">## Logging Dataset</span></span>
<span id="cb126-1178"><a href="#cb126-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1181"><a href="#cb126-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1182"><a href="#cb126-1182" aria-hidden="true" tabindex="-1"></a>dataset_path <span class="op">=</span> <span class="st">"C:/Users/DELL/Desktop/crop_yield/data/combined_file/combined.csv"</span> </span>
<span id="cb126-1183"><a href="#cb126-1183" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternate: ..\\data\\combined_file\\combined.cs</span></span>
<span id="cb126-1184"><a href="#cb126-1184" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(dataset_path)</span>
<span id="cb126-1185"><a href="#cb126-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1186"><a href="#cb126-1186" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataset registration experiment</span></span>
<span id="cb126-1187"><a href="#cb126-1187" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Dataset_Registration"</span>)</span>
<span id="cb126-1188"><a href="#cb126-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1189"><a href="#cb126-1189" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"Dataset_v1"</span>) <span class="im">as</span> dataset_run:</span>
<span id="cb126-1190"><a href="#cb126-1190" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(dataset_path, artifact_path<span class="op">=</span><span class="st">"dataset"</span>)</span>
<span id="cb126-1191"><a href="#cb126-1191" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tag(<span class="st">"dataset_version"</span>, <span class="st">"v1"</span>)</span>
<span id="cb126-1192"><a href="#cb126-1192" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tag(<span class="st">"description"</span>, <span class="st">"Cleaned dataset used for all model training"</span>)</span>
<span id="cb126-1193"><a href="#cb126-1193" aria-hidden="true" tabindex="-1"></a>    dataset_run_id <span class="op">=</span> dataset_run.info.run_id</span>
<span id="cb126-1194"><a href="#cb126-1194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1195"><a href="#cb126-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1198"><a href="#cb126-1198" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1199"><a href="#cb126-1199" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_svr(trial):</span></span>
<span id="cb126-1200"><a href="#cb126-1200" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb126-1201"><a href="#cb126-1201" aria-hidden="true" tabindex="-1"></a><span class="co">#         "C": trial.suggest_float("C", 0.1, 100, log=True),</span></span>
<span id="cb126-1202"><a href="#cb126-1202" aria-hidden="true" tabindex="-1"></a><span class="co">#         "epsilon": trial.suggest_float("epsilon", 0.01, 1.0, log=True),</span></span>
<span id="cb126-1203"><a href="#cb126-1203" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float('gamma', 1e-4, 1e-1, log=True),</span></span>
<span id="cb126-1204"><a href="#cb126-1204" aria-hidden="true" tabindex="-1"></a><span class="co">#         "kernel": trial.suggest_categorical("kernel", ["rbf", "poly", "linear"])</span></span>
<span id="cb126-1205"><a href="#cb126-1205" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb126-1206"><a href="#cb126-1206" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-1207"><a href="#cb126-1207" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([</span></span>
<span id="cb126-1208"><a href="#cb126-1208" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('preprocessor', preprocessor),</span></span>
<span id="cb126-1209"><a href="#cb126-1209" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('svr', SVR(**params))</span></span>
<span id="cb126-1210"><a href="#cb126-1210" aria-hidden="true" tabindex="-1"></a><span class="co">#     ])</span></span>
<span id="cb126-1211"><a href="#cb126-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1212"><a href="#cb126-1212" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb126-1213"><a href="#cb126-1213" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb126-1214"><a href="#cb126-1214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-1215"><a href="#cb126-1215" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_etr(trial):</span></span>
<span id="cb126-1216"><a href="#cb126-1216" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {"n_estimators": trial.suggest_int("n_estimators", 100, 1000),</span></span>
<span id="cb126-1217"><a href="#cb126-1217" aria-hidden="true" tabindex="-1"></a><span class="co">#               "max_features": trial.suggest_float("max_features", 0.1, 1.0),</span></span>
<span id="cb126-1218"><a href="#cb126-1218" aria-hidden="true" tabindex="-1"></a><span class="co">#               "min_samples_split": trial.suggest_float("min_samples_split", 0.1, 1.0),</span></span>
<span id="cb126-1219"><a href="#cb126-1219" aria-hidden="true" tabindex="-1"></a><span class="co">#               "min_samples_leaf": trial.suggest_float("min_samples_leaf", 0.01, 0.5)</span></span>
<span id="cb126-1220"><a href="#cb126-1220" aria-hidden="true" tabindex="-1"></a><span class="co">#               }</span></span>
<span id="cb126-1221"><a href="#cb126-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1222"><a href="#cb126-1222" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([('preprocessor', preprocessor),</span></span>
<span id="cb126-1223"><a href="#cb126-1223" aria-hidden="true" tabindex="-1"></a><span class="co">#                       ('etr', ExtraTreesRegressor(**params))])</span></span>
<span id="cb126-1224"><a href="#cb126-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1225"><a href="#cb126-1225" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb126-1226"><a href="#cb126-1226" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb126-1227"><a href="#cb126-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1228"><a href="#cb126-1228" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_xgb(trial):</span></span>
<span id="cb126-1229"><a href="#cb126-1229" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb126-1230"><a href="#cb126-1230" aria-hidden="true" tabindex="-1"></a><span class="co">#         "max_depth": trial.suggest_int("max_depth", 3, 15),</span></span>
<span id="cb126-1231"><a href="#cb126-1231" aria-hidden="true" tabindex="-1"></a><span class="co">#         "n_estimators": trial.suggest_int("n_estimators", 100, 1000),</span></span>
<span id="cb126-1232"><a href="#cb126-1232" aria-hidden="true" tabindex="-1"></a><span class="co">#         "learning_rate": trial.suggest_float("learning_rate", 0.01, 0.3),</span></span>
<span id="cb126-1233"><a href="#cb126-1233" aria-hidden="true" tabindex="-1"></a><span class="co">#         "subsample": trial.suggest_float("subsample", 0.5, 1.0),</span></span>
<span id="cb126-1234"><a href="#cb126-1234" aria-hidden="true" tabindex="-1"></a><span class="co">#         "colsample_bytree": trial.suggest_float("colsample_bytree", 0.5, 1.0),</span></span>
<span id="cb126-1235"><a href="#cb126-1235" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float("gamma", 0.0, 5.0)</span></span>
<span id="cb126-1236"><a href="#cb126-1236" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb126-1237"><a href="#cb126-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1238"><a href="#cb126-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([('preprocessor', preprocessor),</span></span>
<span id="cb126-1239"><a href="#cb126-1239" aria-hidden="true" tabindex="-1"></a><span class="co">#                       ('xgb', XGBRegressor(**params))])</span></span>
<span id="cb126-1240"><a href="#cb126-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1241"><a href="#cb126-1241" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb126-1242"><a href="#cb126-1242" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb126-1243"><a href="#cb126-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1244"><a href="#cb126-1244" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_ada(trial):</span></span>
<span id="cb126-1245"><a href="#cb126-1245" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb126-1246"><a href="#cb126-1246" aria-hidden="true" tabindex="-1"></a><span class="co">#         "n_estimators": trial.suggest_int("n_estimators", 50, 500),</span></span>
<span id="cb126-1247"><a href="#cb126-1247" aria-hidden="true" tabindex="-1"></a><span class="co">#         "learning_rate": trial.suggest_float("learning_rate", 0.01, 2.0),</span></span>
<span id="cb126-1248"><a href="#cb126-1248" aria-hidden="true" tabindex="-1"></a><span class="co">#         "loss": trial.suggest_categorical("loss", ["linear", "square", "exponential"])</span></span>
<span id="cb126-1249"><a href="#cb126-1249" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb126-1250"><a href="#cb126-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1251"><a href="#cb126-1251" aria-hidden="true" tabindex="-1"></a><span class="co">#     model = Pipeline([('preprocessor', preprocessor),</span></span>
<span id="cb126-1252"><a href="#cb126-1252" aria-hidden="true" tabindex="-1"></a><span class="co">#                       ('ada', AdaBoostRegressor(**params))])</span></span>
<span id="cb126-1253"><a href="#cb126-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1254"><a href="#cb126-1254" aria-hidden="true" tabindex="-1"></a><span class="co">#     scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb126-1255"><a href="#cb126-1255" aria-hidden="true" tabindex="-1"></a><span class="co">#     return -np.mean(scores)</span></span>
<span id="cb126-1256"><a href="#cb126-1256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1257"><a href="#cb126-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1260"><a href="#cb126-1260" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1261"><a href="#cb126-1261" aria-hidden="true" tabindex="-1"></a><span class="co"># models_objectives = {</span></span>
<span id="cb126-1262"><a href="#cb126-1262" aria-hidden="true" tabindex="-1"></a><span class="co">#     "svr": objective_svr, # We want to specify how to set params in `sklearn`</span></span>
<span id="cb126-1263"><a href="#cb126-1263" aria-hidden="true" tabindex="-1"></a><span class="co">#     "etr": objective_etr,</span></span>
<span id="cb126-1264"><a href="#cb126-1264" aria-hidden="true" tabindex="-1"></a><span class="co">#     "xgb": objective_xgb,</span></span>
<span id="cb126-1265"><a href="#cb126-1265" aria-hidden="true" tabindex="-1"></a><span class="co">#     "ada": objective_ada</span></span>
<span id="cb126-1266"><a href="#cb126-1266" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb126-1267"><a href="#cb126-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1268"><a href="#cb126-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># os.makedirs("optuna_studies", exist_ok=True)</span></span>
<span id="cb126-1269"><a href="#cb126-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1270"><a href="#cb126-1270" aria-hidden="true" tabindex="-1"></a><span class="co"># # Loop through each model and optimize</span></span>
<span id="cb126-1271"><a href="#cb126-1271" aria-hidden="true" tabindex="-1"></a><span class="co"># for model_name, objective  in models_objectives.items():</span></span>
<span id="cb126-1272"><a href="#cb126-1272" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Optimizing {model_name}...")</span></span>
<span id="cb126-1273"><a href="#cb126-1273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-1274"><a href="#cb126-1274" aria-hidden="true" tabindex="-1"></a><span class="co">#     storage_path = f"sqlite:///./optuna_studies/{model_name}.sqlite3"</span></span>
<span id="cb126-1275"><a href="#cb126-1275" aria-hidden="true" tabindex="-1"></a><span class="co">#     study = optuna.create_study(direction="minimize", storage=storage_path, study_name=model_name, load_if_exists=True)</span></span>
<span id="cb126-1276"><a href="#cb126-1276" aria-hidden="true" tabindex="-1"></a><span class="co">#     study.optimize(objective, n_trials=30)</span></span>
<span id="cb126-1277"><a href="#cb126-1277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1278"><a href="#cb126-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1281"><a href="#cb126-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1282"><a href="#cb126-1282" aria-hidden="true" tabindex="-1"></a><span class="co"># mlflow.set_experiment('SVR_Optuna_Hyperparameter_Optimization')</span></span>
<span id="cb126-1283"><a href="#cb126-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1284"><a href="#cb126-1284" aria-hidden="true" tabindex="-1"></a><span class="co"># def objective_svr_(trial):</span></span>
<span id="cb126-1285"><a href="#cb126-1285" aria-hidden="true" tabindex="-1"></a><span class="co">#     params = {</span></span>
<span id="cb126-1286"><a href="#cb126-1286" aria-hidden="true" tabindex="-1"></a><span class="co">#         "C": trial.suggest_float("C", 0.1, 100, log=True),</span></span>
<span id="cb126-1287"><a href="#cb126-1287" aria-hidden="true" tabindex="-1"></a><span class="co">#         "epsilon": trial.suggest_float("epsilon", 0.01, 1.0, log=True),</span></span>
<span id="cb126-1288"><a href="#cb126-1288" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float('gamma', 1e-4, 1e-1, log=True),</span></span>
<span id="cb126-1289"><a href="#cb126-1289" aria-hidden="true" tabindex="-1"></a><span class="co">#         "kernel": trial.suggest_categorical("kernel", ["rbf", "poly", "linear"])</span></span>
<span id="cb126-1290"><a href="#cb126-1290" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb126-1291"><a href="#cb126-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1292"><a href="#cb126-1292" aria-hidden="true" tabindex="-1"></a><span class="co">#     with mlflow.start_run(run_name=f"trial {trial.number}", nested=True) as run:</span></span>
<span id="cb126-1293"><a href="#cb126-1293" aria-hidden="true" tabindex="-1"></a><span class="co">#         # Regiser data for each trial</span></span>
<span id="cb126-1294"><a href="#cb126-1294" aria-hidden="true" tabindex="-1"></a><span class="co">#         dataset_source = "data\combined_file\combined.csv"  # your dataset path</span></span>
<span id="cb126-1295"><a href="#cb126-1295" aria-hidden="true" tabindex="-1"></a><span class="co">#         train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, name="Rice_Yield_Training_Data", targets="rice_yield")</span></span>
<span id="cb126-1296"><a href="#cb126-1296" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_input(train_dataset, context="training")</span></span>
<span id="cb126-1297"><a href="#cb126-1297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1298"><a href="#cb126-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1299"><a href="#cb126-1299" aria-hidden="true" tabindex="-1"></a><span class="co">#         trial.set_user_attr("mlflow_run_id", run.info.run_id) # Logging `run_id` on Optuna</span></span>
<span id="cb126-1300"><a href="#cb126-1300" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.set_tag("trial_number", trial.number) # Logging `trial number` on MLflow</span></span>
<span id="cb126-1301"><a href="#cb126-1301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb126-1302"><a href="#cb126-1302" aria-hidden="true" tabindex="-1"></a><span class="co">#         model = Pipeline([</span></span>
<span id="cb126-1303"><a href="#cb126-1303" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('preprocessor', preprocessor),</span></span>
<span id="cb126-1304"><a href="#cb126-1304" aria-hidden="true" tabindex="-1"></a><span class="co">#         ('svr', SVR(**params))</span></span>
<span id="cb126-1305"><a href="#cb126-1305" aria-hidden="true" tabindex="-1"></a><span class="co">#         ])</span></span>
<span id="cb126-1306"><a href="#cb126-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1307"><a href="#cb126-1307" aria-hidden="true" tabindex="-1"></a><span class="co">#         # rmse</span></span>
<span id="cb126-1308"><a href="#cb126-1308" aria-hidden="true" tabindex="-1"></a><span class="co">#         rmse_scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring='neg_root_mean_squared_error')</span></span>
<span id="cb126-1309"><a href="#cb126-1309" aria-hidden="true" tabindex="-1"></a><span class="co">#         rmse = -np.mean(rmse_scores)</span></span>
<span id="cb126-1310"><a href="#cb126-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1311"><a href="#cb126-1311" aria-hidden="true" tabindex="-1"></a><span class="co">#         # mae</span></span>
<span id="cb126-1312"><a href="#cb126-1312" aria-hidden="true" tabindex="-1"></a><span class="co">#         mae_scores = cross_val_score(model, X_train, y_train,cv=tscv, scoring='neg_mean_absolute_error' )</span></span>
<span id="cb126-1313"><a href="#cb126-1313" aria-hidden="true" tabindex="-1"></a><span class="co">#         mae = -np.mean(mae_scores)</span></span>
<span id="cb126-1314"><a href="#cb126-1314" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb126-1315"><a href="#cb126-1315" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_metric('rmse', rmse)</span></span>
<span id="cb126-1316"><a href="#cb126-1316" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_metric('mae', mae)</span></span>
<span id="cb126-1317"><a href="#cb126-1317" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_params(params)</span></span>
<span id="cb126-1318"><a href="#cb126-1318" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.sklearn.log_model(model, name='model', input_example=X_train.iloc[:5])</span></span>
<span id="cb126-1319"><a href="#cb126-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1320"><a href="#cb126-1320" aria-hidden="true" tabindex="-1"></a><span class="co">#     return rmse</span></span>
<span id="cb126-1321"><a href="#cb126-1321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1322"><a href="#cb126-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1325"><a href="#cb126-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1326"><a href="#cb126-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># ==== Parent run ====</span></span>
<span id="cb126-1327"><a href="#cb126-1327" aria-hidden="true" tabindex="-1"></a><span class="co"># with mlflow.start_run(run_name="Optuna_Optimization_SVR") as parent_run:</span></span>
<span id="cb126-1328"><a href="#cb126-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1329"><a href="#cb126-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1330"><a href="#cb126-1330" aria-hidden="true" tabindex="-1"></a><span class="co"># # Example: log train data</span></span>
<span id="cb126-1331"><a href="#cb126-1331" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Register Dataset</span></span>
<span id="cb126-1332"><a href="#cb126-1332" aria-hidden="true" tabindex="-1"></a><span class="co">#     dataset_source = "data\combined_file\combined.csv"  # your dataset path</span></span>
<span id="cb126-1333"><a href="#cb126-1333" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, name="Rice_Yield_Train_Data")</span></span>
<span id="cb126-1334"><a href="#cb126-1334" aria-hidden="true" tabindex="-1"></a><span class="co">#     # test_dataset = mlflow.data.from_pandas(X_test, source=dataset_source, name="Rice_Yield_Test_Data")</span></span>
<span id="cb126-1335"><a href="#cb126-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1336"><a href="#cb126-1336" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_input(train_dataset, context="train")</span></span>
<span id="cb126-1337"><a href="#cb126-1337" aria-hidden="true" tabindex="-1"></a><span class="co">#     # mlflow.log_input(test_dataset, context="testing")</span></span>
<span id="cb126-1338"><a href="#cb126-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1339"><a href="#cb126-1339" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Create study</span></span>
<span id="cb126-1340"><a href="#cb126-1340" aria-hidden="true" tabindex="-1"></a><span class="co">#     study = optuna.create_study(study_name="SVR Trials", direction="minimize", storage="sqlite:///./optuna_svr_opt.sqlite3")</span></span>
<span id="cb126-1341"><a href="#cb126-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1342"><a href="#cb126-1342" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Optimize trials (logged as nested runs)</span></span>
<span id="cb126-1343"><a href="#cb126-1343" aria-hidden="true" tabindex="-1"></a><span class="co">#     study.optimize(objective_svr_, n_trials=10)</span></span>
<span id="cb126-1344"><a href="#cb126-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1345"><a href="#cb126-1345" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Best trial</span></span>
<span id="cb126-1346"><a href="#cb126-1346" aria-hidden="true" tabindex="-1"></a><span class="co">#     best_trial = study.best_trial</span></span>
<span id="cb126-1347"><a href="#cb126-1347" aria-hidden="true" tabindex="-1"></a><span class="co">#     best_run_id = best_trial.user_attrs["mlflow_run_id"]</span></span>
<span id="cb126-1348"><a href="#cb126-1348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1349"><a href="#cb126-1349" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("\nBest trial number:", best_trial.number)</span></span>
<span id="cb126-1350"><a href="#cb126-1350" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("Best RMSE:", best_trial.value)</span></span>
<span id="cb126-1351"><a href="#cb126-1351" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("Best params:", best_trial.params)</span></span>
<span id="cb126-1352"><a href="#cb126-1352" aria-hidden="true" tabindex="-1"></a><span class="co">#     print("Best trial MLflow run:", best_run_id)</span></span>
<span id="cb126-1353"><a href="#cb126-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1354"><a href="#cb126-1354" aria-hidden="true" tabindex="-1"></a><span class="co">#     # ==== Retrain best model on full training data ====</span></span>
<span id="cb126-1355"><a href="#cb126-1355" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_model = Pipeline(steps=[('preprocessor', preprocessor), ('svr', SVR(**best_params))])</span></span>
<span id="cb126-1356"><a href="#cb126-1356" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_model.fit(X_train, y_train)</span></span>
<span id="cb126-1357"><a href="#cb126-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1358"><a href="#cb126-1358" aria-hidden="true" tabindex="-1"></a><span class="co">#     preds = final_model.predict(X_test)</span></span>
<span id="cb126-1359"><a href="#cb126-1359" aria-hidden="true" tabindex="-1"></a><span class="co">#     final_rmse = np.sqrt(mean_squared_error(y_test, preds))</span></span>
<span id="cb126-1360"><a href="#cb126-1360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1361"><a href="#cb126-1361" aria-hidden="true" tabindex="-1"></a><span class="co">#     # === Model signature ===</span></span>
<span id="cb126-1362"><a href="#cb126-1362" aria-hidden="true" tabindex="-1"></a><span class="co">#     # signature = infer_signature(X_train, final_model.predict(X_train))</span></span>
<span id="cb126-1363"><a href="#cb126-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1364"><a href="#cb126-1364" aria-hidden="true" tabindex="-1"></a><span class="co">#     # ==== Log final model in top-level run ====</span></span>
<span id="cb126-1365"><a href="#cb126-1365" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.set_tag("best_trial_number", best_trial.number)</span></span>
<span id="cb126-1366"><a href="#cb126-1366" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_params(best_trial.params)</span></span>
<span id="cb126-1367"><a href="#cb126-1367" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_metric("final_rmse", final_rmse)</span></span>
<span id="cb126-1368"><a href="#cb126-1368" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.sklearn.log_model(final_model, </span></span>
<span id="cb126-1369"><a href="#cb126-1369" aria-hidden="true" tabindex="-1"></a><span class="co">#                              name="best_final_model", </span></span>
<span id="cb126-1370"><a href="#cb126-1370" aria-hidden="true" tabindex="-1"></a><span class="co">#                              input_example=X_train.iloc[:5],</span></span>
<span id="cb126-1371"><a href="#cb126-1371" aria-hidden="true" tabindex="-1"></a><span class="co">#                              registered_model_name='Best SVR Model')</span></span>
<span id="cb126-1372"><a href="#cb126-1372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1373"><a href="#cb126-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1374"><a href="#cb126-1374" aria-hidden="true" tabindex="-1"></a><span class="fu"># Chapter 8c: All models</span></span>
<span id="cb126-1375"><a href="#cb126-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1378"><a href="#cb126-1378" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1379"><a href="#cb126-1379" aria-hidden="true" tabindex="-1"></a><span class="co"># Common MLflow experiment</span></span>
<span id="cb126-1380"><a href="#cb126-1380" aria-hidden="true" tabindex="-1"></a><span class="co"># mlflow.set_experiment("Rice_Yield_Optuna_HPO")</span></span>
<span id="cb126-1381"><a href="#cb126-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1382"><a href="#cb126-1382" aria-hidden="true" tabindex="-1"></a><span class="co"># # Dictionary of candidate models and their search spaces</span></span>
<span id="cb126-1383"><a href="#cb126-1383" aria-hidden="true" tabindex="-1"></a><span class="co"># model_spaces = {</span></span>
<span id="cb126-1384"><a href="#cb126-1384" aria-hidden="true" tabindex="-1"></a><span class="co">#     "SVR": lambda trial: {</span></span>
<span id="cb126-1385"><a href="#cb126-1385" aria-hidden="true" tabindex="-1"></a><span class="co">#         "C": trial.suggest_float("C", 0.1, 100, log=True),</span></span>
<span id="cb126-1386"><a href="#cb126-1386" aria-hidden="true" tabindex="-1"></a><span class="co">#         "epsilon": trial.suggest_float("epsilon", 0.01, 1.0, log=True),</span></span>
<span id="cb126-1387"><a href="#cb126-1387" aria-hidden="true" tabindex="-1"></a><span class="co">#         "gamma": trial.suggest_float('gamma', 1e-4, 1e-1, log=True),</span></span>
<span id="cb126-1388"><a href="#cb126-1388" aria-hidden="true" tabindex="-1"></a><span class="co">#         "kernel": trial.suggest_categorical("kernel", ["rbf", "poly", "linear"])</span></span>
<span id="cb126-1389"><a href="#cb126-1389" aria-hidden="true" tabindex="-1"></a><span class="co">#     },</span></span>
<span id="cb126-1390"><a href="#cb126-1390" aria-hidden="true" tabindex="-1"></a><span class="co">#     "AdaBoost": lambda trial: {</span></span>
<span id="cb126-1391"><a href="#cb126-1391" aria-hidden="true" tabindex="-1"></a><span class="co">#         "n_estimators": trial.suggest_int("n_estimators", 50, 200, step=50),</span></span>
<span id="cb126-1392"><a href="#cb126-1392" aria-hidden="true" tabindex="-1"></a><span class="co">#         "learning_rate": trial.suggest_float("learning_rate", 0.01, 1.0, log=True)</span></span>
<span id="cb126-1393"><a href="#cb126-1393" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb126-1394"><a href="#cb126-1394" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb126-1395"><a href="#cb126-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1396"><a href="#cb126-1396" aria-hidden="true" tabindex="-1"></a><span class="co"># # Mapping model name → actual sklearn class</span></span>
<span id="cb126-1397"><a href="#cb126-1397" aria-hidden="true" tabindex="-1"></a><span class="co"># model_classes = {</span></span>
<span id="cb126-1398"><a href="#cb126-1398" aria-hidden="true" tabindex="-1"></a><span class="co">#     "SVR": SVR,</span></span>
<span id="cb126-1399"><a href="#cb126-1399" aria-hidden="true" tabindex="-1"></a><span class="co">#     "AdaBoost": AdaBoostRegressor</span></span>
<span id="cb126-1400"><a href="#cb126-1400" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb126-1401"><a href="#cb126-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1402"><a href="#cb126-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1403"><a href="#cb126-1403" aria-hidden="true" tabindex="-1"></a><span class="co"># # Reusable objective factory</span></span>
<span id="cb126-1404"><a href="#cb126-1404" aria-hidden="true" tabindex="-1"></a><span class="co"># def make_objective(model_name):</span></span>
<span id="cb126-1405"><a href="#cb126-1405" aria-hidden="true" tabindex="-1"></a><span class="co">#     def objective(trial):</span></span>
<span id="cb126-1406"><a href="#cb126-1406" aria-hidden="true" tabindex="-1"></a><span class="co">#         params = model_spaces[model_name](trial)</span></span>
<span id="cb126-1407"><a href="#cb126-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1408"><a href="#cb126-1408" aria-hidden="true" tabindex="-1"></a><span class="co">#         with mlflow.start_run(run_name=f"{model_name}_trial_{trial.number}", nested=True) as run:</span></span>
<span id="cb126-1409"><a href="#cb126-1409" aria-hidden="true" tabindex="-1"></a><span class="co">#             # Register dataset (once per trial for traceability)</span></span>
<span id="cb126-1410"><a href="#cb126-1410" aria-hidden="true" tabindex="-1"></a><span class="co">#             dataset_source = "C:/Users/DELL/Desktop/crop_yield/data/combined_file/combined.csv"</span></span>
<span id="cb126-1411"><a href="#cb126-1411" aria-hidden="true" tabindex="-1"></a><span class="co">#             train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, </span></span>
<span id="cb126-1412"><a href="#cb126-1412" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                     name="Rice_Yield_Training_Data", </span></span>
<span id="cb126-1413"><a href="#cb126-1413" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                     targets="rice_yield")</span></span>
<span id="cb126-1414"><a href="#cb126-1414" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_input(train_dataset, context="training")</span></span>
<span id="cb126-1415"><a href="#cb126-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1416"><a href="#cb126-1416" aria-hidden="true" tabindex="-1"></a><span class="co">#             trial.set_user_attr("mlflow_run_id", run.info.run_id)</span></span>
<span id="cb126-1417"><a href="#cb126-1417" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.set_tag("trial_number", trial.number)</span></span>
<span id="cb126-1418"><a href="#cb126-1418" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.set_tag("model_name", model_name)</span></span>
<span id="cb126-1419"><a href="#cb126-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1420"><a href="#cb126-1420" aria-hidden="true" tabindex="-1"></a><span class="co">#             model = Pipeline([</span></span>
<span id="cb126-1421"><a href="#cb126-1421" aria-hidden="true" tabindex="-1"></a><span class="co">#                 ("preprocessor", preprocessor),</span></span>
<span id="cb126-1422"><a href="#cb126-1422" aria-hidden="true" tabindex="-1"></a><span class="co">#                 (model_name.lower(), model_classes[model_name](**params))</span></span>
<span id="cb126-1423"><a href="#cb126-1423" aria-hidden="true" tabindex="-1"></a><span class="co">#             ])</span></span>
<span id="cb126-1424"><a href="#cb126-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1425"><a href="#cb126-1425" aria-hidden="true" tabindex="-1"></a><span class="co">#             # RMSE</span></span>
<span id="cb126-1426"><a href="#cb126-1426" aria-hidden="true" tabindex="-1"></a><span class="co">#             rmse_scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring="neg_root_mean_squared_error")</span></span>
<span id="cb126-1427"><a href="#cb126-1427" aria-hidden="true" tabindex="-1"></a><span class="co">#             rmse = -np.mean(rmse_scores)</span></span>
<span id="cb126-1428"><a href="#cb126-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1429"><a href="#cb126-1429" aria-hidden="true" tabindex="-1"></a><span class="co">#             # MAE</span></span>
<span id="cb126-1430"><a href="#cb126-1430" aria-hidden="true" tabindex="-1"></a><span class="co">#             mae_scores = cross_val_score(model, X_train, y_train, cv=tscv, scoring="neg_mean_absolute_error")</span></span>
<span id="cb126-1431"><a href="#cb126-1431" aria-hidden="true" tabindex="-1"></a><span class="co">#             mae = -np.mean(mae_scores)</span></span>
<span id="cb126-1432"><a href="#cb126-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1433"><a href="#cb126-1433" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_metric("rmse", rmse)</span></span>
<span id="cb126-1434"><a href="#cb126-1434" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_metric("mae", mae)</span></span>
<span id="cb126-1435"><a href="#cb126-1435" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.log_params(params)</span></span>
<span id="cb126-1436"><a href="#cb126-1436" aria-hidden="true" tabindex="-1"></a><span class="co">#             mlflow.sklearn.log_model(model, name="model", input_example=X_train.iloc[:5])</span></span>
<span id="cb126-1437"><a href="#cb126-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1438"><a href="#cb126-1438" aria-hidden="true" tabindex="-1"></a><span class="co">#         return rmse</span></span>
<span id="cb126-1439"><a href="#cb126-1439" aria-hidden="true" tabindex="-1"></a><span class="co">#     return objective</span></span>
<span id="cb126-1440"><a href="#cb126-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1441"><a href="#cb126-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1442"><a href="#cb126-1442" aria-hidden="true" tabindex="-1"></a><span class="co"># # ==== Parent run for ALL models ====</span></span>
<span id="cb126-1443"><a href="#cb126-1443" aria-hidden="true" tabindex="-1"></a><span class="co"># with mlflow.start_run(run_name="Optuna_HPO_All_Models") as parent_run:</span></span>
<span id="cb126-1444"><a href="#cb126-1444" aria-hidden="true" tabindex="-1"></a><span class="co">#     dataset_source = "data/combined_file/combined.csv"</span></span>
<span id="cb126-1445"><a href="#cb126-1445" aria-hidden="true" tabindex="-1"></a><span class="co">#     train_dataset = mlflow.data.from_pandas(train_df, source=dataset_source, name="Rice_Yield_Train_Data")</span></span>
<span id="cb126-1446"><a href="#cb126-1446" aria-hidden="true" tabindex="-1"></a><span class="co">#     mlflow.log_input(train_dataset, context="train")</span></span>
<span id="cb126-1447"><a href="#cb126-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1448"><a href="#cb126-1448" aria-hidden="true" tabindex="-1"></a><span class="co">#     for model_name in model_spaces.keys():</span></span>
<span id="cb126-1449"><a href="#cb126-1449" aria-hidden="true" tabindex="-1"></a><span class="co">#         study = optuna.create_study(</span></span>
<span id="cb126-1450"><a href="#cb126-1450" aria-hidden="true" tabindex="-1"></a><span class="co">#             study_name=f"{model_name}_Trials",</span></span>
<span id="cb126-1451"><a href="#cb126-1451" aria-hidden="true" tabindex="-1"></a><span class="co">#             direction="minimize",</span></span>
<span id="cb126-1452"><a href="#cb126-1452" aria-hidden="true" tabindex="-1"></a><span class="co">#             storage="sqlite:///./optuna_all_models.sqlite3",  # Shared DB</span></span>
<span id="cb126-1453"><a href="#cb126-1453" aria-hidden="true" tabindex="-1"></a><span class="co">#             load_if_exists=True</span></span>
<span id="cb126-1454"><a href="#cb126-1454" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb126-1455"><a href="#cb126-1455" aria-hidden="true" tabindex="-1"></a><span class="co">#         study.optimize(make_objective(model_name), n_trials=10)</span></span>
<span id="cb126-1456"><a href="#cb126-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1457"><a href="#cb126-1457" aria-hidden="true" tabindex="-1"></a><span class="co">#         best_trial = study.best_trial</span></span>
<span id="cb126-1458"><a href="#cb126-1458" aria-hidden="true" tabindex="-1"></a><span class="co">#         best_run_id = best_trial.user_attrs["mlflow_run_id"]</span></span>
<span id="cb126-1459"><a href="#cb126-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1460"><a href="#cb126-1460" aria-hidden="true" tabindex="-1"></a><span class="co">#         print(f"\nModel: {model_name}")</span></span>
<span id="cb126-1461"><a href="#cb126-1461" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best trial number:", best_trial.number)</span></span>
<span id="cb126-1462"><a href="#cb126-1462" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best RMSE:", best_trial.value)</span></span>
<span id="cb126-1463"><a href="#cb126-1463" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best params:", best_trial.params)</span></span>
<span id="cb126-1464"><a href="#cb126-1464" aria-hidden="true" tabindex="-1"></a><span class="co">#         print("Best trial MLflow run:", best_run_id)</span></span>
<span id="cb126-1465"><a href="#cb126-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1466"><a href="#cb126-1466" aria-hidden="true" tabindex="-1"></a><span class="co">#         # Retrain best model</span></span>
<span id="cb126-1467"><a href="#cb126-1467" aria-hidden="true" tabindex="-1"></a><span class="co">#         final_model = Pipeline([</span></span>
<span id="cb126-1468"><a href="#cb126-1468" aria-hidden="true" tabindex="-1"></a><span class="co">#             ("preprocessor", preprocessor),</span></span>
<span id="cb126-1469"><a href="#cb126-1469" aria-hidden="true" tabindex="-1"></a><span class="co">#             (model_name.lower(), model_classes[model_name](**best_trial.params))</span></span>
<span id="cb126-1470"><a href="#cb126-1470" aria-hidden="true" tabindex="-1"></a><span class="co">#         ])</span></span>
<span id="cb126-1471"><a href="#cb126-1471" aria-hidden="true" tabindex="-1"></a><span class="co">#         final_model.fit(X_train, y_train)</span></span>
<span id="cb126-1472"><a href="#cb126-1472" aria-hidden="true" tabindex="-1"></a><span class="co">#         preds = final_model.predict(X_test)</span></span>
<span id="cb126-1473"><a href="#cb126-1473" aria-hidden="true" tabindex="-1"></a><span class="co">#         final_rmse = np.sqrt(mean_squared_error(y_test, preds))</span></span>
<span id="cb126-1474"><a href="#cb126-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1475"><a href="#cb126-1475" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.set_tag(f"{model_name}_best_trial_number", best_trial.number)</span></span>
<span id="cb126-1476"><a href="#cb126-1476" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_params({f"{model_name}_{k}": v for k, v in best_trial.params.items()})</span></span>
<span id="cb126-1477"><a href="#cb126-1477" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.log_metric(f"{model_name}_final_rmse", final_rmse)</span></span>
<span id="cb126-1478"><a href="#cb126-1478" aria-hidden="true" tabindex="-1"></a><span class="co">#         mlflow.sklearn.log_model(final_model, </span></span>
<span id="cb126-1479"><a href="#cb126-1479" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  name=f"{model_name}_best_final_model", </span></span>
<span id="cb126-1480"><a href="#cb126-1480" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  input_example=X_train.iloc[:5],</span></span>
<span id="cb126-1481"><a href="#cb126-1481" aria-hidden="true" tabindex="-1"></a><span class="co">#                                  registered_model_name=f"Best_{model_name}_Model")</span></span>
<span id="cb126-1482"><a href="#cb126-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1483"><a href="#cb126-1483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1484"><a href="#cb126-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1485"><a href="#cb126-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1488"><a href="#cb126-1488" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1489"><a href="#cb126-1489" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb126-1490"><a href="#cb126-1490" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb126-1491"><a href="#cb126-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1492"><a href="#cb126-1492" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"Rice_Yield_Optuna_HPO"</span>)</span>
<span id="cb126-1493"><a href="#cb126-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1494"><a href="#cb126-1494" aria-hidden="true" tabindex="-1"></a><span class="co"># === Candidate models and their search spaces ===</span></span>
<span id="cb126-1495"><a href="#cb126-1495" aria-hidden="true" tabindex="-1"></a>search_spaces <span class="op">=</span> {</span>
<span id="cb126-1496"><a href="#cb126-1496" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SVR"</span>: {</span>
<span id="cb126-1497"><a href="#cb126-1497" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_class"</span>: SVR,</span>
<span id="cb126-1498"><a href="#cb126-1498" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: <span class="kw">lambda</span> trial: {</span>
<span id="cb126-1499"><a href="#cb126-1499" aria-hidden="true" tabindex="-1"></a>            <span class="st">"C"</span>: trial.suggest_float(<span class="st">"C"</span>, <span class="fl">0.1</span>, <span class="dv">100</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb126-1500"><a href="#cb126-1500" aria-hidden="true" tabindex="-1"></a>            <span class="st">"epsilon"</span>: trial.suggest_float(<span class="st">"epsilon"</span>, <span class="fl">0.01</span>, <span class="fl">1.0</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb126-1501"><a href="#cb126-1501" aria-hidden="true" tabindex="-1"></a>            <span class="st">"gamma"</span>: trial.suggest_float(<span class="st">"gamma"</span>, <span class="fl">1e-4</span>, <span class="fl">1e-1</span>, log<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb126-1502"><a href="#cb126-1502" aria-hidden="true" tabindex="-1"></a>            <span class="st">"kernel"</span>: trial.suggest_categorical(<span class="st">"kernel"</span>, [<span class="st">"rbf"</span>, <span class="st">"poly"</span>, <span class="st">"linear"</span>])</span>
<span id="cb126-1503"><a href="#cb126-1503" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-1504"><a href="#cb126-1504" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-1505"><a href="#cb126-1505" aria-hidden="true" tabindex="-1"></a>    <span class="st">"RandomForest"</span>: {</span>
<span id="cb126-1506"><a href="#cb126-1506" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_class"</span>: RandomForestRegressor,</span>
<span id="cb126-1507"><a href="#cb126-1507" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: <span class="kw">lambda</span> trial: {</span>
<span id="cb126-1508"><a href="#cb126-1508" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_estimators"</span>: trial.suggest_int(<span class="st">"n_estimators"</span>, <span class="dv">50</span>, <span class="dv">200</span>),</span>
<span id="cb126-1509"><a href="#cb126-1509" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_depth"</span>: trial.suggest_int(<span class="st">"max_depth"</span>, <span class="dv">3</span>, <span class="dv">15</span>),</span>
<span id="cb126-1510"><a href="#cb126-1510" aria-hidden="true" tabindex="-1"></a>            <span class="st">"min_samples_split"</span>: trial.suggest_int(<span class="st">"min_samples_split"</span>, <span class="dv">2</span>, <span class="dv">10</span>)</span>
<span id="cb126-1511"><a href="#cb126-1511" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-1512"><a href="#cb126-1512" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb126-1513"><a href="#cb126-1513" aria-hidden="true" tabindex="-1"></a>    <span class="st">"XGB"</span>: {</span>
<span id="cb126-1514"><a href="#cb126-1514" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_class"</span>: XGBRegressor,</span>
<span id="cb126-1515"><a href="#cb126-1515" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: <span class="kw">lambda</span> trial: {</span>
<span id="cb126-1516"><a href="#cb126-1516" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_estimators"</span>: trial.suggest_int(<span class="st">"n_estimators"</span>, <span class="dv">50</span>, <span class="dv">200</span>),</span>
<span id="cb126-1517"><a href="#cb126-1517" aria-hidden="true" tabindex="-1"></a>            <span class="st">"max_depth"</span>: trial.suggest_int(<span class="st">"max_depth"</span>, <span class="dv">3</span>, <span class="dv">10</span>),</span>
<span id="cb126-1518"><a href="#cb126-1518" aria-hidden="true" tabindex="-1"></a>            <span class="st">"learning_rate"</span>: trial.suggest_float(<span class="st">"learning_rate"</span>, <span class="fl">0.01</span>, <span class="fl">0.3</span>, log<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-1519"><a href="#cb126-1519" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-1520"><a href="#cb126-1520" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-1521"><a href="#cb126-1521" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-1522"><a href="#cb126-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1523"><a href="#cb126-1523" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_objective(model_name, model_class, param_fn):</span>
<span id="cb126-1524"><a href="#cb126-1524" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> objective(trial):</span>
<span id="cb126-1525"><a href="#cb126-1525" aria-hidden="true" tabindex="-1"></a>        params <span class="op">=</span> param_fn(trial)</span>
<span id="cb126-1526"><a href="#cb126-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1527"><a href="#cb126-1527" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_trial_</span><span class="sc">{</span>trial<span class="sc">.</span>number<span class="sc">}</span><span class="ss">"</span>, nested<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> run:</span>
<span id="cb126-1528"><a href="#cb126-1528" aria-hidden="true" tabindex="-1"></a>            trial.set_user_attr(<span class="st">"mlflow_run_id"</span>, run.info.run_id)</span>
<span id="cb126-1529"><a href="#cb126-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1530"><a href="#cb126-1530" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> Pipeline([</span>
<span id="cb126-1531"><a href="#cb126-1531" aria-hidden="true" tabindex="-1"></a>                (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb126-1532"><a href="#cb126-1532" aria-hidden="true" tabindex="-1"></a>                (model_name.lower(), model_class(<span class="op">**</span>params))</span>
<span id="cb126-1533"><a href="#cb126-1533" aria-hidden="true" tabindex="-1"></a>            ])</span>
<span id="cb126-1534"><a href="#cb126-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1535"><a href="#cb126-1535" aria-hidden="true" tabindex="-1"></a>            <span class="co"># cross-val metrics</span></span>
<span id="cb126-1536"><a href="#cb126-1536" aria-hidden="true" tabindex="-1"></a>            rmse_scores <span class="op">=</span> cross_val_score(model, X_train, y_train, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">"neg_root_mean_squared_error"</span>)</span>
<span id="cb126-1537"><a href="#cb126-1537" aria-hidden="true" tabindex="-1"></a>            rmse <span class="op">=</span> <span class="op">-</span>np.mean(rmse_scores)</span>
<span id="cb126-1538"><a href="#cb126-1538" aria-hidden="true" tabindex="-1"></a>            mae_scores <span class="op">=</span> cross_val_score(model, X_train, y_train, cv<span class="op">=</span>tscv, scoring<span class="op">=</span><span class="st">"neg_mean_absolute_error"</span>)</span>
<span id="cb126-1539"><a href="#cb126-1539" aria-hidden="true" tabindex="-1"></a>            mae <span class="op">=</span> <span class="op">-</span>np.mean(mae_scores)</span>
<span id="cb126-1540"><a href="#cb126-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1541"><a href="#cb126-1541" aria-hidden="true" tabindex="-1"></a>            mlflow.log_params(params)</span>
<span id="cb126-1542"><a href="#cb126-1542" aria-hidden="true" tabindex="-1"></a>            mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb126-1543"><a href="#cb126-1543" aria-hidden="true" tabindex="-1"></a>            mlflow.log_metric(<span class="st">"mae"</span>, mae)</span>
<span id="cb126-1544"><a href="#cb126-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1545"><a href="#cb126-1545" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rmse</span>
<span id="cb126-1546"><a href="#cb126-1546" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> objective</span>
<span id="cb126-1547"><a href="#cb126-1547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1548"><a href="#cb126-1548" aria-hidden="true" tabindex="-1"></a>best_models <span class="op">=</span> {}</span>
<span id="cb126-1549"><a href="#cb126-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1550"><a href="#cb126-1550" aria-hidden="true" tabindex="-1"></a><span class="co"># === Loop over candidate models ===</span></span>
<span id="cb126-1551"><a href="#cb126-1551" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, cfg <span class="kw">in</span> search_spaces.items():</span>
<span id="cb126-1552"><a href="#cb126-1552" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_Optimization"</span>) <span class="im">as</span> parent_run:</span>
<span id="cb126-1553"><a href="#cb126-1553" aria-hidden="true" tabindex="-1"></a>        study <span class="op">=</span> optuna.create_study(</span>
<span id="cb126-1554"><a href="#cb126-1554" aria-hidden="true" tabindex="-1"></a>            study_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_Study"</span>,</span>
<span id="cb126-1555"><a href="#cb126-1555" aria-hidden="true" tabindex="-1"></a>            direction<span class="op">=</span><span class="st">"minimize"</span>,</span>
<span id="cb126-1556"><a href="#cb126-1556" aria-hidden="true" tabindex="-1"></a>            storage<span class="op">=</span><span class="ss">f"sqlite:///./optuna_models.sqlite3"</span></span>
<span id="cb126-1557"><a href="#cb126-1557" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb126-1558"><a href="#cb126-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1559"><a href="#cb126-1559" aria-hidden="true" tabindex="-1"></a>        study.optimize(make_objective(model_name, cfg[<span class="st">"model_class"</span>], cfg[<span class="st">"params"</span>]), n_trials<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb126-1560"><a href="#cb126-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1561"><a href="#cb126-1561" aria-hidden="true" tabindex="-1"></a>        best_trial <span class="op">=</span> study.best_trial</span>
<span id="cb126-1562"><a href="#cb126-1562" aria-hidden="true" tabindex="-1"></a>        best_run_id <span class="op">=</span> best_trial.user_attrs[<span class="st">"mlflow_run_id"</span>]</span>
<span id="cb126-1563"><a href="#cb126-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1564"><a href="#cb126-1564" aria-hidden="true" tabindex="-1"></a>        mlflow.set_tag(<span class="st">"best_trial_number"</span>, best_trial.number)</span>
<span id="cb126-1565"><a href="#cb126-1565" aria-hidden="true" tabindex="-1"></a>        mlflow.log_params(best_trial.params)</span>
<span id="cb126-1566"><a href="#cb126-1566" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"best_rmse"</span>, best_trial.value)</span>
<span id="cb126-1567"><a href="#cb126-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1568"><a href="#cb126-1568" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Retrain best model</span></span>
<span id="cb126-1569"><a href="#cb126-1569" aria-hidden="true" tabindex="-1"></a>        best_model <span class="op">=</span> Pipeline([</span>
<span id="cb126-1570"><a href="#cb126-1570" aria-hidden="true" tabindex="-1"></a>            (<span class="st">'preprocessor'</span>, preprocessor),</span>
<span id="cb126-1571"><a href="#cb126-1571" aria-hidden="true" tabindex="-1"></a>            (model_name.lower(), cfg[<span class="st">"model_class"</span>](<span class="op">**</span>best_trial.params))</span>
<span id="cb126-1572"><a href="#cb126-1572" aria-hidden="true" tabindex="-1"></a>        ])</span>
<span id="cb126-1573"><a href="#cb126-1573" aria-hidden="true" tabindex="-1"></a>        best_model.fit(X_train, y_train)</span>
<span id="cb126-1574"><a href="#cb126-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1575"><a href="#cb126-1575" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> best_model.predict(X_test)</span>
<span id="cb126-1576"><a href="#cb126-1576" aria-hidden="true" tabindex="-1"></a>        final_rmse <span class="op">=</span> np.sqrt(mean_squared_error(y_test, preds))</span>
<span id="cb126-1577"><a href="#cb126-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1578"><a href="#cb126-1578" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"final_rmse"</span>, final_rmse)</span>
<span id="cb126-1579"><a href="#cb126-1579" aria-hidden="true" tabindex="-1"></a>        mlflow.sklearn.log_model(</span>
<span id="cb126-1580"><a href="#cb126-1580" aria-hidden="true" tabindex="-1"></a>            best_model,</span>
<span id="cb126-1581"><a href="#cb126-1581" aria-hidden="true" tabindex="-1"></a>            name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_final_model"</span>,</span>
<span id="cb126-1582"><a href="#cb126-1582" aria-hidden="true" tabindex="-1"></a>            input_example<span class="op">=</span>X_train.iloc[:<span class="dv">5</span>],</span>
<span id="cb126-1583"><a href="#cb126-1583" aria-hidden="true" tabindex="-1"></a>            registered_model_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_Best_Model"</span></span>
<span id="cb126-1584"><a href="#cb126-1584" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb126-1585"><a href="#cb126-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1586"><a href="#cb126-1586" aria-hidden="true" tabindex="-1"></a>        best_models[model_name] <span class="op">=</span> {</span>
<span id="cb126-1587"><a href="#cb126-1587" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rmse"</span>: final_rmse,</span>
<span id="cb126-1588"><a href="#cb126-1588" aria-hidden="true" tabindex="-1"></a>            <span class="st">"params"</span>: best_trial.params,</span>
<span id="cb126-1589"><a href="#cb126-1589" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mlflow_run_id"</span>: parent_run.info.run_id</span>
<span id="cb126-1590"><a href="#cb126-1590" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb126-1591"><a href="#cb126-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1592"><a href="#cb126-1592" aria-hidden="true" tabindex="-1"></a>        <span class="co"># === Inside your loop, after training best_model and evaluating ===</span></span>
<span id="cb126-1593"><a href="#cb126-1593" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save the retrained best model locally</span></span>
<span id="cb126-1594"><a href="#cb126-1594" aria-hidden="true" tabindex="-1"></a>        model_filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_best_model.pkl"</span></span>
<span id="cb126-1595"><a href="#cb126-1595" aria-hidden="true" tabindex="-1"></a>        joblib.dump(best_model, model_filename)</span>
<span id="cb126-1596"><a href="#cb126-1596" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> best model as </span><span class="sc">{</span>model_filename<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb126-1597"><a href="#cb126-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1598"><a href="#cb126-1598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1599"><a href="#cb126-1599" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Summary of best models:"</span>)</span>
<span id="cb126-1600"><a href="#cb126-1600" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(best_models)</span>
<span id="cb126-1601"><a href="#cb126-1601" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1602"><a href="#cb126-1602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1605"><a href="#cb126-1605" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb126-1606"><a href="#cb126-1606" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb126-1607"><a href="#cb126-1607" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shap</span>
<span id="cb126-1608"><a href="#cb126-1608" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb126-1609"><a href="#cb126-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1610"><a href="#cb126-1610" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_shap_analysis(model_name, run_id, X_train, preprocessor):</span>
<span id="cb126-1611"><a href="#cb126-1611" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb126-1612"><a href="#cb126-1612" aria-hidden="true" tabindex="-1"></a><span class="co">    Run SHAP analysis on a model stored in MLflow.</span></span>
<span id="cb126-1613"><a href="#cb126-1613" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb126-1614"><a href="#cb126-1614" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the trained model from MLflow</span></span>
<span id="cb126-1615"><a href="#cb126-1615" aria-hidden="true" tabindex="-1"></a>    model_uri <span class="op">=</span> <span class="ss">f"runs:/</span><span class="sc">{</span>run_id<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_final_model"</span></span>
<span id="cb126-1616"><a href="#cb126-1616" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> mlflow.sklearn.load_model(model_uri)</span>
<span id="cb126-1617"><a href="#cb126-1617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1618"><a href="#cb126-1618" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preprocess training data</span></span>
<span id="cb126-1619"><a href="#cb126-1619" aria-hidden="true" tabindex="-1"></a>    X_train_preprocessed <span class="op">=</span> preprocessor.transform(X_train)</span>
<span id="cb126-1620"><a href="#cb126-1620" aria-hidden="true" tabindex="-1"></a>    estimator <span class="op">=</span> model.named_steps[model_name.lower()]</span>
<span id="cb126-1621"><a href="#cb126-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1622"><a href="#cb126-1622" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute SHAP values</span></span>
<span id="cb126-1623"><a href="#cb126-1623" aria-hidden="true" tabindex="-1"></a>    explainer <span class="op">=</span> shap.Explainer(estimator, X_train_preprocessed)</span>
<span id="cb126-1624"><a href="#cb126-1624" aria-hidden="true" tabindex="-1"></a>    shap_values <span class="op">=</span> explainer(X_train_preprocessed)</span>
<span id="cb126-1625"><a href="#cb126-1625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1626"><a href="#cb126-1626" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Beeswarm plot</span></span>
<span id="cb126-1627"><a href="#cb126-1627" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb126-1628"><a href="#cb126-1628" aria-hidden="true" tabindex="-1"></a>    shap.plots.beeswarm(shap_values, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb126-1629"><a href="#cb126-1629" aria-hidden="true" tabindex="-1"></a>    beeswarm_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_shap_beeswarm.png"</span></span>
<span id="cb126-1630"><a href="#cb126-1630" aria-hidden="true" tabindex="-1"></a>    plt.savefig(beeswarm_file)</span>
<span id="cb126-1631"><a href="#cb126-1631" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb126-1632"><a href="#cb126-1632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1633"><a href="#cb126-1633" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary bar plot</span></span>
<span id="cb126-1634"><a href="#cb126-1634" aria-hidden="true" tabindex="-1"></a>    plt.figure()</span>
<span id="cb126-1635"><a href="#cb126-1635" aria-hidden="true" tabindex="-1"></a>    shap.plots.bar(shap_values, show<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb126-1636"><a href="#cb126-1636" aria-hidden="true" tabindex="-1"></a>    summary_file <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_shap_summary.png"</span></span>
<span id="cb126-1637"><a href="#cb126-1637" aria-hidden="true" tabindex="-1"></a>    plt.savefig(summary_file)</span>
<span id="cb126-1638"><a href="#cb126-1638" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb126-1639"><a href="#cb126-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1640"><a href="#cb126-1640" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"SHAP analysis completed for </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb126-1641"><a href="#cb126-1641" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> beeswarm_file, summary_file</span>
<span id="cb126-1642"><a href="#cb126-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1643"><a href="#cb126-1643" aria-hidden="true" tabindex="-1"></a><span class="co"># ===== Example: Run SHAP on the two models you manually select =====</span></span>
<span id="cb126-1644"><a href="#cb126-1644" aria-hidden="true" tabindex="-1"></a>selected_models <span class="op">=</span> [<span class="st">"SVR"</span>, <span class="st">"XGB"</span>]</span>
<span id="cb126-1645"><a href="#cb126-1645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1646"><a href="#cb126-1646" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name <span class="kw">in</span> selected_models:</span>
<span id="cb126-1647"><a href="#cb126-1647" aria-hidden="true" tabindex="-1"></a>    run_id <span class="op">=</span> best_models[model_name][<span class="st">"mlflow_run_id"</span>]</span>
<span id="cb126-1648"><a href="#cb126-1648" aria-hidden="true" tabindex="-1"></a>    run_shap_analysis(model_name, run_id, X_train, preprocessor)</span>
<span id="cb126-1649"><a href="#cb126-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-1650"><a href="#cb126-1650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb126-1651"><a href="#cb126-1651" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>